<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GameMaker</title>
    <link rel="stylesheet" href="css/gamemaker.css">
    <!-- QR Code Library for PWA Publishing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <!-- Asset Library Picker -->
    <!-- Asset library picker removed ‚Äî will be re-integrated when asset library is ported -->
</head>
<body>

<!-- TOP MENU BAR -->
<div id="top-menu-bar">
    <span class="app-title">üéÆ Game Maker <span class="help-icon" onclick="showHelp('about')" style="font-size: 12px; vertical-align: middle;">?</span></span>

    <div class="menu-divider"></div>

    <!-- File Menu -->
    <div class="dropdown">
        <button class="dropdown-toggle" onclick="toggleDropdown('file-menu')">File</button>
        <div class="dropdown-menu" id="file-menu">
            <button class="dropdown-item" onclick="saveProject(); closeAllDropdowns();">
                <span class="icon">üíæ</span> Save Project
                <span class="shortcut">Ctrl+S</span>
            </button>
            <button class="dropdown-item" onclick="shareProject(); closeAllDropdowns();">
                <span class="icon">üì§</span> Share
            </button>
            <button class="dropdown-item" onclick="reloadGame(); closeAllDropdowns();">
                <span class="icon">üîÑ</span> Reload Game
            </button>
            <div class="dropdown-separator"></div>
            <button class="dropdown-item" onclick="showExportModal(); closeAllDropdowns();">
                <span class="icon">üì¶</span> Export...
            </button>
        </div>
    </div>

    <!-- Edit Menu -->
    <div class="dropdown">
        <button class="dropdown-toggle" onclick="toggleDropdown('edit-menu')">Edit</button>
        <div class="dropdown-menu" id="edit-menu">
            <button class="dropdown-item" id="menu-undo" onclick="undo(); closeAllDropdowns();">
                <span class="icon">‚Ü©Ô∏è</span> Undo
                <span class="shortcut">Ctrl+Z</span>
            </button>
            <button class="dropdown-item" id="menu-redo" onclick="redo(); closeAllDropdowns();">
                <span class="icon">‚Ü™Ô∏è</span> Redo
                <span class="shortcut">Ctrl+Y</span>
            </button>
            <div class="dropdown-separator"></div>
            <button class="dropdown-item" onclick="fillRow(); closeAllDropdowns();">
                <span class="icon">‚¨áÔ∏è</span> Fill Bottom Row
            </button>
            <button class="dropdown-item" onclick="clearLevel(); closeAllDropdowns();">
                <span class="icon">üóëÔ∏è</span> Clear Level
            </button>
            <button class="dropdown-item" onclick="clearAllObjects(); closeAllDropdowns();">
                <span class="icon">‚úñÔ∏è</span> Clear All Objects
            </button>
        </div>
    </div>

    <!-- View Menu -->
    <div class="dropdown">
        <button class="dropdown-toggle" onclick="toggleDropdown('view-menu')">View</button>
        <div class="dropdown-menu" id="view-menu">
            <label class="dropdown-item checkbox">
                <input type="checkbox" id="menu-show-grid" checked onchange="document.getElementById('show-grid').checked = this.checked; draw();">
                Show Grid
            </label>
            <label class="dropdown-item checkbox">
                <input type="checkbox" id="menu-show-bg" checked onchange="document.getElementById('show-bg').checked = this.checked; draw();">
                Show Background
            </label>
            <label class="dropdown-item checkbox">
                <input type="checkbox" id="menu-show-objects" checked onchange="document.getElementById('show-objects').checked = this.checked; draw();">
                Show Objects
            </label>
            <div class="dropdown-separator"></div>
            <button class="dropdown-item" onclick="zoomIn(); closeAllDropdowns();">
                <span class="icon">üîç</span> Zoom In
                <span class="shortcut">+</span>
            </button>
            <button class="dropdown-item" onclick="zoomOut(); closeAllDropdowns();">
                <span class="icon">üîç</span> Zoom Out
                <span class="shortcut">-</span>
            </button>
            <button class="dropdown-item" onclick="zoom = 1; document.getElementById('zoom-display').textContent = '100%'; draw(); closeAllDropdowns();">
                <span class="icon">‚Ü∫</span> Reset Zoom (100%)
            </button>
        </div>
    </div>

    <!-- Game Menu -->
    <div class="dropdown">
        <button class="dropdown-toggle" onclick="toggleDropdown('game-menu')">Game</button>
        <div class="dropdown-menu" id="game-menu">
            <button class="dropdown-item" onclick="showPlayTestModal(); closeAllDropdowns();" style="color: #2ecc71;">
                <span class="icon">‚ñ∂Ô∏è</span> Play Test
                <span class="shortcut">Esc</span>
            </button>
            <div class="dropdown-separator"></div>
            <button class="dropdown-item" onclick="showGamePropertiesModal(); closeAllDropdowns();">
                <span class="icon">‚öôÔ∏è</span> Game Settings
            </button>
            <button class="dropdown-item" onclick="showPlayerPropertiesModal(); closeAllDropdowns();">
                <span class="icon">üéÆ</span> Player Properties
            </button>
            <div class="dropdown-separator"></div>
            <button class="dropdown-item" onclick="showLevelManagerModal(); closeAllDropdowns();">
                <span class="icon">üìö</span> Manage Levels
            </button>
        </div>
    </div>

    <!-- Help Menu -->
    <div class="dropdown">
        <button class="dropdown-toggle" onclick="toggleDropdown('help-menu')">Help</button>
        <div class="dropdown-menu" id="help-menu">
            <button class="dropdown-item" onclick="showHelp('tools'); closeAllDropdowns();">
                <span class="icon">‚úèÔ∏è</span> Drawing Tools
            </button>
            <button class="dropdown-item" onclick="showHelp('palette'); closeAllDropdowns();">
                <span class="icon">üé®</span> Tile Palette
            </button>
            <button class="dropdown-item" onclick="showHelp('gameObjects'); closeAllDropdowns();">
                <span class="icon">üëæ</span> Game Objects
            </button>
            <button class="dropdown-item" onclick="showHelp('physics'); closeAllDropdowns();">
                <span class="icon">‚öôÔ∏è</span> Physics Settings
            </button>
            <button class="dropdown-item" onclick="showHelp('levels'); closeAllDropdowns();">
                <span class="icon">üìö</span> Multi-Level Games
            </button>
        </div>
    </div>

    <div class="menu-divider"></div>

    <!-- Tools in menu bar -->
    <div class="menubar-tools">
        <button class="tool-btn active" id="tool-draw" onclick="setTool('draw')" title="Draw Tool (D)"><span class="icon">‚úèÔ∏è</span></button>
        <button class="tool-btn" id="tool-fill" onclick="setTool('fill')" title="Fill Tool (F)"><span class="icon">ü™£</span></button>
        <button class="tool-btn" id="tool-erase" onclick="setTool('erase')" title="Erase Tool (E)"><span class="icon">üßπ</span></button>
        <button class="tool-btn" id="tool-move" onclick="setTool('move')" title="Move Tool (M)"><span class="icon">üîÑ</span></button>
    </div>

    <!-- Right side items -->
    <div class="menubar-right">
        <button class="btn btn-icon" id="btn-undo" onclick="undo()" title="Undo (Ctrl+Z)" disabled>‚Ü©Ô∏è</button>
        <button class="btn btn-icon" id="btn-redo" onclick="redo()" title="Redo (Ctrl+Y)" disabled>‚Ü™Ô∏è</button>
        <div class="menu-divider"></div>
        <button class="btn btn-icon" onclick="zoomOut()" title="Zoom Out">-</button>
        <span id="zoom-display" style="font-family: monospace; font-size: 12px; color: #e94560; min-width: 45px; text-align: center;">125%</span>
        <button class="btn btn-icon" onclick="zoomIn()" title="Zoom In">+</button>
        <div class="menu-divider"></div>
        <span id="coordinates" style="font-family: monospace; font-size: 12px; color: #888;">X: 0, Y: 0</span>
        <div class="menu-divider"></div>
        <button class="btn btn-play" onclick="showPlayTestModal()" title="Play Test (Esc)">‚ñ∂ Play</button>
    </div>
</div>

<!-- Hidden checkboxes for view toggles (used by menu and keyboard shortcuts) -->
<input type="checkbox" id="show-grid" checked style="display: none;">
<input type="checkbox" id="show-bg" checked style="display: none;">
<input type="checkbox" id="show-objects" checked style="display: none;">

<div id="app">
    <!-- LEFT SIDEBAR -->
    <div id="sidebar">
        <div class="panel-resize-handle left-handle" id="left-panel-handle"></div>

        <!-- Tileset Drop Zone -->
        <div id="tileset-dropzone">
            <div class="icon">üñºÔ∏è</div>
            <div class="text">Drop tileset image here</div>
            <div class="subtext">or click to browse</div>
            <input type="file" id="tileset-input" accept="image/*" style="display: none;">
        </div>

        <!-- Tileset URL Input -->
        <div id="tileset-url-section">
            <div class="url-divider"><span>or load from URL</span></div>
            <div class="url-input-row">
                <input type="text" id="tileset-url-input" placeholder="https://example.com/tileset.png" onkeydown="if(event.key==='Enter')loadTilesetFromURLInput()">
                <button onclick="loadTilesetFromURLInput()">Load</button>
                <button type="button" class="browse-library-btn" onclick="openAssetPicker('tileset-url-input', 'tilesets')" title="Browse Tilesets">Browse</button>
            </div>
        </div>

        <!-- Tileset Preview (hidden until loaded) -->
        <div id="tileset-preview">
            <div id="tileset-preview-header">
                <h3>Tileset <span class="help-icon" onclick="showHelp('tileset')">?</span></h3>
                <div class="tileset-actions">
                    <button onclick="changeTileset()" title="Load a different tileset">Change</button>
                    <button onclick="refreshTileset()" title="Reload current tileset">‚Üª</button>
                    <button onclick="clearTileset()" title="Remove tileset and all tiles">Clear</button>
                </div>
            </div>
            <div id="tileset-info" style="font-size: 10px; color: #888; margin-bottom: 8px;"></div>
            <div id="tile-size-controls">
                <label>Size:</label>
                <select id="tile-size-select" onchange="updateTileSize()">
                    <option value="8">8x8</option>
                    <option value="16" selected>16x16</option>
                    <option value="32">32x32</option>
                    <option value="64">64x64</option>
                    <option value="custom">Custom</option>
                </select>
                <input type="number" id="tile-size-custom" value="16" min="4" max="128" style="display: none;" onchange="updateTileSize()">
            </div>
            <div id="tileset-canvas-container">
                <canvas id="tileset-canvas"></canvas>
            </div>
        </div>

        <!-- Selected Tile Info -->
        <div id="selected-tile-info">
            <h3>Selected Tile</h3>
            <div class="tile-info-row">
                <canvas id="selected-tile-preview" width="48" height="48"></canvas>
                <div class="tile-info-details">
                    <label>Key (for level array)</label>
                    <input type="text" id="tile-key-input" maxlength="1" placeholder="A" onchange="updateSelectedTileKey()">
                </div>
            </div>
            <div class="checkbox-row">
                <input type="checkbox" id="tile-solid-checkbox" onchange="updateSelectedTileSolid()">
                <label for="tile-solid-checkbox">Solid (player can stand on it)</label>
            </div>
        </div>

        <!-- Tiles Container (resizable sections) -->
        <div id="tiles-container">
            <!-- Tile Palette -->
            <div id="tile-palette">
                <h3>Tiles <span class="help-icon" onclick="showHelp('palette')">?</span></h3>
                <div class="tile-grid" id="tile-grid">
                    <div class="tile-item eraser selected" data-key="." onclick="selectTile('.')">
                        <span class="tile-key">.</span>
                    </div>
                </div>
            </div>

            <!-- Resize Handle -->
            <div class="tiles-resize-handle" id="tiles-resize-handle"></div>

            <!-- Custom Tiles Section -->
            <div id="custom-tiles-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <h3>Custom Tiles</h3>
                    <div style="display: flex; gap: 4px;">
                        <button onclick="openPixelEditor()" class="btn" style="padding: 4px 8px; font-size: 10px;">+ New</button>
                        <button onclick="browseAssetForPixelEditor()" class="btn browse-library-btn" style="padding: 4px 8px; font-size: 10px;" title="Browse Asset Library">Browse</button>
                    </div>
                </div>
                <div class="tile-grid" id="custom-tile-grid">
                    <!-- Custom tiles will be rendered here -->
                    <div id="custom-tiles-empty">
                        <div class="empty-icon">üé®</div>
                        <div class="empty-text">No custom tiles yet<br><span style="color: #666;">Click "+ New" to draw or "Browse" to edit an asset</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN AREA -->
    <div id="main">
        <div id="canvas-container">
            <canvas id="level-canvas"></canvas>
            <!-- Scrollbars for panning -->
            <div id="scrollbar-horizontal" class="editor-scrollbar horizontal">
                <div id="scrollbar-h-thumb" class="scrollbar-thumb"></div>
            </div>
            <div id="scrollbar-vertical" class="editor-scrollbar vertical">
                <div id="scrollbar-v-thumb" class="scrollbar-thumb"></div>
            </div>
            <div id="scrollbar-corner"></div>
        </div>

        <!-- CODE PREVIEW PANEL -->
        <div id="code-preview-panel" class="collapsed">
            <div class="code-panel-resize-handle" id="code-panel-handle"></div>
            <div class="code-panel-header" onclick="toggleCodePanel()">
                <span class="code-panel-title">
                    <span class="code-icon">&lt;/&gt;</span>
                    Code Preview
                </span>
                <div class="code-panel-actions">
                    <span class="collapse-icon">‚ñº</span>
                </div>
            </div>
            <div class="code-panel-content">
                <div class="code-context-header">
                    <span id="code-context-title">Click on settings or objects to see how they work in code</span>
                </div>
                <div class="code-display-area" onclick="showCodeEditPrompt()">
                    <pre><code id="code-snippet-display">// Welcome to Code Preview!
//
// As you build your game, this panel shows you the actual
// JavaScript code that makes your game work.
//
// Try these to see code:
//   ‚Ä¢ Open Game Settings (gravity, jump power)
//   ‚Ä¢ Open Player Properties (physics, appearance)
//   ‚Ä¢ Click on an object type (enemies, collectibles)
//
// This is how real game developers code!
// When you're ready to edit code yourself,
// use File ‚Üí Export to get your game's source.</code></pre>
                </div>
                <div class="code-panel-footer" id="code-edit-prompt" style="display: none;">
                    <span class="prompt-icon">üí°</span>
                    <span class="prompt-text">
                        This panel is for learning - try changing the settings above and watch the code update!
                        <br>
                        <span class="prompt-subtext">Ready to edit code directly? Use <strong>File ‚Üí Export</strong> to get your game's source code.</span>
                    </span>
                </div>
            </div>
        </div>

        <div id="statusbar">
            <span id="tool-hint">Left-click: Draw | Right-click: Erase | Scroll: Pan | Middle-drag: Pan</span>
            <span id="level-size-display">Level: 50 x 15</span>
        </div>
    </div>

    <!-- RIGHT SIDEBAR -->
    <div id="right-sidebar">
        <div class="panel-resize-handle right-handle" id="right-panel-handle"></div>
        <!-- LEVELS SECTION -->
        <div id="levels-section">
            <h2>Levels <span class="help-icon" onclick="showHelp('levels')">?</span></h2>
            <div class="level-indicator-bar" onclick="showLevelManagerModal()" title="Click to manage levels">
                <span id="current-level-indicator">Level 1 (1/1)</span>
                <span class="level-bar-hint">‚öôÔ∏è</span>
            </div>
            <div class="level-quick-actions">
                <button class="btn btn-small" onclick="addNewLevel()">+ New Level</button>
                <button class="btn btn-small" onclick="duplicateCurrentLevel()">‚ßâ Duplicate</button>
            </div>
        </div>

        <!-- Level width/height are now in the Level Settings modal -->
        <!-- Background layers are now in the Level Settings modal -->

        <!-- Game Settings Section -->
        <div id="game-settings-section">
            <div class="clickable-section" onclick="showGamePropertiesModal()">
                <h2>‚öôÔ∏è Game Settings <span class="help-icon" onclick="event.stopPropagation(); showHelp('gameRules')">?</span></h2>
                <p style="font-size: 10px; color: #555; margin-bottom: 8px;">Volume, rules & mobile controls</p>
                <div class="section-summary" style="display: flex; flex-wrap: wrap; gap: 8px; font-size: 10px; color: #888;">
                    <span>‚ù§Ô∏è Lives: <span id="summary-lives">3</span></span>
                    <span>üì± Mobile: <span id="summary-mobile">On</span></span>
                </div>
                <div class="section-summary" style="display: flex; flex-wrap: wrap; gap: 8px; font-size: 10px; color: #888; margin-top: 6px;">
                    <span>üîä Master: <span id="summary-master-vol">100%</span></span>
                    <span>üéµ Music: <span id="summary-music-vol">50%</span></span>
                    <span>üîî SFX: <span id="summary-sfx-vol">70%</span></span>
                </div>
                <div class="section-summary topdown-only" style="display: none; flex-wrap: wrap; gap: 8px; font-size: 10px; color: #888; margin-top: 6px;">
                    <span>üåê Online: <span id="summary-online">Off</span></span>
                </div>
            </div>
        </div>

        <!-- Player Properties Section -->
        <div id="player-settings-section">
            <div class="clickable-section" onclick="showPlayerPropertiesModal()">
                <h2>üéÆ Player Properties <span class="help-icon" onclick="event.stopPropagation(); showHelp('physics')">?</span></h2>
                <p style="font-size: 10px; color: #555; margin-bottom: 8px;">Physics, appearance, sounds & projectiles</p>
                <div class="section-summary" style="display: flex; flex-wrap: wrap; gap: 8px; font-size: 10px; color: #888;">
                    <span>‚öôÔ∏è Gravity: <span id="summary-gravity">0.5</span></span>
                    <span>ü¶ò Jump: <span id="summary-jump">10</span></span>
                    <span>üèÉ Speed: <span id="summary-speed">4</span></span>
                </div>
                <div class="section-summary" style="display: flex; flex-wrap: wrap; gap: 8px; font-size: 10px; color: #888; margin-top: 6px;">
                    <span>üìè Size: <span id="summary-player-size">32√ó32</span></span>
                    <span>üéØ Projectiles: <span id="summary-projectiles">Off</span></span>
                </div>
            </div>
        </div>

        <!-- Game Objects Section -->
        <div id="game-objects-section">
            <h2>Game Objects <span class="help-icon" onclick="showHelp('gameObjects')">?</span></h2>
            <p style="font-size: 10px; color: #555; margin-bottom: 10px;">Click a category to select and place objects.</p>

            <!-- Object Category Buttons -->
            <div class="object-category-grid">
                <div class="object-category" onclick="showObjectPlacementModal('enemy')">
                    <div class="object-btn" id="btn-enemy" style="background: linear-gradient(135deg, #e74c3c, #c0392b);">
                        <span class="obj-icon">üëæ</span>
                    </div>
                    <span class="obj-label">Enemies</span>
                </div>
                <div class="object-category" onclick="showObjectPlacementModal('collectible')">
                    <div class="object-btn" id="btn-collectible" style="background: linear-gradient(135deg, #f1c40f, #f39c12);">
                        <span class="obj-icon"><span style="display: inline-block; width: 18px; height: 18px; background: linear-gradient(135deg, #FFFACD, #FFE135); border-radius: 50%; border: 2px solid #8B4513; box-shadow: 0 0 0 1px rgba(0,0,0,0.3), inset -2px -2px 4px rgba(139,69,19,0.4), inset 2px 2px 4px rgba(255,255,255,0.6);"></span></span>
                    </div>
                    <span class="obj-label">Collectibles</span>
                </div>
                <div class="object-category" onclick="showObjectPlacementModal('hazard')">
                    <div class="object-btn" id="btn-hazard" style="background: linear-gradient(135deg, #7f8c8d, #636e72);">
                        <span class="obj-icon">‚ö†Ô∏è</span>
                    </div>
                    <span class="obj-label">Hazards</span>
                </div>
                <div class="object-category" onclick="showObjectPlacementModal('powerup')">
                    <div class="object-btn" id="btn-powerup" style="background: linear-gradient(135deg, #e91e63, #c2185b);">
                        <span class="obj-icon">‚ù§Ô∏è</span>
                    </div>
                    <span class="obj-label">Powerups</span>
                </div>
                <div class="object-category" onclick="selectGoalForPlacement()">
                    <div class="object-btn" id="btn-goal" style="background: linear-gradient(135deg, #2ecc71, #27ae60);">
                        <span class="obj-icon">üö©</span>
                    </div>
                    <span class="obj-label">Goal</span>
                </div>
                <div class="object-category" onclick="showObjectPlacementModal('spring')">
                    <div class="object-btn" id="btn-spring" style="background: linear-gradient(135deg, #9b59b6, #8e44ad);">
                        <span class="obj-icon">üîº</span>
                    </div>
                    <span class="obj-label">Springs</span>
                </div>
                <div class="object-category" onclick="showTerrainZoneTemplatesModal()">
                    <div class="object-btn" id="btn-terrainZone" style="background: linear-gradient(135deg, #4a90d9, #2c5f8a);">
                        <span class="obj-icon">üåä</span>
                    </div>
                    <span class="obj-label">Zones</span>
                </div>
                <div class="object-category platformer-only" onclick="showObjectPlacementModal('movingPlatform')">
                    <div class="object-btn" id="btn-movingPlatform" style="background: linear-gradient(135deg, #8B4513, #654321);">
                        <span class="obj-icon">‚ïê</span>
                    </div>
                    <span class="obj-label">Platforms</span>
                </div>
                <div class="object-category platformer-only" onclick="showObjectPlacementModal('mysteryBlock')">
                    <div class="object-btn" id="btn-mysteryBlock" style="background: linear-gradient(135deg, #f1c40f, #e67e22);">
                        <span class="obj-icon">?</span>
                    </div>
                    <span class="obj-label">Mystery</span>
                </div>
                <div class="object-category" onclick="selectCheckpointForPlacement()">
                    <div class="object-btn" id="btn-checkpoint" style="background: linear-gradient(135deg, #3498db, #2980b9);">
                        <span class="obj-icon">‚õ≥</span>
                    </div>
                    <span class="obj-label">Checkpoint</span>
                </div>
                <!-- Top-Down RPG Objects -->
                <div class="object-category topdown-only" onclick="showObjectPlacementModal('npc')" style="display: none;">
                    <div class="object-btn" id="btn-npc" style="background: linear-gradient(135deg, #3498db, #2c3e50);">
                        <span class="obj-icon">üë§</span>
                    </div>
                    <span class="obj-label">NPC</span>
                </div>
                <div class="object-category topdown-only" onclick="showObjectPlacementModal('door')" style="display: none;">
                    <div class="object-btn" id="btn-door" style="background: linear-gradient(135deg, #8b4513, #654321);">
                        <span class="obj-icon">üö™</span>
                    </div>
                    <span class="obj-label">Door</span>
                </div>
                <div class="object-category" onclick="clearObjectSelection()">
                    <div class="object-btn" style="background: linear-gradient(135deg, #444, #333);">
                        <span class="obj-icon">‚úñ</span>
                    </div>
                    <span class="obj-label">Deselect</span>
                </div>
            </div>

            <!-- Selection Status -->
            <div id="object-selection-status" style="margin-top: 12px; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px; display: none;">
                <div style="font-size: 11px; color: #888;">Selected:</div>
                <div id="selected-object-name" style="font-size: 13px; color: #e94560; font-weight: bold;"></div>
            </div>

            <div style="margin-top: 15px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span style="font-size: 11px; color: #888;">Objects Placed:</span>
                    <span id="object-count" style="font-size: 11px; color: #e94560;">0</span>
                </div>
                <button class="btn btn-full" onclick="clearAllObjects()" style="background: rgba(255,100,100,0.2); border-color: #f66; color: #f66;">Clear All Objects</button>
            </div>

        </div>
    </div>
</div>

<!-- Toast Notification -->
<div id="toast"></div>

<!-- Export Modal -->
<div class="modal-overlay" id="export-modal">
    <div class="modal" style="min-width: 600px;">
        <h2>Export Level Data</h2>

        <div class="export-tabs">
            <button class="export-tab active" onclick="setExportFormat('js')">JavaScript</button>
            <button class="export-tab" onclick="setExportFormat('json')">JSON</button>
            <button class="export-tab" onclick="setExportFormat('csv')">CSV/Grid</button>
            <button class="export-tab" onclick="setExportFormat('pencilcode')">Pencil.code</button>
            <button class="export-tab" onclick="setExportFormat('platformer')" style="background: linear-gradient(135deg, #e94560, #0f3460);">Platformer Game</button>
        </div>

        <div id="export-explanation" class="export-explanation">
            <h4>JavaScript Array Format</h4>
            <p>Each row of your level becomes a string in an array. Each character represents one tile:</p>
            <ul style="margin: 5px 0 0 20px; color: #aaa; font-size: 11px;">
                <li><code>.</code> = Empty space (no tile)</li>
                <li><code>A-Z</code> = Your defined tiles</li>
            </ul>
        </div>

        <!-- Platformer Export Options (only for Platformer export) -->
        <div id="platformer-options" style="display: none; margin: 10px 0;">
            <!-- Export Destination -->
            <div style="padding: 12px; background: linear-gradient(135deg, rgba(233, 69, 96, 0.1), rgba(15, 52, 96, 0.1)); border: 1px solid rgba(233, 69, 96, 0.3); border-radius: 6px; margin-bottom: 10px;">
                <div style="margin-bottom: 8px;"><strong style="color: #f99;">üéØ Export Destination</strong></div>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <label style="display: flex; align-items: center; cursor: pointer; gap: 8px; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 4px; border: 1px solid transparent;" class="export-option" onclick="selectExportOption('download')">
                        <input type="radio" name="export-destination" id="export-download" value="download" checked style="width: 16px; height: 16px;">
                        <div>
                            <span style="color: #fff;">üì• Download HTML File</span>
                            <p style="font-size: 10px; color: #888; margin: 2px 0 0 0;">Save to your computer as a standalone HTML file</p>
                        </div>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer; gap: 8px; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 4px; border: 1px solid transparent;" class="export-option" onclick="selectExportOption('mytekos')">
                        <input type="radio" name="export-destination" id="export-mytekos" value="mytekos" style="width: 16px; height: 16px;">
                        <div>
                            <span style="color: #fff;">‚òÅÔ∏è Save to mytekOS</span>
                            <p style="font-size: 10px; color: #888; margin: 2px 0 0 0;">Create a MrCodeEditor project you can edit and share</p>
                        </div>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer; gap: 8px; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 4px; border: 1px solid transparent;" class="export-option" onclick="selectExportOption('publish')">
                        <input type="radio" name="export-destination" id="export-publish" value="publish" style="width: 16px; height: 16px;">
                        <div>
                            <span style="color: #fff;">üì± Publish as Mobile App</span>
                            <p style="font-size: 10px; color: #888; margin: 2px 0 0 0;">Install on phone with QR code - works offline!</p>
                        </div>
                    </label>
                </div>
            </div>

            <!-- Learning Mode Toggle -->
            <div style="padding: 12px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1)); border: 1px solid rgba(102, 126, 234, 0.3); border-radius: 6px;">
                <label style="display: flex; align-items: center; cursor: pointer; gap: 10px;">
                    <input type="checkbox" id="learning-mode-checkbox" onchange="generateExportCode('platformer')" style="width: 18px; height: 18px; cursor: pointer;">
                    <div>
                        <strong style="color: #99f;">üìö Learning Mode</strong>
                        <p style="font-size: 11px; color: #888; margin: 4px 0 0 0;">Add extensive educational comments explaining how each part of the code works</p>
                    </div>
                </label>
            </div>

            <!-- Pixel Scale Option -->
            <div style="padding: 12px; background: linear-gradient(135deg, rgba(233, 69, 96, 0.1), rgba(15, 52, 96, 0.1)); border: 1px solid rgba(233, 69, 96, 0.3); border-radius: 6px; margin-top: 10px;">
                <div style="margin-bottom: 8px;">
                    <strong style="color: #f99;">üîç Pixel Scale (Mobile Visibility)</strong>
                    <p style="font-size: 11px; color: #888; margin: 4px 0 0 0;">Scale up pixel art for better visibility on mobile devices</p>
                </div>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <label style="flex: 1; min-width: 100px; display: flex; align-items: center; cursor: pointer; gap: 6px; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 4px; border: 2px solid #667eea;">
                        <input type="radio" name="pixel-scale" value="1" checked onchange="generateExportCode('platformer')" style="width: 16px; height: 16px;">
                        <div>
                            <span style="color: #fff; font-size: 12px;">1√ó Original</span>
                            <p style="font-size: 9px; color: #888; margin: 0;">Best for large sprites</p>
                        </div>
                    </label>
                    <label style="flex: 1; min-width: 100px; display: flex; align-items: center; cursor: pointer; gap: 6px; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 4px; border: 1px solid transparent;">
                        <input type="radio" name="pixel-scale" value="2" onchange="generateExportCode('platformer')" style="width: 16px; height: 16px;">
                        <div>
                            <span style="color: #fff; font-size: 12px;">2√ó Double</span>
                            <p style="font-size: 9px; color: #888; margin: 0;">Good balance</p>
                        </div>
                    </label>
                    <label style="flex: 1; min-width: 100px; display: flex; align-items: center; cursor: pointer; gap: 6px; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 4px; border: 1px solid transparent;">
                        <input type="radio" name="pixel-scale" value="3" onchange="generateExportCode('platformer')" style="width: 16px; height: 16px;">
                        <div>
                            <span style="color: #fff; font-size: 12px;">3√ó Triple</span>
                            <p style="font-size: 9px; color: #888; margin: 0;">Very visible</p>
                        </div>
                    </label>
                    <label style="flex: 1; min-width: 100px; display: flex; align-items: center; cursor: pointer; gap: 6px; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 4px; border: 1px solid transparent;">
                        <input type="radio" name="pixel-scale" value="4" onchange="generateExportCode('platformer')" style="width: 16px; height: 16px;">
                        <div>
                            <span style="color: #fff; font-size: 12px;">4√ó Quadruple</span>
                            <p style="font-size: 9px; color: #888; margin: 0;">Maximum size</p>
                        </div>
                    </label>
                </div>
            </div>

            <!-- Game Icon URL (for PWA publish) -->
            <div id="game-icon-url-section" style="display: none; margin-top: 10px; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 6px;">
                <label style="color: #aaa; font-size: 12px; display: block; margin-bottom: 6px;">
                    üé® Game Icon URL (optional):
                </label>
                <input type="text" id="game-icon-url" placeholder="https://example.com/my-game-icon.png" style="width: 100%; padding: 8px; background: #1a1a2e; border: 1px solid #444; border-radius: 4px; color: #fff; font-size: 14px;">
                <p style="font-size: 10px; color: #888; margin: 6px 0 0 0;">
                    üí° Provide a URL to a square image (PNG recommended, 512√ó512px ideal). This will be your app icon when installed on the home screen.
                </p>
            </div>

            <!-- Project Name (for mytekOS save) -->
            <div id="mytekos-project-name" style="display: none; margin-top: 10px; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 6px;">
                <label style="color: #aaa; font-size: 12px; display: block; margin-bottom: 6px;">Project Name:</label>
                <input type="text" id="game-project-name" placeholder="My Platformer Game" style="width: 100%; padding: 8px; background: #1a1a2e; border: 1px solid #444; border-radius: 4px; color: #fff; font-size: 14px;">
            </div>

            <!-- Published App Info (shown when already published) -->
            <div id="published-app-info" style="display: none; margin-top: 10px; padding: 15px; background: linear-gradient(135deg, rgba(17, 153, 142, 0.15), rgba(56, 239, 125, 0.15)); border: 1px solid rgba(17, 153, 142, 0.4); border-radius: 6px;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                    <span style="font-size: 20px;">üì±</span>
                    <div style="flex: 1;">
                        <div style="color: #11998e; font-weight: bold; font-size: 13px;">Already Published</div>
                        <div id="published-app-name" style="color: #ccc; font-size: 11px;"></div>
                    </div>
                </div>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <div id="export-qr-code" style="padding: 8px; background: white; border-radius: 4px;"></div>
                    <div style="flex: 1;">
                        <div style="display: flex; gap: 6px; margin-bottom: 8px;">
                            <input type="text" id="published-url" readonly style="flex: 1; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: #fff; padding: 6px; border-radius: 4px; font-size: 11px;">
                            <button class="btn" onclick="copyPublishedURL()" style="background: linear-gradient(135deg, #667eea, #764ba2); padding: 6px 12px; font-size: 11px;">Copy</button>
                        </div>
                        <button class="btn" onclick="window.open(document.getElementById('published-url').value, '_blank')" style="width: 100%; background: linear-gradient(135deg, #11998e, #38ef7d); padding: 6px; font-size: 11px;">Open Game</button>
                    </div>
                </div>
                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <p style="color: #888; font-size: 10px; margin: 0;">üí° Select "Publish as Mobile App" and re-publish to update the live version</p>
                </div>
            </div>
        </div>

        <textarea id="export-code" readonly></textarea>

        <div class="modal-buttons">
            <button class="btn" onclick="copyExportCode()">Copy to Clipboard</button>
            <button class="btn" id="export-action-btn" onclick="executeExport()">Download File</button>
            <button class="btn" onclick="closeExportModal()">Close</button>
        </div>
    </div>
</div>

<!-- Publish Success Modal -->
<div class="modal-overlay" id="publish-success-modal">
    <div class="modal" style="max-width: 500px;">
        <h2 style="color: #11998e; margin-bottom: 20px;">üéâ Game Published!</h2>

        <div style="text-align: center; margin-bottom: 20px;">
            <p style="color: #ccc; margin-bottom: 15px;">Your game is now live and installable!</p>
            <div id="publish-app-name" style="font-size: 18px; font-weight: bold; color: #fff; margin-bottom: 20px;"></div>
        </div>

        <!-- QR Code Container -->
        <div style="text-align: center; margin-bottom: 20px;">
            <div id="publish-qr-code" style="display: inline-block; padding: 15px; background: white; border-radius: 8px;"></div>
            <p style="color: #888; font-size: 11px; margin-top: 10px;">Scan with your phone to install</p>
        </div>

        <!-- URL Display -->
        <div style="margin-bottom: 20px;">
            <label style="color: #ccc; font-size: 12px; display: block; margin-bottom: 5px;">Shareable URL:</label>
            <div style="display: flex; gap: 8px;">
                <input type="text" id="publish-url" readonly style="flex: 1; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: #fff; padding: 8px; border-radius: 4px; font-size: 12px;">
                <button class="btn" onclick="copyPublishURL()" style="background: linear-gradient(135deg, #667eea, #764ba2); padding: 8px 16px;">Copy</button>
            </div>
        </div>

        <!-- Instructions -->
        <div style="background: rgba(17, 153, 142, 0.1); border: 1px solid rgba(17, 153, 142, 0.3); border-radius: 6px; padding: 12px; margin-bottom: 20px;">
            <p style="color: #11998e; font-weight: bold; margin-bottom: 8px; font-size: 12px;">üì± How to Install on Your Phone:</p>
            <ul style="color: #ccc; font-size: 11px; margin: 0; padding-left: 20px;">
                <li><strong>iOS:</strong> Open URL ‚Üí Tap Share ‚Üí "Add to Home Screen"</li>
                <li><strong>Android:</strong> Open URL ‚Üí Tap menu ‚Üí "Install app"</li>
            </ul>
        </div>

        <div class="modal-buttons">
            <button class="btn" onclick="window.open(document.getElementById('publish-url').value, '_blank')" style="background: linear-gradient(135deg, #11998e, #38ef7d);">Open Game</button>
            <button class="btn" onclick="closePublishSuccessModal()">Close</button>
        </div>
    </div>
</div>

<!-- Help Modal -->
<div class="modal-overlay" id="help-modal" onclick="if(event.target === this) closeHelpModal()">
    <div class="modal">
        <h2 id="help-modal-title">Help</h2>
        <div class="help-content" id="help-modal-content">
            <!-- Content injected by JavaScript -->
        </div>
        <div class="modal-buttons">
            <button class="btn" onclick="closeHelpModal()">Got it!</button>
        </div>
    </div>
</div>

<!-- Learn Mode Modal -->
<div class="modal-overlay" id="learn-modal">
    <div class="modal">
        <h2>Understanding Level Data</h2>

        <div id="learn-content">
            <!-- Page 1: Introduction -->
            <div class="learn-page" data-page="1">
                <div class="learn-section">
                    <h3>What is Level Data?</h3>
                    <p>
                        When you create a game level, the computer needs to store where every tile is placed.
                        Instead of saving images, we save a <strong>text representation</strong> - a simple code that
                        describes what tile goes where.
                    </p>
                    <div class="learn-tip">
                        <strong>Why text?</strong> Text files are tiny compared to images, easy to edit,
                        and work in any programming language!
                    </div>
                </div>

                <div class="learn-section">
                    <h3>The Grid Concept</h3>
                    <p>Your level is a grid of tiles. Each cell in the grid holds one tile (or is empty).</p>
                    <div class="learn-interactive">
                        <div class="learn-interactive-canvas">
                            <canvas id="learn-grid-demo" width="240" height="240"></canvas>
                            <p style="font-size: 10px; color: #666; margin-top: 5px;">Click cells to toggle tiles</p>
                        </div>
                        <div class="learn-interactive-output" id="learn-grid-output">
                            <span class="comment">// Your level as data:</span><br>
                            const level = [<br>
                            &nbsp;&nbsp;"......",<br>
                            &nbsp;&nbsp;"......",<br>
                            &nbsp;&nbsp;"......",<br>
                            &nbsp;&nbsp;"......",<br>
                            &nbsp;&nbsp;"......",<br>
                            &nbsp;&nbsp;"......",<br>
                            ];
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page 2: Character Mapping -->
            <div class="learn-page" data-page="2" style="display: none;">
                <div class="learn-section">
                    <h3>Each Letter = One Tile Type</h3>
                    <p>
                        Think of it like a secret code! Each letter in your level represents a different
                        type of tile. A dot (<code>.</code>) means empty space, and other letters like
                        <code>G</code> or <code>B</code> represent your tiles.
                    </p>
                    <div class="learn-code-block">
<span class="comment">// Define what each letter means</span>
<span class="keyword">const</span> tileTypes = {
    <span class="string">'.'</span>: <span class="keyword">null</span>,           <span class="comment">// Empty space (no tile)</span>
    <span class="string">'G'</span>: { <span class="property">solid</span>: <span class="keyword">true</span> },  <span class="comment">// Ground - player can walk on it</span>
    <span class="string">'B'</span>: { <span class="property">solid</span>: <span class="keyword">true</span> },  <span class="comment">// Brick - player can walk on it</span>
    <span class="string">'W'</span>: { <span class="property">solid</span>: <span class="keyword">false</span> }, <span class="comment">// Water - player falls through</span>
};
                    </div>
                    <div class="learn-tip">
                        <strong>Solid = true</strong> means the player can stand on it (like ground or platforms).<br>
                        <strong>Solid = false</strong> means the player passes through it (like water or clouds).
                    </div>
                </div>

                <div class="learn-section">
                    <h3>How the Level Array Works</h3>
                    <p>Your level is stored as an array of strings. Each string is one row, read left to right, top to bottom:</p>
                    <div class="learn-code-block">
<span class="comment">// A simple 5x3 level</span>
<span class="keyword">const</span> level = [
    <span class="string">"....."</span>,   <span class="comment">// Row 0: all empty (top row)</span>
    <span class="string">"..B.."</span>,   <span class="comment">// Row 1: brick platform in middle</span>
    <span class="string">"GGGGG"</span>,   <span class="comment">// Row 2: solid ground (bottom row)</span>
];

<span class="comment">// Access any tile with: level[row][column]</span>
<span class="keyword">const</span> tile = level[<span class="number">1</span>][<span class="number">2</span>];   <span class="comment">// Row 1, Column 2 = 'B'</span>
                    </div>
                </div>
            </div>

            <!-- Page 3: Tileset Coordinates -->
            <div class="learn-page" data-page="3" style="display: none;">
                <div class="learn-section">
                    <h3>How Tileset Mapping Works</h3>
                    <p>
                        Each tile in your tileset has a position (row & column). We assign a letter to each
                        tile position, then use that letter in our level data.
                    </p>

                    <!-- Visual Diagram -->
                    <div class="tileset-diagram">
                        <div class="tileset-grid-container">
                            <div class="tileset-grid-label">Your Tileset Image</div>
                            <div class="tileset-grid">
                                <!-- Header row with column numbers -->
                                <div class="header"></div>
                                <div class="header">col 0</div>
                                <div class="header">col 1</div>
                                <div class="header">col 2</div>
                                <div class="header">col 3</div>

                                <!-- Row 0 -->
                                <div class="row-label">row 0</div>
                                <div class="cell"></div>
                                <div class="cell"></div>
                                <div class="cell highlight-g">
                                    <span class="letter-badge">G</span>
                                </div>
                                <div class="cell"></div>

                                <!-- Row 1 -->
                                <div class="row-label">row 1</div>
                                <div class="cell highlight-b">
                                    <span class="letter-badge">B</span>
                                </div>
                                <div class="cell"></div>
                                <div class="cell"></div>
                                <div class="cell"></div>
                            </div>
                        </div>

                        <div class="mapping-arrow">
                            ‚Üí
                            <span>becomes</span>
                        </div>

                        <div class="mapping-result">
                            <div class="mapping-item">
                                <div class="tile-preview grass">G</div>
                                <div class="mapping-text">
                                    <code>'G'</code> = row <strong>0</strong>, col <strong>2</strong>
                                </div>
                            </div>
                            <div class="mapping-item">
                                <div class="tile-preview brick">B</div>
                                <div class="mapping-text">
                                    <code>'B'</code> = row <strong>1</strong>, col <strong>0</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="learn-section">
                    <h3>The Code That Makes It Work</h3>
                    <p>Store each letter's tileset position in an object:</p>
                    <div class="learn-code-block">
<span class="keyword">const</span> tileTypes = {
    <span class="string">'G'</span>: { <span class="property">row</span>: <span class="number">0</span>, <span class="property">col</span>: <span class="number">2</span>, <span class="property">solid</span>: <span class="keyword">true</span> },  <span class="comment">// Green tile at row 0, col 2</span>
    <span class="string">'B'</span>: { <span class="property">row</span>: <span class="number">1</span>, <span class="property">col</span>: <span class="number">0</span>, <span class="property">solid</span>: <span class="keyword">true</span> },  <span class="comment">// Brick tile at row 1, col 0</span>
};

<span class="comment">// When drawing, convert row/col to pixels:</span>
<span class="keyword">const</span> pixelX = tile.col * <span class="number">16</span>;  <span class="comment">// col 2 √ó 16 = 32px from left</span>
<span class="keyword">const</span> pixelY = tile.row * <span class="number">16</span>;  <span class="comment">// row 0 √ó 16 = 0px from top</span>
                    </div>
                    <div class="learn-tip">
                        <strong>That's it!</strong> When you see <code>G</code> in your level, the game looks up
                        row 0, col 2 in the tileset and draws that 16√ó16 pixel square.
                    </div>
                </div>
            </div>

            <!-- Page 4: Using in Your Game -->
            <div class="learn-page" data-page="4" style="display: none;">
                <div class="learn-section">
                    <h3>Drawing Your Level</h3>
                    <p>Loop through every row and column, then draw each tile at the right spot:</p>
                    <div class="learn-code-block">
<span class="keyword">function</span> <span class="property">drawLevel</span>() {
    <span class="comment">// Loop through each row (y)</span>
    <span class="keyword">for</span> (<span class="keyword">let</span> y = <span class="number">0</span>; y &lt; level.length; y++) {

        <span class="comment">// Loop through each column (x) in this row</span>
        <span class="keyword">for</span> (<span class="keyword">let</span> x = <span class="number">0</span>; x &lt; level[y].length; x++) {

            <span class="keyword">const</span> char = level[y][x];     <span class="comment">// Get the letter</span>
            <span class="keyword">const</span> tile = tileTypes[char]; <span class="comment">// Look up tile info</span>

            <span class="keyword">if</span> (tile) {
                <span class="comment">// Draw this tile on the canvas</span>
                ctx.drawImage(
                    tileset,                        <span class="comment">// Source image</span>
                    tile.col * <span class="number">16</span>, tile.row * <span class="number">16</span>,  <span class="comment">// Where in tileset</span>
                    <span class="number">16</span>, <span class="number">16</span>,                        <span class="comment">// Tile size</span>
                    x * <span class="number">16</span>, y * <span class="number">16</span>,                <span class="comment">// Where on screen</span>
                    <span class="number">16</span>, <span class="number">16</span>                         <span class="comment">// Draw size</span>
                );
            }
        }
    }
}
                    </div>
                </div>

                <div class="learn-section">
                    <h3>Collision Detection</h3>
                    <p>Check if a position hits a solid tile before moving the player there:</p>
                    <div class="learn-code-block">
<span class="keyword">function</span> <span class="property">isSolid</span>(pixelX, pixelY) {
    <span class="comment">// Convert pixel position to tile position</span>
    <span class="keyword">const</span> tileX = Math.floor(pixelX / <span class="number">16</span>);
    <span class="keyword">const</span> tileY = Math.floor(pixelY / <span class="number">16</span>);

    <span class="comment">// Get the character at this tile</span>
    <span class="keyword">const</span> char = level[tileY][tileX];

    <span class="comment">// Return true if this tile is solid</span>
    <span class="keyword">return</span> tileTypes[char]?.solid === <span class="keyword">true</span>;
}

<span class="comment">// Example: Only move if destination isn't solid</span>
<span class="keyword">if</span> (!isSolid(player.x + speed, player.y)) {
    player.x += speed;  <span class="comment">// Safe to move!</span>
}
                    </div>
                </div>
            </div>
        </div>

        <div class="learn-nav">
            <button class="btn" id="learn-prev" onclick="learnPrev()" disabled>‚Üê Previous</button>
            <div class="learn-nav-dots">
                <span class="learn-nav-dot active" onclick="learnGoTo(1)"></span>
                <span class="learn-nav-dot" onclick="learnGoTo(2)"></span>
                <span class="learn-nav-dot" onclick="learnGoTo(3)"></span>
                <span class="learn-nav-dot" onclick="learnGoTo(4)"></span>
            </div>
            <button class="btn" id="learn-next" onclick="learnNext()">Next ‚Üí</button>
        </div>

        <div class="modal-buttons" style="margin-top: 15px;">
            <button class="btn" onclick="closeLearnModal()">Close</button>
        </div>
    </div>
</div>

<!-- Cheat Code Editor Modal -->
<div class="modal-overlay template-modal" id="cheat-editor-modal" onclick="if(event.target === this) closeCheatEditorModal()">
    <div class="modal template-editor-modal" style="max-width: 400px;">
        <div class="modal-header">
            <h2 id="cheat-editor-title">Add Cheat Code</h2>
            <button class="modal-close-btn" onclick="closeCheatEditorModal()">&times;</button>
        </div>
        <div class="modal-body" style="padding: 15px;">
            <div class="form-group">
                <label>Cheat Name</label>
                <input type="text" id="cheat-editor-name" placeholder="e.g., Super Power" maxlength="30" style="width: 100%;">
            </div>

            <div class="form-group">
                <label>Code to Type</label>
                <input type="text" id="cheat-editor-code" placeholder="e.g., IDDQD or UP,UP,DOWN,DOWN" style="width: 100%; text-transform: uppercase;">
                <small style="color: #888; font-size: 9px; display: block; margin-top: 4px;">
                    Use letters (IDDQD), or arrows: UP, DOWN, LEFT, RIGHT, A, B
                </small>
            </div>

            <div class="form-group">
                <label>Effect</label>
                <select id="cheat-editor-effect" onchange="updateCheatDurationVisibility()" style="width: 100%;">
                    <option value="invincibility">üõ°Ô∏è Invincibility</option>
                    <option value="infiniteLives">‚ù§Ô∏è Infinite Lives (99)</option>
                    <option value="speedBoost">‚ö° Speed Boost (2x)</option>
                    <option value="jumpBoost">ü¶ò Super Jump (1.5x)</option>
                    <option value="lowGravity">üåô Low Gravity (Moon)</option>
                    <option value="oneHitKill">üí• One-Hit Kill</option>
                    <option value="maxAmmo">üî´ Max Ammo</option>
                    <option value="levelSkip">‚è≠Ô∏è Skip Level</option>
                    <option value="scoreBoost" selected>üí∞ Score +1000</option>
                    <option value="tinyMode">üêú Tiny Mode (0.5x)</option>
                    <option value="giantMode">ü¶ñ Giant Mode (1.5x)</option>
                    <option value="turboFire">üî• Turbo Fire (3x)</option>
                </select>
            </div>

            <div class="form-group" id="cheat-duration-group">
                <label>Duration: <span id="cheat-editor-duration-display">30s</span></label>
                <input type="range" id="cheat-editor-duration" min="5" max="120" step="5" value="30" style="width: 100%;" oninput="updateCheatDurationDisplay(this.value)">
                <small style="color: #888; font-size: 9px;">(Instant effects like Level Skip ignore duration)</small>
            </div>

            <div class="form-group" style="margin-top: 15px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="cheat-editor-enabled" checked style="width: 14px; height: 14px;">
                    <span>Enable this cheat</span>
                </label>
            </div>
        </div>
        <div class="modal-footer" style="padding: 12px 15px; border-top: 1px solid rgba(255,255,255,0.1); display: flex; gap: 10px; justify-content: flex-end;">
            <button class="btn" onclick="closeCheatEditorModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveCheatCode()">Save Cheat</button>
        </div>
    </div>
</div>

<!-- Play Test Modal -->
<div class="modal-overlay" id="playtest-modal">
    <div class="modal">
        <div class="playtest-header">
            <h2>‚ñ∂ Testing Your Game</h2>
            <div class="game-controls-compact" id="game-controls-display">
                <span class="key-badge">‚Üê‚Üí</span><span class="key-badge">AD</span> Move
                <span class="control-sep">|</span>
                <span class="key-badge">‚Üë</span><span class="key-badge">W</span><span class="key-badge">Space</span> Jump
                <span id="shoot-controls-placeholder"></span>
                <span class="control-sep">|</span>
                <span class="key-badge">R</span> Restart
            </div>
            <div class="game-actions">
                <button class="btn" onclick="restartGame()">üîÑ</button>
                <button class="btn btn-export-game" onclick="exportFullGame()">üì¶ Export</button>
                <button class="btn" onclick="openGameInNewTab()" title="Debug: Open in new tab">üîç New Tab</button>
                <button class="btn" onclick="closePlayTestModal()">‚úï</button>
            </div>
        </div>

        <div class="playtest-content">
            <div id="game-preview-container" onclick="document.getElementById('game-preview-frame').focus()">
                <iframe id="game-preview-frame" tabindex="0"></iframe>
            </div>

            <div class="game-status">
                <span id="game-status-text">Loading game...</span>
            </div>
        </div>
    </div>
</div>

<!-- Expanded Data Preview Modal -->
<div class="modal-overlay" id="data-expand-modal" onclick="if(event.target === this) closeDataExpandModal()">
    <div class="modal">
        <div class="expanded-data-header">
            <h2>Level Data Preview</h2>
            <div class="data-format-tabs">
                <button class="data-format-tab active" onclick="setExpandedDataFormat('array')">Array</button>
                <button class="data-format-tab" onclick="setExpandedDataFormat('json')">JSON</button>
                <button class="data-format-tab" onclick="setExpandedDataFormat('tiles')">Tiles</button>
            </div>
        </div>
        <div id="expanded-data-display">
            <span class="comment">// Loading...</span>
        </div>
        <div class="modal-buttons">
            <button class="btn" onclick="copyExpandedData()">Copy to Clipboard</button>
            <button class="btn" onclick="closeDataExpandModal()">Close</button>
        </div>
    </div>
</div>

<!-- Object Placement Modal -->
<div class="modal-overlay placement-modal" id="object-placement-modal" onclick="if(event.target === this) closeObjectPlacementModal()">
    <div class="modal">
        <h2 id="object-placement-title">Select Object</h2>
        <div class="placement-grid" id="object-placement-list">
            <!-- Populated by JavaScript -->
        </div>
        <div class="modal-buttons">
            <button class="btn" onclick="closeObjectPlacementModal()">Cancel</button>
        </div>
    </div>
</div>

<!-- Enemy Templates Modal -->
<div class="modal-overlay template-modal" id="enemy-templates-modal" onclick="if(event.target === this) closeEnemyTemplatesModal()">
    <div class="modal">
        <h2>Enemy Types</h2>
        <p style="color: #888; font-size: 12px; margin-bottom: 10px;">Customize enemy behaviors and appearance</p>
        <div class="template-list" id="enemy-templates-list">
            <!-- Populated by JavaScript -->
        </div>
        <div class="modal-buttons">
            <button class="btn" style="background: linear-gradient(135deg, #667eea, #764ba2);" onclick="showAddEnemyTemplate()">+ Add Enemy Type</button>
            <button class="btn" onclick="closeEnemyTemplatesModal()">Close</button>
        </div>
    </div>
</div>

<!-- Enemy Template Editor -->
<div class="template-editor" id="enemy-template-editor">
    <div class="template-editor-content wide">
        <h3 id="enemy-template-title">Add Enemy Type <span class="help-icon" onclick="showHelp('enemyBehaviors')">?</span></h3>

        <div class="editor-columns">
            <!-- Left Column: Appearance -->
            <div class="editor-column">
                <div class="editor-section-header">üì¶ Appearance</div>

                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="enemy-template-name" placeholder="e.g., Goomba">
                </div>

                <div class="form-group">
                    <label>Tile (from tileset)</label>
                    <select id="enemy-template-tile" onchange="updateObjectTilePreview('enemy-template-tile', 'enemy-tile-preview')">
                        <option value="">-- None (use sprite/color) --</option>
                    </select>
                    <div id="enemy-tile-preview" style="margin-top:4px;height:24px;display:flex;align-items:center;gap:5px;">
                        <span style="color:#666;font-size:10px;">Select a tile to use as sprite</span>
                    </div>
                </div>

                <div class="form-group">
                    <label>Sprite URL (overrides tile)</label>
                    <div class="input-with-browse">
                        <input type="text" id="enemy-template-sprite" placeholder="https://...">
                        <button type="button" class="browse-library-btn" onclick="openAssetPicker('enemy-template-sprite')">Browse</button>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Cols</label>
                        <input type="number" id="enemy-template-cols" value="1" min="1" max="32" title="Frames per row">
                    </div>
                    <div class="form-group">
                        <label>Rows</label>
                        <input type="number" id="enemy-template-rows" value="1" min="1" max="16" title="Number of rows (4 for directional: down/left/right/up)">
                    </div>
                    <div class="form-group">
                        <label>Anim Speed</label>
                        <input type="number" id="enemy-template-animspeed" value="8" min="1" max="30" title="Animation speed: 1 = fastest, 30 = slowest">
                    </div>
                </div>
                <small style="color: #666; font-size: 9px; margin-top: -8px; display: block;">Animation: 1=fastest ‚Üí 30=slowest</small>

                <div class="form-row" style="margin-top: 12px;">
                    <div class="form-group">
                        <label>Width (px)</label>
                        <input type="number" id="enemy-template-width" value="32" min="8" max="128">
                    </div>
                    <div class="form-group">
                        <label>Height (px)</label>
                        <input type="number" id="enemy-template-height" value="32" min="8" max="128">
                    </div>
                    <div class="form-group" style="flex: 0.5;">
                        <label>Color</label>
                        <input type="color" id="enemy-template-color" value="#ff4444">
                    </div>
                </div>
                <small style="color: #666; font-size: 9px; margin-top: -8px; display: block;">Color is used as fallback when no sprite is set</small>
            </div>

            <!-- Right Column: Behavior & Combat -->
            <div class="editor-column">
                <div class="editor-section-header">üéÆ Behavior</div>

                <div class="form-group">
                    <label>Movement Pattern</label>
                    <select id="enemy-template-behavior" onchange="updateEnemyBehaviorOptions()">
                        <option value="pace">Pace (walk back and forth)</option>
                        <option value="stationary">Stationary (stays still)</option>
                        <option value="follow">Follow (chases player)</option>
                        <option value="jump" id="enemy-behavior-jump-option" class="platformer-only">Jump (bouncing movement)</option>
                    </select>
                </div>

                <div class="behavior-options" id="enemy-pace-options">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Pace Distance (tiles)</label>
                            <input type="number" id="enemy-template-pace-distance" value="3" min="1" max="20">
                        </div>
                        <div class="form-group topdown-only" style="display: none;">
                            <label>Pace Axis</label>
                            <select id="enemy-template-pace-axis">
                                <option value="horizontal">Horizontal</option>
                                <option value="vertical">Vertical</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="behavior-options" id="enemy-follow-options" style="display: none;">
                    <div class="form-group">
                        <label>Follow Range (tiles)</label>
                        <input type="number" id="enemy-template-follow-range" value="5" min="1" max="20">
                    </div>
                </div>
                <div class="behavior-options platformer-only" id="enemy-jump-options" style="display: none;">
                    <div class="form-group">
                        <label>Jump Power</label>
                        <input type="number" id="enemy-template-jump-power" value="8" min="1" max="20">
                    </div>
                </div>

                <div class="editor-section-header">‚öîÔ∏è Combat</div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Move Speed</label>
                        <input type="number" id="enemy-template-speed" value="2" min="0.5" max="10" step="0.5">
                    </div>
                    <div class="form-group">
                        <label>Damage</label>
                        <input type="number" id="enemy-template-damage" value="1" min="1" max="10">
                    </div>
                    <div class="form-group">
                        <label>Respawn (sec)</label>
                        <input type="number" id="enemy-template-respawn-time" value="0" min="0" max="300" step="1" title="Seconds until enemy respawns after defeat (0 = no respawn)">
                    </div>
                </div>
                <small style="color: #666; font-size: 9px; margin-top: -8px; display: block;">Respawn: 0 = doesn't respawn after defeat</small>

                <div class="form-group platformer-only" style="margin-top: 12px; padding: 8px; background: rgba(102, 126, 234, 0.1); border-radius: 6px; border: 1px solid rgba(102, 126, 234, 0.2);">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin-bottom: 0;">
                        <input type="checkbox" id="enemy-template-stompable" style="width: 16px; height: 16px;" onchange="toggleStompOptions()">
                        <span>ü¶∂ Stompable (defeat by jumping on top)</span>
                    </label>
                    <div id="stomp-options" class="platformer-only" style="display: none; margin-top: 8px;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Stomp Score</label>
                            <input type="number" id="enemy-template-stomp-score" value="50" min="0" max="1000" title="Points awarded when player stomps this enemy">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Full Width: Audio & Effects -->
        <div class="editor-full-width" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
            <div class="editor-section-header" style="margin-top: 0;">üîä Audio & Effects</div>

            <div class="form-row">
                <div class="form-group" style="flex: 1;">
                    <label>Contact Sound</label>
                    <div class="input-with-browse" style="display: flex; gap: 4px; flex-wrap: wrap;">
                        <input type="text" id="enemy-template-contact-sound" placeholder="URL or sfx:id" style="flex: 1; min-width: 100px;" onchange="updateSoundButtonStates('enemy-template-contact-sound')">
                        <button type="button" class="browse-library-btn" onclick="openAssetPicker('enemy-template-contact-sound', 'sounds')">Browse</button>
                        <button type="button" class="browse-library-btn sfx-create-btn" onclick="openSoundEffectStudio('enemy-template-contact-sound', 'Enemy Contact Sound')" style="background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);">üéµ Create</button>
                        <button type="button" class="browse-library-btn sfx-edit-btn" onclick="editSoundEffectStudio('enemy-template-contact-sound')" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); display: none;">‚úèÔ∏è Edit</button>
                        <button type="button" class="browse-library-btn sfx-preview-btn" onclick="testSoundFromInput('enemy-template-contact-sound')" style="background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); display: none;">‚ñ∂</button>
                        <button type="button" class="browse-library-btn sfx-unlink-btn" onclick="unlinkSoundEffectStudio('enemy-template-contact-sound')" style="background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%); display: none;">‚úï</button>
                    </div>
                </div>
            </div>

            <div class="form-group" style="margin-top: 10px;">
                <label>üí• Death Particle Effect</label>
                <div class="input-with-browse" style="display: flex; gap: 4px; flex-wrap: wrap;">
                    <input type="text" id="enemy-template-death-particle" placeholder="pfx:id" style="flex: 1; min-width: 100px;"
                        title="Particle effect when this enemy type is defeated">
                    <button type="button" class="browse-library-btn pfx-create-btn" onclick="openParticleFXStudio('enemy-template-death-particle', 'Enemy Death Effect', 'explosion')" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);">‚ú® Create</button>
                    <button type="button" class="browse-library-btn pfx-edit-btn" onclick="editParticleFXStudio('enemy-template-death-particle')" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); display: none;">‚úèÔ∏è Edit</button>
                    <button type="button" class="browse-library-btn pfx-unlink-btn" onclick="unlinkParticleFXStudio('enemy-template-death-particle')" style="background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%); display: none;">‚úï</button>
                </div>
            </div>
        </div>

        <div class="modal-buttons">
            <button class="btn" onclick="saveEnemyTemplate()">Save</button>
            <button class="btn" onclick="closeEnemyTemplateEditor()">Cancel</button>
        </div>
    </div>
</div>

<!-- Collectible Templates Modal -->
<div class="modal-overlay template-modal" id="collectible-templates-modal" onclick="if(event.target === this) closeCollectibleTemplatesModal()">
    <div class="modal">
        <h2>Collectible Types</h2>
        <p style="color: #888; font-size: 12px; margin-bottom: 10px;">Define items players can collect for points</p>
        <div class="template-list" id="collectible-templates-list">
            <!-- Populated by JavaScript -->
        </div>
        <div class="modal-buttons">
            <button class="btn" style="background: linear-gradient(135deg, #f1c40f, #f39c12);" onclick="showAddCollectibleTemplate()">+ Add Collectible</button>
            <button class="btn" onclick="closeCollectibleTemplatesModal()">Close</button>
        </div>
    </div>
</div>

<!-- Collectible Template Editor -->
<div class="template-editor" id="collectible-template-editor">
    <div class="template-editor-content">
        <h3 id="collectible-template-title">Add Collectible Type <span class="help-icon" onclick="showHelp('objectTemplates')">?</span></h3>
        <div class="form-group">
            <label>Name</label>
            <input type="text" id="collectible-template-name" placeholder="e.g., Star">
        </div>
        <div class="form-group">
            <label>Tile (from tileset)</label>
            <select id="collectible-template-tile" onchange="updateObjectTilePreview('collectible-template-tile', 'collectible-tile-preview')">
                <option value="">-- None (use sprite/color) --</option>
            </select>
            <div id="collectible-tile-preview" style="margin-top:4px;height:24px;display:flex;align-items:center;gap:5px;">
                <span style="color:#666;font-size:10px;">Select a tile to use as sprite</span>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Sprite URL (overrides tile)</label>
                <div class="input-with-browse">
                    <input type="text" id="collectible-template-sprite" placeholder="https://...">
                    <button type="button" class="browse-library-btn" onclick="openAssetPicker('collectible-template-sprite')">Browse</button>
                </div>
            </div>
            <div class="form-group" style="flex: 0.4; min-width: 60px;">
                <label>Cols</label>
                <input type="number" id="collectible-template-cols" value="1" min="1" max="32" title="Frames per row">
            </div>
            <div class="form-group" style="flex: 0.4; min-width: 60px;">
                <label>Rows</label>
                <input type="number" id="collectible-template-rows" value="1" min="1" max="16" title="Number of rows">
            </div>
            <div class="form-group" style="flex: 0.4; min-width: 60px;">
                <label>Speed</label>
                <input type="number" id="collectible-template-animspeed" value="8" min="1" max="30" title="Animation speed: 1 = fastest, 30 = slowest">
                <span style="font-size:9px;color:#888;display:block;margin-top:2px;">1=fast ‚Üí 30=slow</span>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Width (px)</label>
                <input type="number" id="collectible-template-width" value="32" min="8" max="128">
            </div>
            <div class="form-group">
                <label>Height (px)</label>
                <input type="number" id="collectible-template-height" value="32" min="8" max="128">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Point Value</label>
                <input type="number" id="collectible-template-value" value="10" min="1" max="10000">
            </div>
            <div class="form-group" style="flex: 0.4;">
                <label>Symbol</label>
                <input type="text" id="collectible-template-symbol" value="‚òÖ" maxlength="2">
            </div>
            <div class="form-group" style="flex: 0.4;">
                <label>Color</label>
                <input type="color" id="collectible-template-color" value="#ffd700">
            </div>
        </div>
        <div class="form-group">
            <label>üîä Collect Sound</label>
            <div class="input-with-browse" style="display: flex; gap: 4px; flex-wrap: wrap;">
                <input type="text" id="collectible-template-sound" placeholder="URL or sfx:id" style="flex: 1; min-width: 120px;" onchange="updateSoundButtonStates('collectible-template-sound')">
                <button type="button" class="browse-library-btn" onclick="openAssetPicker('collectible-template-sound', 'sounds')">Browse</button>
                <button type="button" class="browse-library-btn sfx-create-btn" onclick="openSoundEffectStudio('collectible-template-sound', 'Collect Sound')" style="background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);">üéµ Create</button>
                <button type="button" class="browse-library-btn sfx-edit-btn" onclick="editSoundEffectStudio('collectible-template-sound')" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); display: none;">‚úèÔ∏è Edit</button>
                <button type="button" class="browse-library-btn sfx-preview-btn" onclick="testSoundFromInput('collectible-template-sound')" style="background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); display: none;">‚ñ∂</button>
                <button type="button" class="browse-library-btn sfx-unlink-btn" onclick="unlinkSoundEffectStudio('collectible-template-sound')" style="background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%); display: none;">‚úï</button>
            </div>
        </div>
        <div class="form-group" style="margin-top: 12px; padding: 10px; background: rgba(46, 204, 113, 0.1); border-radius: 6px; border: 1px solid rgba(46, 204, 113, 0.3);">
            <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="checkbox" id="collectible-template-respawns" style="width: 16px; height: 16px; margin-right: 8px;">
                <span>‚ôªÔ∏è Respawns When Collected</span>
            </label>
            <small style="color: #888; font-size: 10px; margin-left: 24px; display: block;">When collected, reappears at a random location (infinite collectibles)</small>
        </div>
        <div class="form-group" style="margin-top: 15px;">
            <label>‚ú® Collect Particle Effect</label>
            <div class="input-with-browse" style="display: flex; gap: 4px; flex-wrap: wrap;">
                <input type="text" id="collectible-template-collect-particle" placeholder="pfx:id" style="flex: 1; min-width: 100px;"
                    title="Particle effect when this item type is collected">
                <button type="button" class="browse-library-btn pfx-create-btn" onclick="openParticleFXStudio('collectible-template-collect-particle', 'Collect Effect', 'collect')" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);">‚ú® Create</button>
                <button type="button" class="browse-library-btn pfx-edit-btn" onclick="editParticleFXStudio('collectible-template-collect-particle')" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); display: none;">‚úèÔ∏è Edit</button>
                <button type="button" class="browse-library-btn pfx-unlink-btn" onclick="unlinkParticleFXStudio('collectible-template-collect-particle')" style="background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%); display: none;">‚úï</button>
            </div>
        </div>
        <div class="modal-buttons">
            <button class="btn" onclick="saveCollectibleTemplate()">Save</button>
            <button class="btn" onclick="closeCollectibleTemplateEditor()">Cancel</button>
        </div>
    </div>
</div>

<!-- Hazard Templates Modal -->
<div class="modal-overlay template-modal" id="hazard-templates-modal" onclick="if(event.target === this) closeHazardTemplatesModal()">
    <div class="modal">
        <h2>Hazard Types</h2>
        <p style="color: #888; font-size: 12px; margin-bottom: 10px;">Define dangerous obstacles</p>
        <div class="template-list" id="hazard-templates-list">
            <!-- Populated by JavaScript -->
        </div>
        <div class="modal-buttons">
            <button class="btn" style="background: linear-gradient(135deg, #7f8c8d, #636e72);" onclick="showAddHazardTemplate()">+ Add Hazard</button>
            <button class="btn" onclick="closeHazardTemplatesModal()">Close</button>
        </div>
    </div>
</div>

<!-- Hazard Template Editor -->
<div class="template-editor" id="hazard-template-editor">
    <div class="template-editor-content">
        <h3 id="hazard-template-title">Add Hazard Type <span class="help-icon" onclick="showHelp('objectTemplates')">?</span></h3>
        <div class="form-group">
            <label>Name</label>
            <input type="text" id="hazard-template-name" placeholder="e.g., Lava">
        </div>
        <div class="form-group">
            <label>Tile (from tileset)</label>
            <select id="hazard-template-tile" onchange="updateObjectTilePreview('hazard-template-tile', 'hazard-tile-preview')">
                <option value="">-- None (use sprite/color) --</option>
            </select>
            <div id="hazard-tile-preview" style="margin-top:4px;height:24px;display:flex;align-items:center;gap:5px;">
                <span style="color:#666;font-size:10px;">Select a tile to use as sprite</span>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Sprite URL (overrides tile)</label>
                <div class="input-with-browse">
                    <input type="text" id="hazard-template-sprite" placeholder="https://...">
                    <button type="button" class="browse-library-btn" onclick="openAssetPicker('hazard-template-sprite')">Browse</button>
                </div>
            </div>
            <div class="form-group" style="flex: 0.4; min-width: 60px;">
                <label>Cols</label>
                <input type="number" id="hazard-template-cols" value="1" min="1" max="32" title="Frames per row">
            </div>
            <div class="form-group" style="flex: 0.4; min-width: 60px;">
                <label>Rows</label>
                <input type="number" id="hazard-template-rows" value="1" min="1" max="16" title="Number of rows">
            </div>
            <div class="form-group" style="flex: 0.4; min-width: 60px;">
                <label>Speed</label>
                <input type="number" id="hazard-template-animspeed" value="8" min="1" max="30" title="Animation speed: 1 = fastest, 30 = slowest">
                <span style="font-size:9px;color:#888;display:block;margin-top:2px;">1=fast ‚Üí 30=slow</span>
            </div>
        </div>
        <div class="form-group">
            <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="hazard-template-instant-kill" style="width: auto;">
                Instant Kill
            </label>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Damage (if not instant kill)</label>
                <input type="number" id="hazard-template-damage" value="1" min="1" max="10">
            </div>
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="hazard-template-continuous" style="width: auto;">
                    Continuous Damage
                </label>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group" style="flex: 0.4;">
                <label>Symbol</label>
                <input type="text" id="hazard-template-symbol" value="‚ñ≤" maxlength="2">
            </div>
            <div class="form-group" style="flex: 0.4;">
                <label>Color</label>
                <input type="color" id="hazard-template-color" value="#888888">
            </div>
        </div>
        <div class="form-group">
            <label>üîä Damage Sound</label>
            <div class="input-with-browse" style="display: flex; gap: 4px; flex-wrap: wrap;">
                <input type="text" id="hazard-template-damage-sound" placeholder="URL or sfx:id" style="flex: 1; min-width: 120px;" onchange="updateSoundButtonStates('hazard-template-damage-sound')">
                <button type="button" class="browse-library-btn" onclick="openAssetPicker('hazard-template-damage-sound', 'sounds')">Browse</button>
                <button type="button" class="browse-library-btn sfx-create-btn" onclick="openSoundEffectStudio('hazard-template-damage-sound', 'Hazard Damage Sound')" style="background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);">üéµ Create</button>
                <button type="button" class="browse-library-btn sfx-edit-btn" onclick="editSoundEffectStudio('hazard-template-damage-sound')" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); display: none;">‚úèÔ∏è Edit</button>
                <button type="button" class="browse-library-btn sfx-preview-btn" onclick="testSoundFromInput('hazard-template-damage-sound')" style="background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); display: none;">‚ñ∂</button>
                <button type="button" class="browse-library-btn sfx-unlink-btn" onclick="unlinkSoundEffectStudio('hazard-template-damage-sound')" style="background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%); display: none;">‚úï</button>
            </div>
        </div>
        <div class="form-group" style="margin-top: 15px;">
            <label>üí• Damage Particle Effect</label>
            <div class="input-with-browse" style="display: flex; gap: 4px; flex-wrap: wrap;">
                <input type="text" id="hazard-template-particle" placeholder="pfx:id" style="flex: 1; min-width: 100px;"
                    title="Particle effect when player hits this hazard">
                <button type="button" class="browse-library-btn pfx-create-btn" onclick="openParticleFXStudio('hazard-template-particle', 'Hazard Damage Effect', 'damage')" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);">‚ú® Create</button>
                <button type="button" class="browse-library-btn pfx-edit-btn" onclick="editParticleFXStudio('hazard-template-particle')" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); display: none;">‚úèÔ∏è Edit</button>
                <button type="button" class="browse-library-btn pfx-unlink-btn" onclick="unlinkParticleFXStudio('hazard-template-particle')" style="background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%); display: none;">‚úï</button>
            </div>
        </div>
        <div class="modal-buttons">
            <button class="btn" onclick="saveHazardTemplate()">Save</button>
            <button class="btn" onclick="closeHazardTemplateEditor()">Cancel</button>
        </div>
    </div>
</div>

<!-- Powerup Templates Modal -->
<div class="modal-overlay template-modal" id="powerup-templates-modal" onclick="if(event.target === this) closePowerupTemplatesModal()">
    <div class="modal">
        <h2>Powerup Types</h2>
        <p style="color: #888; font-size: 12px; margin-bottom: 10px;">Define items that help the player</p>
        <div class="template-list" id="powerup-templates-list">
            <!-- Populated by JavaScript -->
        </div>
        <div class="modal-buttons">
            <button class="btn" style="background: linear-gradient(135deg, #e91e63, #c2185b);" onclick="showAddPowerupTemplate()">+ Add Powerup</button>
            <button class="btn" onclick="closePowerupTemplatesModal()">Close</button>
        </div>
    </div>
</div>

<!-- Powerup Template Editor -->
<div class="template-editor" id="powerup-template-editor">
    <div class="template-editor-content">
        <h3 id="powerup-template-title">Add Powerup Type <span class="help-icon" onclick="showHelp('powerups')">?</span></h3>
        <div class="form-group">
            <label>Name</label>
            <input type="text" id="powerup-template-name" placeholder="e.g., Shield">
        </div>
        <div class="form-group">
            <label>Tile (from tileset)</label>
            <select id="powerup-template-tile" onchange="updateObjectTilePreview('powerup-template-tile', 'powerup-tile-preview')">
                <option value="">-- None (use sprite/color) --</option>
            </select>
            <div id="powerup-tile-preview" style="margin-top:4px;height:24px;display:flex;align-items:center;gap:5px;">
                <span style="color:#666;font-size:10px;">Select a tile to use as sprite</span>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Sprite URL (overrides tile)</label>
                <div class="input-with-browse">
                    <input type="text" id="powerup-template-sprite" placeholder="https://...">
                    <button type="button" class="browse-library-btn" onclick="openAssetPicker('powerup-template-sprite')">Browse</button>
                </div>
            </div>
            <div class="form-group" style="flex: 0.4; min-width: 60px;">
                <label>Cols</label>
                <input type="number" id="powerup-template-cols" value="1" min="1" max="32" title="Frames per row">
            </div>
            <div class="form-group" style="flex: 0.4; min-width: 60px;">
                <label>Rows</label>
                <input type="number" id="powerup-template-rows" value="1" min="1" max="16" title="Number of rows">
            </div>
            <div class="form-group" style="flex: 0.4; min-width: 60px;">
                <label>Speed</label>
                <input type="number" id="powerup-template-animspeed" value="8" min="1" max="30" title="Animation speed: 1 = fastest, 30 = slowest">
                <span style="font-size:9px;color:#888;display:block;margin-top:2px;">1=fast ‚Üí 30=slow</span>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Width (px)</label>
                <input type="number" id="powerup-template-width" value="32" min="8" max="128">
            </div>
            <div class="form-group">
                <label>Height (px)</label>
                <input type="number" id="powerup-template-height" value="32" min="8" max="128">
            </div>
        </div>
        <div class="form-group">
            <label>Effect</label>
            <select id="powerup-template-effect" onchange="updatePowerupEffectOptions()">
                <option value="heal">Heal (restore health)</option>
                <option value="shield">Shield (temporary invincibility)</option>
                <option value="speed">Speed Boost</option>
                <option value="jump">Jump Boost</option>
                <option value="ammo">Ammo Pack (restore projectile ammo)</option>
            </select>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label id="powerup-amount-label">Heal Amount:</label>
                <input type="number" id="powerup-template-amount" value="1" min="1" max="10" step="0.5">
            </div>
            <div class="form-group" id="powerup-duration-group" style="display: none;">
                <label>Duration (seconds)</label>
                <input type="number" id="powerup-template-duration" value="5" min="1" max="60">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group" style="flex: 0.4;">
                <label>Symbol</label>
                <input type="text" id="powerup-template-symbol" value="‚ô•" maxlength="2">
            </div>
            <div class="form-group" style="flex: 0.4;">
                <label>Color</label>
                <input type="color" id="powerup-template-color" value="#ff6b6b">
            </div>
        </div>
        <div class="form-group">
            <label>üîä Pickup Sound</label>
            <div class="input-with-browse" style="display: flex; gap: 4px; flex-wrap: wrap;">
                <input type="text" id="powerup-template-sound" placeholder="URL or sfx:id" style="flex: 1; min-width: 120px;" onchange="updateSoundButtonStates('powerup-template-sound')">
                <button type="button" class="browse-library-btn" onclick="openAssetPicker('powerup-template-sound', 'sounds')">Browse</button>
                <button type="button" class="browse-library-btn sfx-create-btn" onclick="openSoundEffectStudio('powerup-template-sound', 'Powerup Pickup Sound')" style="background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);">üéµ Create</button>
                <button type="button" class="browse-library-btn sfx-edit-btn" onclick="editSoundEffectStudio('powerup-template-sound')" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); display: none;">‚úèÔ∏è Edit</button>
                <button type="button" class="browse-library-btn sfx-preview-btn" onclick="testSoundFromInput('powerup-template-sound')" style="background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); display: none;">‚ñ∂</button>
                <button type="button" class="browse-library-btn sfx-unlink-btn" onclick="unlinkSoundEffectStudio('powerup-template-sound')" style="background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%); display: none;">‚úï</button>
            </div>
        </div>
        <div class="form-group" style="margin-top: 15px;">
            <label>‚ú® Pickup Particle Effect</label>
            <div class="input-with-browse" style="display: flex; gap: 4px; flex-wrap: wrap;">
                <input type="text" id="powerup-template-particle" placeholder="pfx:id" style="flex: 1; min-width: 100px;"
                    title="Particle effect when this powerup is collected">
                <button type="button" class="browse-library-btn pfx-create-btn" onclick="openParticleFXStudio('powerup-template-particle', 'Powerup Pickup Effect', 'powerup')" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);">‚ú® Create</button>
                <button type="button" class="browse-library-btn pfx-edit-btn" onclick="editParticleFXStudio('powerup-template-particle')" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); display: none;">‚úèÔ∏è Edit</button>
                <button type="button" class="browse-library-btn pfx-unlink-btn" onclick="unlinkParticleFXStudio('powerup-template-particle')" style="background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%); display: none;">‚úï</button>
            </div>
        </div>
        <div class="modal-buttons">
            <button class="btn" onclick="savePowerupTemplate()">Save</button>
            <button class="btn" onclick="closePowerupTemplateEditor()">Cancel</button>
        </div>
    </div>
</div>

<!-- Spring Templates Modal -->
<div class="modal-overlay template-modal" id="spring-templates-modal" onclick="if(event.target === this) closeSpringTemplatesModal()">
    <div class="modal">
        <h2>Spring Types</h2>
        <p style="color: #888; font-size: 12px; margin-bottom: 10px;">Define bouncy platforms that launch the player</p>
        <div class="template-list" id="spring-templates-list">
            <!-- Populated by JavaScript -->
        </div>
        <div class="modal-buttons">
            <button class="btn" style="background: linear-gradient(135deg, #e74c3c, #c0392b);" onclick="showAddSpringTemplate()">+ Add Spring</button>
            <button class="btn" onclick="closeSpringTemplatesModal()">Close</button>
        </div>
    </div>
</div>

<!-- Spring Template Editor -->
<div class="template-editor" id="spring-template-editor">
    <div class="template-editor-content">
        <h3 id="spring-template-title">Add Spring Type <span class="help-icon" onclick="showHelp('springs')">?</span></h3>
        <div class="form-group">
            <label>Name</label>
            <input type="text" id="spring-template-name" placeholder="e.g., Super Spring">
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Sprite URL (optional)</label>
                <div class="input-with-browse">
                    <input type="text" id="spring-template-sprite" placeholder="https://...">
                    <button type="button" class="browse-library-btn" onclick="openAssetPicker('spring-template-sprite')">Browse</button>
                </div>
            </div>
            <div class="form-group" style="flex: 0.4; min-width: 60px;">
                <label>Cols</label>
                <input type="number" id="spring-template-cols" value="1" min="1" max="32" title="Frames per row">
            </div>
            <div class="form-group" style="flex: 0.4; min-width: 60px;">
                <label>Rows</label>
                <input type="number" id="spring-template-rows" value="1" min="1" max="16" title="Number of rows">
            </div>
            <div class="form-group" style="flex: 0.4; min-width: 60px;">
                <label>Speed</label>
                <input type="number" id="spring-template-animspeed" value="8" min="1" max="30" title="Animation speed: 1 = fastest, 30 = slowest">
                <span style="font-size:9px;color:#888;display:block;margin-top:2px;">1=fast ‚Üí 30=slow</span>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Width (px)</label>
                <input type="number" id="spring-template-width" value="32" min="8" max="128">
            </div>
            <div class="form-group">
                <label>Height (px)</label>
                <input type="number" id="spring-template-height" value="16" min="8" max="128">
            </div>
        </div>
        <div class="form-group">
            <label>Bounce Power (multiplier of jump power)</label>
            <input type="number" id="spring-template-bouncepower" value="1.5" min="1" max="5" step="0.1">
            <span style="font-size:9px;color:#888;display:block;margin-top:2px;">1.0 = normal jump, 2.0 = double height, 3.0 = triple height</span>
        </div>
        <div class="form-row">
            <div class="form-group" style="flex: 0.3;">
                <label>Symbol</label>
                <input type="text" id="spring-template-symbol" value="üîº" maxlength="2">
            </div>
            <div class="form-group" style="flex: 0.3;">
                <label>Fallback Color</label>
                <input type="color" id="spring-template-color" value="#9b59b6">
            </div>
        </div>
        <div class="form-group">
            <label>üîä Bounce Sound</label>
            <div class="input-with-browse" style="display: flex; gap: 4px; flex-wrap: wrap;">
                <input type="text" id="spring-template-sound" placeholder="URL or sfx:id" style="flex: 1; min-width: 120px;" onchange="updateSoundButtonStates('spring-template-sound')">
                <button type="button" class="browse-library-btn" onclick="openAssetPicker('spring-template-sound', 'sounds')">Browse</button>
                <button type="button" class="browse-library-btn sfx-create-btn" onclick="openSoundEffectStudio('spring-template-sound', 'Spring Bounce Sound')" style="background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);">üéµ Create</button>
                <button type="button" class="browse-library-btn sfx-edit-btn" onclick="editSoundEffectStudio('spring-template-sound')" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); display: none;">‚úèÔ∏è Edit</button>
                <button type="button" class="browse-library-btn sfx-preview-btn" onclick="testSoundFromInput('spring-template-sound')" style="background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); display: none;">‚ñ∂</button>
                <button type="button" class="browse-library-btn sfx-unlink-btn" onclick="unlinkSoundEffectStudio('spring-template-sound')" style="background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%); display: none;">‚úï</button>
            </div>
        </div>
        <div class="form-group" style="margin-top: 15px;">
            <label>üí® Bounce Particle Effect</label>
            <div class="input-with-browse" style="display: flex; gap: 4px; flex-wrap: wrap;">
                <input type="text" id="spring-template-particle" placeholder="pfx:id" style="flex: 1; min-width: 100px;"
                    title="Particle effect when player bounces on this spring">
                <button type="button" class="browse-library-btn pfx-create-btn" onclick="openParticleFXStudio('spring-template-particle', 'Spring Bounce Effect', 'bounce')" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);">‚ú® Create</button>
                <button type="button" class="browse-library-btn pfx-edit-btn" onclick="editParticleFXStudio('spring-template-particle')" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); display: none;">‚úèÔ∏è Edit</button>
                <button type="button" class="browse-library-btn pfx-unlink-btn" onclick="unlinkParticleFXStudio('spring-template-particle')" style="background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%); display: none;">‚úï</button>
            </div>
        </div>
        <div class="modal-buttons">
            <button class="btn" onclick="saveSpringTemplate()">Save</button>
            <button class="btn" onclick="closeSpringTemplateEditor()">Cancel</button>
        </div>
    </div>
</div>

<!-- Terrain Zone Templates Modal -->
<div class="modal-overlay template-modal" id="terrain-zone-templates-modal" onclick="if(event.target === this) closeTerrainZoneTemplatesModal()">
    <div class="modal">
        <h2>üåä Terrain Zone Types</h2>
        <p style="color: #888; font-size: 12px; margin-bottom: 10px;">Define areas that affect movement speed, physics, and can deal damage</p>
        <div class="template-list" id="terrain-zone-templates-list">
            <!-- Populated by JavaScript -->
        </div>
        <div class="modal-buttons">
            <button class="btn" style="background: linear-gradient(135deg, #4a90d9, #2c5f8a);" onclick="showAddTerrainZoneTemplate()">+ Add Zone Type</button>
            <button class="btn" onclick="closeTerrainZoneTemplatesModal()">Close</button>
        </div>
    </div>
</div>

<!-- Terrain Zone Template Editor -->
<div class="template-editor" id="terrain-zone-template-editor">
    <div class="template-editor-content">
        <h3 id="terrain-zone-template-title">Add Terrain Zone Type</h3>
        <div class="form-group">
            <label>Name</label>
            <input type="text" id="terrain-zone-template-name" placeholder="e.g., Water, Mud, Ice, Lava">
        </div>
        <div class="form-group">
            <label>Image URL (optional - will tile across zone)</label>
            <div class="input-with-browse">
                <input type="text" id="terrain-zone-template-image" placeholder="https://... (leave empty for solid color)">
                <button type="button" class="browse-library-btn" onclick="openAssetPicker('terrain-zone-template-image', 'tilesets')">Browse</button>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group" style="flex: 0.4;">
                <label>Tint Color</label>
                <input type="color" id="terrain-zone-template-tint" value="#4a90d9">
            </div>
            <div class="form-group" style="flex: 0.6;">
                <label>Opacity: <span id="terrain-zone-opacity-display">0.6</span></label>
                <input type="range" id="terrain-zone-template-opacity" value="0.6" min="0.1" max="1" step="0.1"
                       oninput="document.getElementById('terrain-zone-opacity-display').textContent = this.value">
            </div>
        </div>

        <h4 style="color: #4a90d9; margin: 15px 0 10px; font-size: 12px; border-bottom: 1px solid #333; padding-bottom: 5px;">‚ö° Movement Effects</h4>
        <div class="form-group">
            <label>Speed Multiplier: <span id="terrain-zone-speed-display">0.5x</span></label>
            <input type="range" id="terrain-zone-template-speed" value="0.5" min="0.1" max="2" step="0.1"
                   oninput="document.getElementById('terrain-zone-speed-display').textContent = this.value + 'x'">
            <span style="font-size:9px;color:#888;display:block;margin-top:2px;">0.1 = very slow, 1.0 = normal, 2.0 = double speed</span>
        </div>

        <div class="form-row platformer-physics-row">
            <div class="form-group">
                <label>Jump Multiplier: <span id="terrain-zone-jump-display">0.7x</span></label>
                <input type="range" id="terrain-zone-template-jump" value="0.7" min="0.1" max="1.5" step="0.1"
                       oninput="document.getElementById('terrain-zone-jump-display').textContent = this.value + 'x'">
                <span style="font-size:9px;color:#888;">Platformer only</span>
            </div>
            <div class="form-group">
                <label>Gravity Multiplier: <span id="terrain-zone-gravity-display">0.8x</span></label>
                <input type="range" id="terrain-zone-template-gravity" value="0.8" min="0.1" max="2" step="0.1"
                       oninput="document.getElementById('terrain-zone-gravity-display').textContent = this.value + 'x'">
                <span style="font-size:9px;color:#888;">Platformer only</span>
            </div>
        </div>

        <h4 style="color: #e74c3c; margin: 15px 0 10px; font-size: 12px; border-bottom: 1px solid #333; padding-bottom: 5px;">üíî Damage</h4>
        <div class="form-group">
            <label>Damage Per Second (0 = no damage)</label>
            <input type="number" id="terrain-zone-template-damage" value="0" min="0" max="10" step="0.5">
            <span style="font-size:9px;color:#888;display:block;margin-top:2px;">Use for lava, poison swamp, etc.</span>
        </div>

        <h4 style="color: #2ecc71; margin: 15px 0 10px; font-size: 12px; border-bottom: 1px solid #333; padding-bottom: 5px;">üîä Sounds</h4>
        <div class="form-row">
            <div class="form-group">
                <label>Entry Sound</label>
                <div class="input-with-browse" style="display: flex; gap: 4px; flex-wrap: wrap;">
                    <input type="text" id="terrain-zone-template-entry-sound" placeholder="URL or sfx:id" style="flex: 1; min-width: 100px;" onchange="updateSoundButtonStates('terrain-zone-template-entry-sound')">
                    <button type="button" class="browse-library-btn" onclick="openAssetPicker('terrain-zone-template-entry-sound', 'sounds')">Browse</button>
                    <button type="button" class="browse-library-btn sfx-create-btn" onclick="openSoundEffectStudio('terrain-zone-template-entry-sound', 'Zone Entry Sound')" style="background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);">üéµ Create</button>
                    <button type="button" class="browse-library-btn sfx-edit-btn" onclick="editSoundEffectStudio('terrain-zone-template-entry-sound')" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); display: none;">‚úèÔ∏è Edit</button>
                    <button type="button" class="browse-library-btn sfx-preview-btn" onclick="testSoundFromInput('terrain-zone-template-entry-sound')" style="background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); display: none;">‚ñ∂</button>
                    <button type="button" class="browse-library-btn sfx-unlink-btn" onclick="unlinkSoundEffectStudio('terrain-zone-template-entry-sound')" style="background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%); display: none;">‚úï</button>
                </div>
            </div>
            <div class="form-group">
                <label>Loop Sound (ambient)</label>
                <div class="input-with-browse" style="display: flex; gap: 4px; flex-wrap: wrap;">
                    <input type="text" id="terrain-zone-template-loop-sound" placeholder="URL or sfx:id" style="flex: 1; min-width: 100px;" onchange="updateSoundButtonStates('terrain-zone-template-loop-sound')">
                    <button type="button" class="browse-library-btn" onclick="openAssetPicker('terrain-zone-template-loop-sound', 'sounds')">Browse</button>
                    <button type="button" class="browse-library-btn sfx-create-btn" onclick="openSoundEffectStudio('terrain-zone-template-loop-sound', 'Zone Ambient Sound')" style="background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);">üéµ Create</button>
                    <button type="button" class="browse-library-btn sfx-edit-btn" onclick="editSoundEffectStudio('terrain-zone-template-loop-sound')" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); display: none;">‚úèÔ∏è Edit</button>
                    <button type="button" class="browse-library-btn sfx-preview-btn" onclick="testSoundFromInput('terrain-zone-template-loop-sound')" style="background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); display: none;">‚ñ∂</button>
                    <button type="button" class="browse-library-btn sfx-unlink-btn" onclick="unlinkSoundEffectStudio('terrain-zone-template-loop-sound')" style="background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%); display: none;">‚úï</button>
                </div>
            </div>
        </div>

        <h4 style="color: #f39c12; margin: 15px 0 10px; font-size: 12px; border-bottom: 1px solid #333; padding-bottom: 5px;">‚öôÔ∏è Options</h4>
        <div class="form-row">
            <div class="form-group" style="flex: 1;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="terrain-zone-template-affects-enemies" checked style="width: 16px; height: 16px;">
                    Affects Enemies Too
                </label>
                <span style="font-size:9px;color:#888;display:block;margin-top:2px;">Slow down enemies in this zone</span>
            </div>
            <div class="form-group" style="flex: 0.3;">
                <label>Symbol</label>
                <input type="text" id="terrain-zone-template-symbol" value="~" maxlength="2">
            </div>
        </div>

        <div class="modal-buttons">
            <button class="btn" onclick="saveTerrainZoneTemplate()">Save</button>
            <button class="btn" onclick="closeTerrainZoneTemplateEditor()">Cancel</button>
        </div>
    </div>
</div>

<!-- Moving Platform Templates Modal -->
<div class="modal-overlay template-modal" id="moving-platform-templates-modal" onclick="if(event.target === this) closeMovingPlatformTemplatesModal()">
    <div class="modal">
        <h2>Moving Platform Types</h2>
        <p style="color: #888; font-size: 12px; margin-bottom: 10px;">Define platforms that move back and forth</p>
        <div class="template-list" id="moving-platform-templates-list">
            <!-- Populated by JavaScript -->
        </div>
        <div class="modal-buttons">
            <button class="btn" style="background: linear-gradient(135deg, #8B4513, #654321);" onclick="showAddMovingPlatformTemplate()">+ Add Platform</button>
            <button class="btn" onclick="closeMovingPlatformTemplatesModal()">Close</button>
        </div>
    </div>
</div>

<!-- Moving Platform Template Editor -->
<div class="template-editor" id="moving-platform-template-editor">
    <div class="template-editor-content wide">
        <h3 id="moving-platform-template-title">Add Moving Platform Type</h3>

        <div class="editor-columns">
            <!-- Left Column: Appearance -->
            <div class="editor-column">
                <div class="editor-section-header">Appearance</div>

                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="moving-platform-template-name" placeholder="e.g., Slow Elevator">
                </div>

                <div class="form-row">
                    <div class="form-group" style="flex: 0.3;">
                        <label>Symbol</label>
                        <input type="text" id="moving-platform-template-symbol" value="‚ïê" maxlength="2">
                    </div>
                    <div class="form-group" style="flex: 0.3;">
                        <label>Color</label>
                        <input type="color" id="moving-platform-template-color" value="#8B4513">
                    </div>
                </div>

                <div class="form-group">
                    <label>Surface Tile (from tileset)</label>
                    <select id="moving-platform-template-tile" onchange="updatePlatformTilePreview()">
                        <option value="">-- None (use color/sprite) --</option>
                    </select>
                    <div id="platform-tile-preview" style="margin-top:4px;height:24px;display:flex;align-items:center;gap:5px;">
                        <span style="color:#666;font-size:10px;">Select a tile to preview</span>
                    </div>
                </div>

                <div class="form-group">
                    <label>Sprite URL (overrides tile)</label>
                    <div class="input-with-browse">
                        <input type="text" id="moving-platform-template-sprite" placeholder="https://...">
                        <button type="button" class="browse-library-btn" onclick="openAssetPicker('moving-platform-template-sprite')">Browse</button>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Cols</label>
                        <input type="number" id="moving-platform-template-cols" value="1" min="1" max="32" title="Frames per row">
                    </div>
                    <div class="form-group">
                        <label>Rows</label>
                        <input type="number" id="moving-platform-template-rows" value="1" min="1" max="16" title="Number of rows">
                    </div>
                    <div class="form-group">
                        <label>Anim FPS</label>
                        <input type="number" id="moving-platform-template-animspeed" value="8" min="1" max="30">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Width (px)</label>
                        <input type="number" id="moving-platform-template-width" value="64" min="16" max="256">
                    </div>
                    <div class="form-group">
                        <label>Height (px)</label>
                        <input type="number" id="moving-platform-template-height" value="16" min="8" max="128">
                    </div>
                </div>
            </div>

            <!-- Right Column: Movement & Behavior -->
            <div class="editor-column">
                <div class="editor-section-header">Movement</div>

                <div class="form-group">
                    <label>Axis</label>
                    <select id="moving-platform-template-axis">
                        <option value="x">Horizontal (left-right)</option>
                        <option value="y">Vertical (up-down)</option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Distance (px)</label>
                        <input type="number" id="moving-platform-template-distance" value="100" min="16" max="500">
                    </div>
                    <div class="form-group">
                        <label>Speed (px/frame)</label>
                        <input type="number" id="moving-platform-template-speed" value="2" min="0.5" max="10" step="0.5">
                    </div>
                </div>

                <div class="editor-section-header">Behavior</div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Collision</label>
                        <select id="moving-platform-template-collision">
                            <option value="solid">Solid (all sides)</option>
                            <option value="oneway">One-way (top only)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Activation</label>
                        <select id="moving-platform-template-activation" onchange="togglePlatformOutlineOptions()">
                            <option value="always">Always moving</option>
                            <option value="touch">On touch</option>
                        </select>
                    </div>
                </div>

                <div id="platform-randomize-options" class="form-group" style="margin-bottom: 8px;">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="moving-platform-template-randomize">
                        Randomize Start
                        <small style="color: #888; font-weight: normal; margin-left: 5px;">Platforms start at different positions</small>
                    </label>
                </div>

                <div id="platform-outline-options" style="display: none;">
                    <div class="form-row">
                        <div class="form-group" style="flex: 1;">
                            <label style="display: flex; align-items: center; gap: 6px;">
                                <input type="checkbox" id="moving-platform-template-show-outline" checked>
                                Show Inactive Outline
                            </label>
                        </div>
                        <div class="form-group" style="flex: 0.5;">
                            <label>Outline Color</label>
                            <input type="color" id="moving-platform-template-outline-color" value="#ffff00">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>üîä Movement Sound</label>
                    <div class="input-with-browse" style="display: flex; gap: 4px; flex-wrap: wrap;">
                        <input type="text" id="moving-platform-template-sound" placeholder="URL or sfx:id" style="flex: 1; min-width: 120px;" onchange="updateSoundButtonStates('moving-platform-template-sound')">
                        <button type="button" class="browse-library-btn" onclick="openAssetPicker('moving-platform-template-sound', 'sounds')">Browse</button>
                        <button type="button" class="browse-library-btn sfx-create-btn" onclick="openSoundEffectStudio('moving-platform-template-sound', 'Platform Move Sound')" style="background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);">üéµ Create</button>
                        <button type="button" class="browse-library-btn sfx-edit-btn" onclick="editSoundEffectStudio('moving-platform-template-sound')" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); display: none;">‚úèÔ∏è Edit</button>
                        <button type="button" class="browse-library-btn sfx-preview-btn" onclick="testSoundFromInput('moving-platform-template-sound')" style="background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); display: none;">‚ñ∂</button>
                        <button type="button" class="browse-library-btn sfx-unlink-btn" onclick="unlinkSoundEffectStudio('moving-platform-template-sound')" style="background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%); display: none;">‚úï</button>
                    </div>
                </div>
            </div>

            <!-- Full Width: Collapsing Platform Options -->
            <div class="editor-full-width">
                <div class="editor-section-header">Collapsing Platform</div>

                <div class="form-group" style="margin-bottom: 8px;">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="moving-platform-template-collapsing" onchange="toggleCollapsingOptions()">
                        Enable Collapsing
                        <small style="color: #888; font-weight: normal; margin-left: 5px;">Platform falls after player stands on it</small>
                    </label>
                </div>

                <div id="platform-collapse-options" class="editor-collapsible" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Delay (sec)</label>
                            <input type="number" id="moving-platform-template-collapse-delay" value="1.0" min="0.1" max="10" step="0.1">
                        </div>
                        <div class="form-group">
                            <label>Shake (sec)</label>
                            <input type="number" id="moving-platform-template-collapse-shake" value="0.5" min="0.1" max="5" step="0.1">
                        </div>
                        <div class="form-group">
                            <label>Respawn (sec)</label>
                            <input type="number" id="moving-platform-template-collapse-respawn" value="3.0" min="0" max="30" step="0.5">
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>üîä Collapse Sound</label>
                        <div class="input-with-browse" style="display: flex; gap: 4px; flex-wrap: wrap;">
                            <input type="text" id="moving-platform-template-collapse-sound" placeholder="URL or sfx:id" style="flex: 1; min-width: 120px;" onchange="updateSoundButtonStates('moving-platform-template-collapse-sound')">
                            <button type="button" class="browse-library-btn" onclick="openAssetPicker('moving-platform-template-collapse-sound', 'sounds')">Browse</button>
                            <button type="button" class="browse-library-btn sfx-create-btn" onclick="openSoundEffectStudio('moving-platform-template-collapse-sound', 'Platform Collapse Sound')" style="background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);">üéµ Create</button>
                            <button type="button" class="browse-library-btn sfx-edit-btn" onclick="editSoundEffectStudio('moving-platform-template-collapse-sound')" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); display: none;">‚úèÔ∏è Edit</button>
                            <button type="button" class="browse-library-btn sfx-preview-btn" onclick="testSoundFromInput('moving-platform-template-collapse-sound')" style="background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); display: none;">‚ñ∂</button>
                            <button type="button" class="browse-library-btn sfx-unlink-btn" onclick="unlinkSoundEffectStudio('moving-platform-template-collapse-sound')" style="background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%); display: none;">‚úï</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal-buttons" style="margin-top: 15px;">
            <button class="btn" onclick="saveMovingPlatformTemplate()">Save</button>
            <button class="btn" onclick="closeMovingPlatformTemplateEditor()">Cancel</button>
        </div>
    </div>
</div>

<!-- NPC Templates Modal (Top-Down RPG) -->
<div class="modal-overlay template-modal topdown-only" id="npc-templates-modal" onclick="if(event.target === this) closeNPCTemplatesModal()">
    <div class="modal">
        <h2>üë§ NPC Types</h2>
        <p style="color: #888; font-size: 12px; margin-bottom: 10px;">Define characters the player can talk to (Top-Down RPG only)</p>
        <div class="template-list" id="npc-templates-list">
            <!-- Populated by JavaScript -->
        </div>
        <div class="modal-buttons">
            <button class="btn" style="background: linear-gradient(135deg, #3498db, #2980b9);" onclick="showAddNPCTemplate()">+ Add NPC</button>
            <button class="btn" onclick="closeNPCTemplatesModal()">Close</button>
        </div>
    </div>
</div>

<!-- NPC Template Editor -->
<div class="template-editor" id="npc-template-editor">
    <div class="template-editor-content">
        <h3 id="npc-template-title">Add NPC Type</h3>
        <div class="form-group">
            <label>Name</label>
            <input type="text" id="npc-template-name" placeholder="e.g., Shopkeeper">
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Sprite URL (optional)</label>
                <div class="input-with-browse">
                    <input type="text" id="npc-template-sprite" placeholder="https://...">
                    <button type="button" class="browse-library-btn" onclick="openAssetPicker('npc-template-sprite')">Browse</button>
                </div>
            </div>
            <div class="form-group" style="flex: 0.4; min-width: 60px;">
                <label>Cols</label>
                <input type="number" id="npc-template-cols" value="1" min="1" max="32" title="Frames per row">
            </div>
            <div class="form-group" style="flex: 0.4; min-width: 60px;">
                <label>Rows</label>
                <input type="number" id="npc-template-rows" value="1" min="1" max="16" title="Rows (4 for directional: down/left/right/up)">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group" style="flex: 0.4;">
                <label>Width (px)</label>
                <input type="number" id="npc-template-width" value="32" min="8" max="128">
            </div>
            <div class="form-group" style="flex: 0.4;">
                <label>Height (px)</label>
                <input type="number" id="npc-template-height" value="32" min="8" max="128">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group" style="flex: 0.3;">
                <label>Symbol</label>
                <input type="text" id="npc-template-symbol" value="üë§" maxlength="2">
            </div>
            <div class="form-group" style="flex: 0.3;">
                <label>Fallback Color</label>
                <input type="color" id="npc-template-color" value="#3498db">
            </div>
        </div>
        <div class="form-group">
            <label>Dialogue (one line per message)</label>
            <textarea id="npc-template-dialogue" rows="4" placeholder="Hello!&#10;How are you today?&#10;Goodbye!" style="width: 100%; resize: vertical;"></textarea>
            <span style="font-size:9px;color:#888;display:block;margin-top:2px;">Player presses E to advance through each line</span>
        </div>
        <div class="form-row">
            <div class="form-group" style="flex: 0.5;">
                <label>Interaction Radius (px)</label>
                <input type="number" id="npc-template-radius" value="48" min="16" max="128">
            </div>
            <div class="form-group" style="flex: 0.5;">
                <label>Behavior</label>
                <select id="npc-template-behavior" onchange="toggleNPCWanderOptions()">
                    <option value="stationary">Stationary</option>
                    <option value="wander">Wander</option>
                </select>
            </div>
        </div>
        <!-- Wander Options (shown when behavior is 'wander') -->
        <div id="npc-wander-options" style="display: none; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px; margin-top: 5px;">
            <div style="font-size: 11px; color: #9b59b6; margin-bottom: 8px; font-weight: bold;">Wander Options</div>
            <div class="form-row">
                <div class="form-group" style="flex: 0.5;">
                    <label>Wander Speed</label>
                    <input type="number" id="npc-template-wander-speed" value="1" min="0.5" max="5" step="0.5" title="Movement speed while wandering (0.5-5)">
                </div>
                <div class="form-group" style="flex: 0.5;">
                    <label>Wander Radius (tiles)</label>
                    <input type="number" id="npc-template-wander-radius" value="3" min="1" max="10" title="Maximum distance from start position in tiles">
                </div>
            </div>
            <div class="form-group" style="margin-top: 5px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="npc-template-solid-collision" checked style="width: 18px; height: 18px;">
                    <span>Collide with solid tiles (walls)</span>
                </label>
                <span style="font-size:9px;color:#888;display:block;margin-top:2px;">When disabled, NPC can pass through walls while wandering</span>
            </div>
        </div>
        <div class="modal-buttons">
            <button class="btn" onclick="saveNPCTemplate()">Save</button>
            <button class="btn" onclick="closeNPCTemplateEditor()">Cancel</button>
        </div>
    </div>
</div>

<!-- Door Templates Modal (Top-Down RPG) -->
<div class="modal-overlay template-modal topdown-only" id="door-templates-modal" onclick="if(event.target === this) closeDoorTemplatesModal()">
    <div class="modal">
        <h2>üö™ Door Types</h2>
        <p style="color: #888; font-size: 12px; margin-bottom: 10px;">Define teleporters and level transitions (Top-Down RPG only)</p>
        <div class="template-list" id="door-templates-list">
            <!-- Populated by JavaScript -->
        </div>
        <div class="modal-buttons">
            <button class="btn" style="background: linear-gradient(135deg, #8b4513, #654321);" onclick="showAddDoorTemplate()">+ Add Door</button>
            <button class="btn" onclick="closeDoorTemplatesModal()">Close</button>
        </div>
    </div>
</div>

<!-- Door Template Editor -->
<div class="template-editor" id="door-template-editor">
    <div class="template-editor-content">
        <h3 id="door-template-title">Add Door Type</h3>
        <div class="form-group">
            <label>Name</label>
            <input type="text" id="door-template-name" placeholder="e.g., Cave Entrance">
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Sprite URL (optional)</label>
                <div class="input-with-browse">
                    <input type="text" id="door-template-sprite" placeholder="https://...">
                    <button type="button" class="browse-library-btn" onclick="openAssetPicker('door-template-sprite')">Browse</button>
                </div>
            </div>
            <div class="form-group" style="flex: 0.4; min-width: 60px;">
                <label>Cols</label>
                <input type="number" id="door-template-cols" value="1" min="1" max="32" title="Frames per row">
            </div>
            <div class="form-group" style="flex: 0.4; min-width: 60px;">
                <label>Rows</label>
                <input type="number" id="door-template-rows" value="1" min="1" max="16" title="Number of rows">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group" style="flex: 0.4;">
                <label>Width (px)</label>
                <input type="number" id="door-template-width" value="32" min="8" max="128">
            </div>
            <div class="form-group" style="flex: 0.4;">
                <label>Height (px)</label>
                <input type="number" id="door-template-height" value="48" min="8" max="128">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group" style="flex: 0.3;">
                <label>Symbol</label>
                <input type="text" id="door-template-symbol" value="üö™" maxlength="2">
            </div>
            <div class="form-group" style="flex: 0.3;">
                <label>Fallback Color</label>
                <input type="color" id="door-template-color" value="#8b4513">
            </div>
        </div>
        <div class="form-group">
            <label>Destination Type</label>
            <select id="door-template-dest-type" onchange="updateDoorDestinationOptions()">
                <option value="level">Go to Another Level</option>
                <option value="position">Teleport Within Level</option>
            </select>
        </div>
        <div id="door-level-options">
            <div class="form-group">
                <label>Destination Level</label>
                <select id="door-template-dest-level">
                    <option value="">-- Select Level --</option>
                </select>
            </div>
        </div>
        <div id="door-position-options" style="display: none;">
            <div class="form-row">
                <div class="form-group" style="flex: 0.5;">
                    <label>Destination X (tile)</label>
                    <input type="number" id="door-template-dest-x" value="0" min="0">
                </div>
                <div class="form-group" style="flex: 0.5;">
                    <label>Destination Y (tile)</label>
                    <input type="number" id="door-template-dest-y" value="0" min="0">
                </div>
            </div>
        </div>
        <div class="form-group">
            <label>üîä Interact Sound</label>
            <div class="input-with-browse" style="display: flex; gap: 4px; flex-wrap: wrap;">
                <input type="text" id="door-template-sound" placeholder="URL or sfx:id" style="flex: 1; min-width: 120px;" onchange="updateSoundButtonStates('door-template-sound')">
                <button type="button" class="browse-library-btn" onclick="openAssetPicker('door-template-sound', 'sounds')">Browse</button>
                <button type="button" class="browse-library-btn sfx-create-btn" onclick="openSoundEffectStudio('door-template-sound', 'Door Interact Sound')" style="background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);">üéµ Create</button>
                <button type="button" class="browse-library-btn sfx-edit-btn" onclick="editSoundEffectStudio('door-template-sound')" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); display: none;">‚úèÔ∏è Edit</button>
                <button type="button" class="browse-library-btn sfx-preview-btn" onclick="testSoundFromInput('door-template-sound')" style="background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); display: none;">‚ñ∂</button>
                <button type="button" class="browse-library-btn sfx-unlink-btn" onclick="unlinkSoundEffectStudio('door-template-sound')" style="background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%); display: none;">‚úï</button>
            </div>
        </div>
        <div class="form-group">
            <label>‚ú® Teleport Effect</label>
            <div class="input-with-browse" style="display: flex; gap: 4px; flex-wrap: wrap;">
                <input type="text" id="door-template-particle" placeholder="pfx:id" style="flex: 1; min-width: 100px;"
                    title="Particle effect when player uses this door">
                <button type="button" class="browse-library-btn pfx-create-btn" onclick="openParticleFXStudio('door-template-particle', 'Door Teleport Effect', 'sparkle')" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);">‚ú® Create</button>
                <button type="button" class="browse-library-btn pfx-edit-btn" onclick="editParticleFXStudio('door-template-particle')" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); display: none;">‚úèÔ∏è Edit</button>
                <button type="button" class="browse-library-btn pfx-unlink-btn" onclick="unlinkParticleFXStudio('door-template-particle')" style="background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%); display: none;">‚úï</button>
            </div>
        </div>
        <div class="modal-buttons">
            <button class="btn" onclick="saveDoorTemplate()">Save</button>
            <button class="btn" onclick="closeDoorTemplateEditor()">Cancel</button>
        </div>
    </div>
</div>

<!-- Mystery Block Templates Modal -->
<div class="modal-overlay template-modal platformer-only" id="mystery-block-templates-modal" onclick="if(event.target === this) closeMysteryBlockTemplatesModal()">
    <div class="modal">
        <h2>? Mystery Blocks</h2>
        <p style="color: #888; font-size: 12px; margin-bottom: 10px;">Blocks that emit items when hit from below</p>
        <div class="template-list" id="mystery-block-templates-list">
            <!-- Populated by JavaScript -->
        </div>
        <div class="modal-buttons">
            <button class="btn" style="background: linear-gradient(135deg, #f1c40f, #e67e22);" onclick="showAddMysteryBlockTemplate()">+ Add Mystery Block</button>
            <button class="btn" onclick="closeMysteryBlockTemplatesModal()">Close</button>
        </div>
    </div>
</div>

<!-- Mystery Block Template Editor -->
<div class="template-editor" id="mystery-block-template-editor">
    <div class="template-editor-content wide" style="max-height: 85vh; overflow-y: auto;">
        <h3 id="mystery-block-template-title">Add Mystery Block Type <span class="help-icon" onclick="showHelp('objectTemplates')">?</span></h3>

        <div class="editor-columns">
            <!-- Left Column: Appearance -->
            <div class="editor-column">
                <div class="editor-section-header">üì¶ Appearance</div>

                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="mystery-block-template-name" placeholder="e.g., Coin Block">
                </div>

                <div class="form-group">
                    <label>Active Sprite (optional)</label>
                    <div class="input-with-browse">
                        <input type="text" id="mystery-block-template-sprite" placeholder="https://...">
                        <button type="button" class="browse-library-btn" onclick="openAssetPicker('mystery-block-template-sprite')">Browse</button>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Cols</label>
                        <input type="number" id="mystery-block-template-cols" value="1" min="1" max="32" title="Frames per row">
                    </div>
                    <div class="form-group">
                        <label>Rows</label>
                        <input type="number" id="mystery-block-template-rows" value="1" min="1" max="16" title="Number of rows">
                    </div>
                    <div class="form-group">
                        <label>Symbol</label>
                        <input type="text" id="mystery-block-template-symbol" value="?" maxlength="2">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Width (px)</label>
                        <input type="number" id="mystery-block-template-width" value="32" min="8" max="128">
                    </div>
                    <div class="form-group">
                        <label>Height (px)</label>
                        <input type="number" id="mystery-block-template-height" value="32" min="8" max="128">
                    </div>
                    <div class="form-group" style="flex: 0.6;">
                        <label>Active Color</label>
                        <input type="color" id="mystery-block-template-color" value="#f1c40f">
                    </div>
                </div>

                <!-- Depleted Appearance Section -->
                <div style="border: 1px solid rgba(241, 196, 15, 0.3); border-radius: 6px; padding: 10px; margin-top: 12px; background: rgba(241, 196, 15, 0.05);">
                    <div style="color: #f1c40f; font-size: 11px; font-weight: bold; margin-bottom: 8px;">üî≤ Depleted Appearance</div>

                    <div class="form-group" style="margin-bottom: 6px;">
                        <label style="font-size: 10px; color: #888;">Sprite URL</label>
                        <input type="text" id="mystery-block-template-empty-sprite" placeholder="https://..." style="font-size: 11px; padding: 5px 8px;">
                    </div>

                    <div class="form-group" style="margin-bottom: 6px;">
                        <label style="font-size: 10px; color: #888;">Or Tile from Tileset</label>
                        <select id="mystery-block-template-empty-tile-key" onchange="updateMysteryBlockEmptyTilePreview()" style="font-size: 11px; padding: 5px 8px;">
                            <option value="">-- None --</option>
                        </select>
                        <div id="mystery-block-empty-tile-preview" style="margin-top:4px;height:24px;display:flex;align-items:center;gap:5px;">
                            <span style="color:#666;font-size:10px;">Select a tile to preview</span>
                        </div>
                    </div>

                    <div class="form-group" style="margin-bottom: 0;">
                        <label style="font-size: 10px; color: #888;">Or Fallback Color</label>
                        <input type="color" id="mystery-block-template-empty-color" value="#8B4513" style="width: 40px; height: 24px;">
                    </div>
                </div>
            </div>

            <!-- Right Column: Behavior -->
            <div class="editor-column">
                <div class="editor-section-header">üéÅ What It Emits</div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Type</label>
                        <select id="mystery-block-template-emit-type" onchange="populateMysteryBlockEmitTemplates()">
                            <option value="collectible">Collectible</option>
                            <option value="powerup">Powerup</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Template</label>
                        <select id="mystery-block-template-emit-template">
                            <!-- Populated by JavaScript -->
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Item Count</label>
                        <input type="number" id="mystery-block-template-emit-count" value="1" min="1" max="99">
                    </div>
                    <div class="form-group">
                        <label>When Empty</label>
                        <select id="mystery-block-template-depleted-behavior">
                            <option value="solid">Becomes Solid</option>
                            <option value="disappear">Disappears</option>
                            <option value="infinite">Infinite Items</option>
                        </select>
                    </div>
                </div>

                <div class="editor-section-header">üéØ Physics</div>

                <div class="form-group">
                    <label>Emit Mode</label>
                    <select id="mystery-block-template-emit-mode" onchange="updateMysteryBlockEmitOptions()">
                        <option value="popup">Pop Up + Fall (Mario style)</option>
                        <option value="static">Static (no movement)</option>
                        <option value="moving">Move in Direction</option>
                    </select>
                </div>

                <div class="form-row">
                    <div id="mystery-block-direction-group" class="form-group" style="display: none;">
                        <label>Direction</label>
                        <select id="mystery-block-template-emit-direction">
                            <option value="up">Up</option>
                            <option value="left">Left</option>
                            <option value="right">Right</option>
                            <option value="random">Random L/R</option>
                        </select>
                    </div>
                    <div id="mystery-block-speed-group" class="form-group" style="display: none;">
                        <label>H. Speed</label>
                        <input type="number" id="mystery-block-template-emit-speed" value="3" min="1" max="20" step="0.5">
                    </div>
                    <div id="mystery-block-pop-height-group" class="form-group">
                        <label>Pop Height (px)</label>
                        <input type="number" id="mystery-block-template-emit-pop-height" value="32" min="8" max="128">
                    </div>
                </div>

                <div id="mystery-block-gravity-group" class="form-group" style="margin-top: 8px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="mystery-block-template-emit-gravity" checked style="width: 16px; height: 16px;">
                        <span>Apply Gravity (item falls after pop)</span>
                    </label>
                </div>

                <div class="editor-section-header">‚ú® Collection</div>

                <div class="form-group">
                    <label>Collection Mode</label>
                    <select id="mystery-block-template-collect-mode" onchange="updateMysteryBlockCollectOptions()">
                        <option value="instant">Instant (no visual)</option>
                        <option value="auto_after_anim">Auto After Animation</option>
                        <option value="manual">Manual (player touches)</option>
                    </select>
                </div>

                <div id="mystery-block-auto-delay-group" class="form-group" style="display: none;">
                    <label>Auto-collect Delay (ms)</label>
                    <input type="number" id="mystery-block-template-auto-collect-delay" value="500" min="100" max="3000" step="100">
                </div>
            </div>
        </div>

        <!-- Full Width: Sounds Section -->
        <div class="editor-full-width" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
            <div class="editor-section-header" style="margin-top: 0;">üîä Sounds</div>

            <div class="form-row">
                <div class="form-group" style="flex: 1;">
                    <label>Hit Sound (has items)</label>
                    <div class="input-with-browse" style="display: flex; gap: 4px; flex-wrap: wrap;">
                        <input type="text" id="mystery-block-template-hit-sound" placeholder="URL or sfx:id" style="flex: 1; min-width: 80px;" onchange="updateSoundButtonStates('mystery-block-template-hit-sound')">
                        <button type="button" class="browse-library-btn" onclick="openAssetPicker('mystery-block-template-hit-sound', 'sounds')">Browse</button>
                        <button type="button" class="browse-library-btn sfx-create-btn" onclick="openSoundEffectStudio('mystery-block-template-hit-sound', 'Mystery Block Hit')" style="background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);">üéµ Create</button>
                        <button type="button" class="browse-library-btn sfx-edit-btn" onclick="editSoundEffectStudio('mystery-block-template-hit-sound')" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); display: none;">‚úèÔ∏è Edit</button>
                        <button type="button" class="browse-library-btn sfx-preview-btn" onclick="testSoundFromInput('mystery-block-template-hit-sound')" style="background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); display: none;">‚ñ∂</button>
                        <button type="button" class="browse-library-btn sfx-unlink-btn" onclick="unlinkSoundEffectStudio('mystery-block-template-hit-sound')" style="background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%); display: none;">‚úï</button>
                    </div>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>Empty Hit Sound (depleted)</label>
                    <div class="input-with-browse" style="display: flex; gap: 4px; flex-wrap: wrap;">
                        <input type="text" id="mystery-block-template-empty-hit-sound" placeholder="URL or sfx:id" style="flex: 1; min-width: 80px;" onchange="updateSoundButtonStates('mystery-block-template-empty-hit-sound')">
                        <button type="button" class="browse-library-btn" onclick="openAssetPicker('mystery-block-template-empty-hit-sound', 'sounds')">Browse</button>
                        <button type="button" class="browse-library-btn sfx-create-btn" onclick="openSoundEffectStudio('mystery-block-template-empty-hit-sound', 'Mystery Block Empty')" style="background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);">üéµ Create</button>
                        <button type="button" class="browse-library-btn sfx-edit-btn" onclick="editSoundEffectStudio('mystery-block-template-empty-hit-sound')" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); display: none;">‚úèÔ∏è Edit</button>
                        <button type="button" class="browse-library-btn sfx-preview-btn" onclick="testSoundFromInput('mystery-block-template-empty-hit-sound')" style="background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); display: none;">‚ñ∂</button>
                        <button type="button" class="browse-library-btn sfx-unlink-btn" onclick="unlinkSoundEffectStudio('mystery-block-template-empty-hit-sound')" style="background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%); display: none;">‚úï</button>
                    </div>
                </div>
            </div>

            <!-- Particle Effects Section -->
            <div class="editor-section-header" style="margin-top: 15px;">‚ú® Particle Effect</div>
            <div class="form-group">
                <label>Hit Effect (when block is struck)</label>
                <div class="input-with-browse" style="display: flex; gap: 4px; flex-wrap: wrap;">
                    <input type="text" id="mystery-block-template-particle" placeholder="pfx:id" style="flex: 1; min-width: 100px;"
                        title="Particle effect when this mystery block is hit">
                    <button type="button" class="browse-library-btn pfx-create-btn" onclick="openParticleFXStudio('mystery-block-template-particle', 'Mystery Block Hit Effect', 'sparkle')" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);">‚ú® Create</button>
                    <button type="button" class="browse-library-btn pfx-edit-btn" onclick="editParticleFXStudio('mystery-block-template-particle')" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); display: none;">‚úèÔ∏è Edit</button>
                    <button type="button" class="browse-library-btn pfx-unlink-btn" onclick="unlinkParticleFXStudio('mystery-block-template-particle')" style="background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%); display: none;">‚úï</button>
                </div>
            </div>
        </div>

        <div class="modal-buttons">
            <button class="btn" onclick="saveMysteryBlockTemplate()">Save</button>
            <button class="btn" onclick="closeMysteryBlockTemplateEditor()">Cancel</button>
        </div>
    </div>
</div>

<!-- Goal Template Editor -->
<div class="template-editor" id="goal-template-editor">
    <div class="template-editor-content">
        <h3>Goal Settings <span class="help-icon" onclick="showHelp('objectTemplates')">?</span></h3>
        <p style="color: #888; font-size: 11px; margin-bottom: 15px;">Customize the goal flag appearance</p>
        <div class="form-row">
            <div class="form-group">
                <label>Sprite URL (optional)</label>
                <div class="input-with-browse">
                    <input type="text" id="goal-template-sprite" placeholder="https://...">
                    <button type="button" class="browse-library-btn" onclick="openAssetPicker('goal-template-sprite')">Browse</button>
                </div>
            </div>
            <div class="form-group" style="flex: 0.4; min-width: 60px;">
                <label>Cols</label>
                <input type="number" id="goal-template-cols" value="1" min="1" max="32" title="Frames per row">
            </div>
            <div class="form-group" style="flex: 0.4; min-width: 60px;">
                <label>Rows</label>
                <input type="number" id="goal-template-rows" value="1" min="1" max="16" title="Number of rows">
            </div>
            <div class="form-group" style="flex: 0.4; min-width: 60px;">
                <label>Speed</label>
                <input type="number" id="goal-template-animspeed" value="8" min="1" max="30" title="Animation speed: 1 = fastest, 30 = slowest">
                <span style="font-size:9px;color:#888;display:block;margin-top:2px;">1=fast ‚Üí 30=slow</span>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group" style="flex: 0.4;">
                <label>Width (px)</label>
                <input type="number" id="goal-template-width" value="32" min="8" max="128">
            </div>
            <div class="form-group" style="flex: 0.4;">
                <label>Height (px)</label>
                <input type="number" id="goal-template-height" value="32" min="8" max="128">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group" style="flex: 0.4;">
                <label>Symbol</label>
                <input type="text" id="goal-template-symbol" value="‚öë" maxlength="2">
            </div>
            <div class="form-group" style="flex: 0.4;">
                <label>Color</label>
                <input type="color" id="goal-template-color" value="#00ff00">
            </div>
        </div>
        <div class="form-group">
            <label>üîä Reach Sound</label>
            <div class="input-with-browse" style="display: flex; gap: 4px; flex-wrap: wrap;">
                <input type="text" id="goal-template-reach-sound" placeholder="URL or sfx:id" style="flex: 1; min-width: 120px;">
                <button type="button" class="browse-library-btn" onclick="openAssetPicker('goal-template-reach-sound', 'sounds')">Browse</button>
                <button type="button" class="browse-library-btn sfx-create-btn" onclick="openSoundEffectStudio('goal-template-reach-sound', 'Goal Reached')" style="background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);">üéµ Create</button>
                <button type="button" class="browse-library-btn sfx-edit-btn" onclick="editSoundEffectStudio('goal-template-reach-sound')" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); display: none;">‚úèÔ∏è Edit</button>
                <button type="button" class="browse-library-btn sfx-unlink-btn" onclick="unlinkSoundEffectStudio('goal-template-reach-sound')" style="background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%); display: none;">‚úï</button>
            </div>
        </div>
        <div class="form-group" style="margin-top: 15px;">
            <label>üéâ Goal Reached Particle Effect</label>
            <div class="input-with-browse" style="display: flex; gap: 4px; flex-wrap: wrap;">
                <input type="text" id="goal-template-particle" placeholder="pfx:id" style="flex: 1; min-width: 100px;"
                    title="Celebration particle effect when goal is reached">
                <button type="button" class="browse-library-btn pfx-create-btn" onclick="openParticleFXStudio('goal-template-particle', 'Goal Reached Effect', 'sparkle')" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);">‚ú® Create</button>
                <button type="button" class="browse-library-btn pfx-edit-btn" onclick="editParticleFXStudio('goal-template-particle')" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); display: none;">‚úèÔ∏è Edit</button>
                <button type="button" class="browse-library-btn pfx-unlink-btn" onclick="unlinkParticleFXStudio('goal-template-particle')" style="background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%); display: none;">‚úï</button>
            </div>
        </div>
        <div class="modal-buttons">
            <button class="btn" onclick="saveGoalTemplate()">Save</button>
            <button class="btn" onclick="closeGoalTemplateEditor()">Cancel</button>
        </div>
    </div>
</div>

<!-- Pixel Editor Modal (Custom Tiles) -->
<div class="template-editor" id="pixel-editor-modal">
    <div class="template-editor-content" style="width: 620px; max-height: 90vh; overflow-y: auto;">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
            <h3 id="pixel-editor-title" style="margin: 0;">Create Custom Tile</h3>
            <button class="pixel-help-btn" onclick="showPixelEditorHelp('overview')" title="Help">?</button>
        </div>

        <!-- Tile Name Row -->
        <div class="form-row" style="margin-bottom: 10px; gap: 8px;">
            <div class="form-group" style="flex: 1; margin-bottom: 0;">
                <input type="text" id="pixel-editor-name" placeholder="Tile name (e.g., Grass, Brick)" maxlength="32" style="padding: 6px 10px;">
            </div>
            <label style="display: flex; align-items: center; gap: 5px; font-size: 11px; color: #aaa; white-space: nowrap;">
                <input type="checkbox" id="pixel-editor-solid" checked style="width: auto; margin: 0;" onchange="updateHitboxVisibility()">
                Solid
            </label>
            <div id="pixel-editor-hitbox-container" style="display: flex; align-items: center; gap: 5px;">
                <select id="pixel-editor-hitbox" onchange="updateHitboxPreview()" style="padding: 4px 6px; font-size: 11px; background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.15); border-radius: 4px; color: #ddd;">
                    <option value="full">Full Tile</option>
                    <option value="top">Top Half</option>
                    <option value="bottom">Bottom Half</option>
                    <option value="left">Left Half</option>
                    <option value="right">Right Half</option>
                </select>
                <button class="pixel-help-btn small" onclick="showPixelEditorHelp('hitbox')" title="Hitbox Help">?</button>
            </div>
        </div>

        <!-- Color Picker Row - Always visible, not in scrollable area -->
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; padding: 8px 10px; background: rgba(0,0,0,0.25); border-radius: 6px;">
            <label style="font-size: 11px; color: #aaa; white-space: nowrap;">Color:</label>
            <div style="position: relative; display: flex; align-items: center; gap: 6px;">
                <input type="color" id="pixel-editor-color" value="#4a90d9" style="width: 48px; height: 36px; border: 2px solid rgba(255,255,255,0.2); border-radius: 6px; cursor: pointer; padding: 0;" title="Click to choose color">
                <div id="pixel-editor-color-preview" style="width: 36px; height: 36px; background: #4a90d9; border: 2px solid rgba(255,255,255,0.3); border-radius: 6px; box-shadow: inset 0 0 0 1px rgba(0,0,0,0.2);"></div>
                <span id="pixel-editor-color-hex" style="font-size: 11px; color: #888; font-family: monospace;">#4a90d9</span>
            </div>
        </div>

        <!-- Toolbar - Reorganized with labels -->
        <div style="display: flex; gap: 8px; margin-bottom: 10px; padding: 8px 10px; background: rgba(0,0,0,0.3); border-radius: 6px; align-items: flex-end; flex-wrap: wrap;">
            <button class="pixel-help-btn small" onclick="showPixelEditorHelp('tools')" title="Tools Help" style="align-self: center;">?</button>

            <!-- Draw Tools -->
            <div style="display: flex; flex-direction: column; gap: 2px;">
                <span style="font-size: 8px; color: #666; text-transform: uppercase; letter-spacing: 0.5px;">Draw</span>
                <div style="display: flex; gap: 2px; align-items: center;">
                    <button class="pixel-tool-btn active" id="tool-pencil" onclick="selectPixelTool('pencil')" title="Pencil (P)">‚úèÔ∏è</button>
                    <button class="pixel-tool-btn" id="tool-eraser" onclick="selectPixelTool('eraser')" title="Eraser (E)">üßπ</button>
                    <button class="pixel-tool-btn" id="tool-fill" onclick="selectPixelTool('fill')" title="Fill Bucket (F)">ü™£</button>
                    <button class="pixel-tool-btn" id="tool-eyedropper" onclick="selectPixelTool('eyedropper')" title="Eyedropper (I)">üíß</button>
                    <button class="pixel-tool-btn" id="tool-move" onclick="selectPixelTool('move')" title="Move (M) - Drag or Arrow Keys">‚úã</button>
                </div>
            </div>

            <div style="width: 1px; height: 36px; background: rgba(255,255,255,0.1); align-self: center;"></div>

            <!-- Shape Tools -->
            <div style="display: flex; flex-direction: column; gap: 2px;">
                <span style="font-size: 8px; color: #666; text-transform: uppercase; letter-spacing: 0.5px;">Shapes</span>
                <div style="display: flex; gap: 2px; align-items: center;">
                    <button class="pixel-tool-btn" id="tool-line" onclick="selectPixelTool('line')" title="Line (L)">üìè</button>
                    <button class="pixel-tool-btn" id="tool-rect" onclick="selectPixelTool('rect')" title="Rectangle (R)">‚¨ú</button>
                    <button class="pixel-tool-btn" id="tool-rect-fill" onclick="selectPixelTool('rect-fill')" title="Filled Rectangle (Shift+R)">üü¶</button>
                    <button class="pixel-tool-btn" id="tool-circle" onclick="selectPixelTool('circle')" title="Circle (C)">‚≠ï</button>
                    <button class="pixel-tool-btn" id="tool-circle-fill" onclick="selectPixelTool('circle-fill')" title="Filled Circle (Shift+C)">üîµ</button>
                </div>
            </div>

            <div style="width: 1px; height: 36px; background: rgba(255,255,255,0.1); align-self: center;"></div>

            <!-- Transform Tools -->
            <div style="display: flex; flex-direction: column; gap: 2px;">
                <span style="font-size: 8px; color: #666; text-transform: uppercase; letter-spacing: 0.5px;">Transform</span>
                <div style="display: flex; gap: 2px; align-items: center;">
                    <button class="pixel-tool-btn" onclick="flipHorizontal()" title="Flip Horizontal (H)">‚ÜîÔ∏è</button>
                    <button class="pixel-tool-btn" onclick="flipVertical()" title="Flip Vertical (V)">‚ÜïÔ∏è</button>
                    <button class="pixel-tool-btn" id="tool-mirror-toggle" onclick="toggleMirrorMode()" title="Mirror Mode OFF (W) - Click to enable symmetric drawing">ü™û</button>
                </div>
            </div>

            <div style="width: 1px; height: 36px; background: rgba(255,255,255,0.1); align-self: center;"></div>

            <!-- Edit Tools -->
            <div style="display: flex; flex-direction: column; gap: 2px;">
                <span style="font-size: 8px; color: #666; text-transform: uppercase; letter-spacing: 0.5px;">Edit</span>
                <div style="display: flex; gap: 2px; align-items: center;">
                    <button class="pixel-tool-btn" onclick="pixelEditorUndo()" title="Undo (Ctrl+Z)">‚Ü©Ô∏è</button>
                    <button class="pixel-tool-btn" onclick="pixelEditorRedo()" title="Redo (Ctrl+Y)">‚Ü™Ô∏è</button>
                    <button class="pixel-tool-btn" onclick="clearPixelCanvas()" title="Clear All">üóëÔ∏è</button>
                </div>
            </div>
        </div>

        <!-- Canvas & Preview Row -->
        <div style="display: flex; gap: 12px; margin-bottom: 10px;">
            <!-- Canvas -->
            <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                <canvas id="pixel-editor-canvas" width="256" height="256" style="
                    background: repeating-conic-gradient(#333 0% 25%, #444 0% 50%) 50% / 16px 16px;
                    border: 2px solid rgba(255,255,255,0.2);
                    border-radius: 4px;
                    cursor: crosshair;
                    image-rendering: pixelated;
                    width: 100%;
                    max-width: 288px;
                    aspect-ratio: 1;
                "></canvas>
                <div style="margin-top: 6px; font-size: 10px; color: #666;">
                    <span id="pixel-editor-size">16√ó16</span>px | Right-click to erase
                </div>
            </div>

            <!-- Preview & Used Colors Panel -->
            <div style="display: flex; flex-direction: column; gap: 8px; width: 100px;">
                <!-- Preview -->
                <div>
                    <label style="font-size: 9px; color: #666; text-transform: uppercase;">Preview</label>
                    <div style="display: flex; justify-content: center; align-items: center; height: 64px; background: repeating-conic-gradient(#222 0% 25%, #333 0% 50%) 50% / 8px 8px; border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; margin-top: 4px;">
                        <canvas id="pixel-editor-preview" width="32" height="32" style="image-rendering: pixelated;"></canvas>
                    </div>
                    <button class="pixel-tool-btn small" onclick="openTilePreviewModal()" title="Preview Tiling Pattern" style="width: 100%; margin-top: 4px; font-size: 10px; padding: 4px; color: #ddd;">üî≤ Tiling</button>
                </div>

                <!-- Used Colors -->
                <div>
                    <label style="font-size: 9px; color: #666; text-transform: uppercase;">Used Colors</label>
                    <div id="pixel-editor-used-colors" style="
                        display: flex;
                        flex-wrap: wrap;
                        gap: 3px;
                        margin-top: 4px;
                        padding: 6px;
                        background: rgba(0,0,0,0.3);
                        border: 1px solid rgba(255,255,255,0.1);
                        border-radius: 4px;
                        min-height: 32px;
                        max-height: 80px;
                        overflow-y: auto;
                    ">
                        <div style="font-size: 9px; color: #555; text-align: center; width: 100%;">Draw to see colors</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Animation Frames Section -->
        <div class="pixel-editor-frames-section">
            <!-- Animation Status -->
            <div class="pixel-editor-anim-header">
                <div style="display: flex; align-items: center; gap: 6px;">
                    <button class="pixel-help-btn small" onclick="showPixelEditorHelp('animation')" title="Animation Help">?</button>
                    <div id="pixel-editor-anim-status" style="font-size: 11px;">
                        <span style="color: #888;">Static Tile (1 frame)</span>
                    </div>
                </div>
                <div id="pixel-editor-fps-control" class="fps-control" style="display: none;">
                    <label style="font-size: 10px; color: #888;">Speed:</label>
                    <input type="range" id="pixel-editor-fps" min="1" max="24" value="8"
                           oninput="updatePixelEditorFps(this.value)" style="width: 60px; height: 4px;">
                    <span id="pixel-editor-fps-value" style="font-size: 10px; color: #aaa; min-width: 28px;">8 fps</span>
                </div>
            </div>

            <!-- Frame Strip -->
            <div class="pixel-editor-frame-strip-container">
                <div id="pixel-editor-frame-strip" class="pixel-editor-frame-strip">
                    <!-- Frame thumbnails will be added dynamically -->
                </div>
            </div>

            <!-- Frame Controls -->
            <div class="pixel-editor-frame-controls">
                <div class="frame-nav-controls">
                    <button class="pixel-tool-btn small" onclick="prevFrame()" title="Previous Frame (‚Üê)">‚óÄ</button>
                    <span id="pixel-editor-frame-counter" style="font-size: 11px; color: #aaa; min-width: 40px; text-align: center;">1 / 1</span>
                    <button class="pixel-tool-btn small" onclick="nextFrame()" title="Next Frame (‚Üí)">‚ñ∂</button>
                </div>
                <div class="frame-action-controls">
                    <button class="pixel-tool-btn small" onclick="addFrame()" title="Add New Frame">‚ûï</button>
                    <button class="pixel-tool-btn small" onclick="duplicateFrame()" title="Duplicate Frame">üìã</button>
                    <button class="pixel-tool-btn small" onclick="deleteFrame()" title="Delete Frame">üóëÔ∏è</button>
                    <div style="width: 1px; height: 20px; background: rgba(255,255,255,0.15); margin: 0 4px;"></div>
                    <button class="pixel-tool-btn small" id="pixel-editor-preview-btn" onclick="toggleAnimationPreview()" title="Preview Animation (Space)">‚ñ∂Ô∏è</button>
                    <button class="pixel-tool-btn small" id="pixel-editor-onion-btn" onclick="toggleOnionSkin()" title="Onion Skinning">üßÖ</button>
                </div>
            </div>

            <!-- Animation Help Text -->
            <div style="font-size: 9px; color: #555; text-align: center; margin-top: 6px;">
                üí° Add multiple frames to create an animated tile. Use ‚Üê ‚Üí to navigate frames.
            </div>
        </div>

        <!-- Tile Effects Section -->
        <div class="pixel-editor-effects-section">
            <div class="pixel-editor-effects-header">
                <div style="display: flex; align-items: center; gap: 6px;">
                    <button class="pixel-help-btn small" onclick="showPixelEditorHelp('effects')" title="Effects Help">?</button>
                    <span style="font-size: 11px; color: #888;">üåä Tile Motion Effect</span>
                </div>
                <span id="pixel-editor-effect-status" style="font-size: 10px; color: #555;">(None)</span>
            </div>

            <div class="pixel-editor-effects-grid">
                <!-- Effect Type -->
                <div class="effect-control">
                    <label>Effect:</label>
                    <select id="pixel-editor-effect-type" onchange="updateTileEffect()">
                        <option value="none">None (Static)</option>
                        <option value="sway">üåø Sway (Wind)</option>
                        <option value="pulse">üí´ Pulse (Glow)</option>
                        <option value="bounce">‚¨ÜÔ∏è Bounce</option>
                        <option value="float">‚òÅÔ∏è Float</option>
                        <option value="shimmer">‚ú® Shimmer</option>
                        <option value="wave">üåä Wave</option>
                        <option value="shake">üì≥ Shake</option>
                    </select>
                </div>

                <!-- Intensity -->
                <div class="effect-control">
                    <label>Intensity:</label>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <input type="range" id="pixel-editor-effect-intensity" min="1" max="10" value="5"
                               oninput="updateTileEffect()" style="flex: 1;">
                        <span id="pixel-editor-intensity-value" style="font-size: 10px; color: #aaa; min-width: 20px;">5</span>
                    </div>
                </div>

                <!-- Speed -->
                <div class="effect-control">
                    <label>Speed:</label>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <input type="range" id="pixel-editor-effect-speed" min="1" max="10" value="5"
                               oninput="updateTileEffect()" style="flex: 1;">
                        <span id="pixel-editor-speed-value" style="font-size: 10px; color: #aaa; min-width: 20px;">5</span>
                    </div>
                </div>

                <!-- Effect Preview -->
                <div class="effect-control" style="grid-column: span 1;">
                    <label>Preview:</label>
                    <div class="effect-preview-container">
                        <canvas id="pixel-editor-effect-preview" width="32" height="32"></canvas>
                        <button class="pixel-tool-btn small" id="effect-preview-btn" onclick="toggleEffectPreview()" title="Preview Effect">‚ñ∂Ô∏è</button>
                    </div>
                </div>
            </div>

            <div style="font-size: 9px; color: #555; text-align: center; margin-top: 6px;">
                üí° Motion effects add procedural movement without extra frames. Great for grass, water, crystals!
            </div>
        </div>

        <!-- Shortcuts & Buttons -->
        <div style="display: flex; gap: 10px; align-items: center;">
            <div style="flex: 1; font-size: 9px; color: #666;">
                <strong style="color: #888;">Keys:</strong> P E F I L R C M | Ctrl+Z/Y
            </div>
            <button class="btn" onclick="downloadCustomTilePNG()" style="padding: 6px 12px;" title="Download as PNG">‚¨áÔ∏è Download</button>
            <button class="btn" id="pixel-editor-save-btn" style="padding: 6px 16px;">Save</button>
            <button class="btn" onclick="closePixelEditor()" style="padding: 6px 12px;">Cancel</button>
        </div>
    </div>
</div>

<!-- Pixel Editor Help Modal -->
<div class="template-editor" id="pixel-editor-help-modal" style="z-index: 10001;">
    <div class="template-editor-content" style="width: 450px; max-height: 80vh; overflow-y: auto;">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
            <h3 id="pixel-help-title" style="margin: 0;">Help</h3>
            <button class="pixel-tool-btn" onclick="closePixelEditorHelp()" title="Close">&times;</button>
        </div>
        <div id="pixel-help-content">
            <!-- Content will be inserted dynamically -->
        </div>
        <div style="margin-top: 12px; text-align: right;">
            <button class="btn" onclick="closePixelEditorHelp()" style="padding: 6px 16px;">Got it!</button>
        </div>
    </div>
</div>

<!-- Tile Preview Modal (Tiling Pattern) -->
<div class="template-editor" id="tile-preview-modal" style="z-index: 10001;">
    <div class="template-editor-content" style="width: 380px; max-height: 90vh; overflow-y: auto;">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
            <h3 style="margin: 0;">üî≤ Tile Preview</h3>
            <button class="pixel-tool-btn" onclick="closeTilePreviewModal()" title="Close">&times;</button>
        </div>

        <p style="font-size: 11px; color: #aaa; margin-bottom: 12px;">
            See how your tile looks when repeated. Useful for creating seamless patterns.
        </p>

        <!-- Tiling Mode Selection -->
        <div style="display: flex; gap: 6px; margin-bottom: 12px;">
            <button class="pixel-tool-btn tile-mode-btn active" id="tile-mode-both" onclick="setTilePreviewMode('both')" title="3√ó3 Grid" style="flex: 1; padding: 10px 6px; font-size: 11px; color: #ddd;">
                ‚äû 3√ó3
            </button>
            <button class="pixel-tool-btn tile-mode-btn" id="tile-mode-horizontal" onclick="setTilePreviewMode('horizontal')" title="Horizontal (5√ó1)" style="flex: 1; padding: 10px 6px; font-size: 11px; color: #ddd;">
                ‚Üî 5√ó1
            </button>
            <button class="pixel-tool-btn tile-mode-btn" id="tile-mode-vertical" onclick="setTilePreviewMode('vertical')" title="Vertical (1√ó5)" style="flex: 1; padding: 10px 6px; font-size: 11px; color: #ddd;">
                ‚Üï 1√ó5
            </button>
        </div>

        <!-- Tile Preview Canvas -->
        <div style="display: flex; justify-content: center; margin-bottom: 12px;">
            <div style="background: repeating-conic-gradient(#222 0% 25%, #333 0% 50%) 50% / 8px 8px; border: 2px solid rgba(255,255,255,0.2); border-radius: 4px; padding: 8px;">
                <canvas id="tile-preview-canvas" width="192" height="192" style="image-rendering: pixelated; display: block;"></canvas>
            </div>
        </div>

        <!-- Zoom Control -->
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
            <label style="font-size: 11px; color: #bbb;">Zoom:</label>
            <input type="range" id="tile-preview-zoom" min="1" max="4" value="2" oninput="updateTilePreview()" style="flex: 1;">
            <span id="tile-preview-zoom-value" style="font-size: 11px; color: #ddd; min-width: 24px;">2√ó</span>
        </div>

        <!-- Close Button -->
        <div style="text-align: right;">
            <button class="btn" onclick="closeTilePreviewModal()" style="padding: 6px 16px;">Close</button>
        </div>
    </div>
</div>

<!-- Game Settings Modal (Game-wide settings) -->
<div class="modal-overlay template-modal" id="game-properties-modal" onclick="if(event.target === this) closeGamePropertiesModal()">
    <div class="modal template-editor-modal" style="max-width: 550px; max-height: 80vh; display: flex; flex-direction: column;">
        <div class="modal-header" style="flex-shrink: 0;">
            <h2>‚öôÔ∏è Game Settings</h2>
            <button class="modal-close-btn" onclick="closeGamePropertiesModal()">&times;</button>
        </div>
        <div class="game-settings-container">
            <!-- Left Navigation -->
            <div class="game-settings-nav">
                <button class="game-settings-nav-item active" data-section="gametype" onclick="showGameSettingsSection('gametype')">
                    <span class="nav-icon">üéÆ</span>
                    <span class="nav-label">Game Type</span>
                </button>
                <button class="game-settings-nav-item" data-section="gamefeel" onclick="showGameSettingsSection('gamefeel')">
                    <span class="nav-icon">‚ú®</span>
                    <span class="nav-label">Game Feel</span>
                </button>
                <button class="game-settings-nav-item" data-section="rules" onclick="showGameSettingsSection('rules')">
                    <span class="nav-icon">üìã</span>
                    <span class="nav-label">Rules</span>
                </button>
                <button class="game-settings-nav-item" data-section="volume" onclick="showGameSettingsSection('volume')">
                    <span class="nav-icon">üîä</span>
                    <span class="nav-label">Volume</span>
                </button>
                <button class="game-settings-nav-item" data-section="particles" onclick="showGameSettingsSection('particles')">
                    <span class="nav-icon">üí´</span>
                    <span class="nav-label">Particles</span>
                </button>
                <button class="game-settings-nav-item topdown-only" data-section="multiplayer" onclick="showGameSettingsSection('multiplayer')" style="display: none;">
                    <span class="nav-icon">üåê</span>
                    <span class="nav-label" style="white-space: nowrap;">Online <span style="font-size: 6px; background: #f39c12; color: #000; padding: 1px 3px; border-radius: 2px;">BETA</span></span>
                </button>
                <button class="game-settings-nav-item" data-section="cheats" onclick="showGameSettingsSection('cheats'); updateCheatsUI();">
                    <span class="nav-icon">üéÆ</span>
                    <span class="nav-label">Cheats</span>
                </button>
            </div>

            <!-- Right Content Panel -->
            <div class="game-settings-content">
                <!-- Game Type Section -->
                <div class="game-settings-section active" id="game-settings-section-gametype">
                    <h3 style="color: #e94560; font-size: 14px; margin: 0 0 12px 0;">Game Type <span class="help-icon" onclick="event.stopPropagation(); showHelp('gameType')">?</span></h3>
                    <p style="font-size: 10px; color: #888; margin-bottom: 15px;">Choose the camera perspective and gameplay style for your game.</p>

                    <div style="display: flex; gap: 12px; margin-bottom: 15px;">
                        <button class="game-type-btn active" id="game-type-platformer" onclick="setGameType('platformer')"
                            style="flex: 1; padding: 15px 10px; background: linear-gradient(135deg, #e94560, #ff6b6b); border: 2px solid transparent; border-radius: 10px; cursor: pointer; transition: all 0.2s; text-align: center; color: #fff;">
                            <div style="font-size: 28px; margin-bottom: 6px;">üèÉ</div>
                            <div style="font-weight: bold; font-size: 12px;">Platformer</div>
                            <div style="font-size: 9px; opacity: 0.8; margin-top: 4px;">Side-scrolling</div>
                        </button>
                        <button class="game-type-btn" id="game-type-topdown" onclick="setGameType('topdown')"
                            style="flex: 1; padding: 15px 10px; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); border-radius: 10px; cursor: pointer; transition: all 0.2s; text-align: center; color: #fff;">
                            <div style="font-size: 28px; margin-bottom: 6px;">üó∫Ô∏è</div>
                            <div style="font-weight: bold; font-size: 12px;">Top-Down RPG</div>
                            <div style="font-size: 9px; opacity: 0.8; margin-top: 4px;">Bird's eye view</div>
                        </button>
                    </div>

                    <div id="game-type-description" style="padding: 12px; background: rgba(0,0,0,0.3); border-radius: 8px; font-size: 11px; color: #aaa; line-height: 1.5;">
                        Side-scrolling platformer with gravity, jumping, and physics.
                    </div>

                    <!-- In-Modal Game Type Switch Confirmation -->
                    <div id="game-type-confirm-panel" style="display: none; margin-top: 15px; padding: 15px; background: linear-gradient(135deg, rgba(255, 107, 107, 0.15), rgba(233, 69, 96, 0.25)); border: 2px solid #e94560; border-radius: 10px; animation: confirmPanelFadeIn 0.2s ease-out;">
                        <div style="display: flex; align-items: flex-start; gap: 10px; margin-bottom: 12px;">
                            <span style="font-size: 20px;">‚ö†Ô∏è</span>
                            <div>
                                <div style="font-weight: bold; color: #ff6b6b; font-size: 12px; margin-bottom: 4px;">Switching Game Mode</div>
                                <div id="game-type-confirm-target" style="font-size: 11px; color: #ccc;"></div>
                            </div>
                        </div>
                        <div id="game-type-confirm-warnings" style="background: rgba(0,0,0,0.3); border-radius: 6px; padding: 10px; margin-bottom: 12px; font-size: 10px; color: #ffaa00; line-height: 1.6;"></div>
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button onclick="cancelGameTypeSwitch()" style="padding: 8px 16px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: #aaa; font-size: 11px; cursor: pointer; transition: all 0.2s;">Cancel</button>
                            <button onclick="confirmGameTypeSwitch()" style="padding: 8px 16px; background: linear-gradient(135deg, #e94560, #ff6b6b); border: none; border-radius: 6px; color: #fff; font-size: 11px; font-weight: bold; cursor: pointer; transition: all 0.2s;">Switch Mode</button>
                        </div>
                    </div>

                    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                        <h4 style="color: #888; font-size: 11px; margin: 0 0 10px 0; text-transform: uppercase; letter-spacing: 1px;">Mode Features</h4>
                        <div class="platformer-only" style="font-size: 10px; color: #aaa;">
                            <div style="margin-bottom: 6px;">‚úì Gravity & jumping physics</div>
                            <div style="margin-bottom: 6px;">‚úì Left/right movement</div>
                            <div style="margin-bottom: 6px;">‚úì Enemy stomping</div>
                            <div style="margin-bottom: 6px;">‚úì Springs & trampolines</div>
                        </div>
                        <div class="topdown-only" style="font-size: 10px; color: #aaa; display: none;">
                            <div style="margin-bottom: 6px;">‚úì 8-direction movement</div>
                            <div style="margin-bottom: 6px;">‚úì NPCs with dialogue</div>
                            <div style="margin-bottom: 6px;">‚úì Doors & teleporters</div>
                            <div style="margin-bottom: 6px;">‚úì Speed boost pads</div>
                        </div>
                    </div>

                    <!-- Tile Render Scale -->
                    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                        <h4 style="color: #888; font-size: 11px; margin: 0 0 10px 0; text-transform: uppercase; letter-spacing: 1px;">Display Scale</h4>
                        <p style="font-size: 10px; color: #666; margin-bottom: 10px;">Scale up tiles for a chunkier pixel art look. Your 16√ó16 tiles can appear as 32√ó32 or 64√ó64 in-game.</p>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label style="font-size: 11px;">Tile Render Scale</label>
                            <select id="setting-tile-render-scale" onchange="updateGameSetting('tileRenderScale', parseInt(this.value))" style="width: 100%; padding: 8px; background: #1a1a2e; border: 1px solid #0f3460; border-radius: 6px; color: #fff; font-size: 12px;">
                                <option value="1">1√ó (Original size)</option>
                                <option value="2">2√ó (Double size)</option>
                                <option value="4">4√ó (Quadruple size)</option>
                            </select>
                            <div style="font-size: 9px; color: #666; margin-top: 6px;">
                                Example: 16√ó16 tiles ‚Üí <span id="tile-scale-preview">16√ó16</span> in-game
                            </div>
                        </div>
                    </div>
                </div><!-- End Game Type Section -->

                <!-- Rules Section -->
                <div class="game-settings-section" id="game-settings-section-rules">
                    <h3 style="color: #e94560; font-size: 14px; margin: 0 0 12px 0;">Game Rules <span class="help-icon" onclick="showHelp('gameRules')">?</span></h3>
                    <div class="form-group">
                        <label>Starting Lives</label>
                        <input type="number" id="setting-lives" value="3" min="1" max="10" onchange="updateGameSetting('startLives', this.value)">
                        <small style="color: #666; font-size: 9px;">How many lives player starts with</small>
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="setting-mobile-controls" checked onchange="updateGameSetting('enableMobileControls', this.checked); updateMobileSummary();">
                            <span style="margin-left: 8px;">Enable Mobile Controls</span>
                        </label>
                        <small style="color: #666; font-size: 9px;">Show touch buttons on mobile devices</small>
                    </div>
                </div><!-- End Rules Section -->

                <!-- Volume Section -->
                <div class="game-settings-section" id="game-settings-section-volume">
                    <h3 style="color: #e94560; font-size: 14px; margin: 0 0 12px 0;">Volume Settings <span class="help-icon" onclick="showHelp('sounds')">?</span></h3>
                    <div class="form-group">
                        <label>Master Volume <span id="master-volume-display" style="color: #888; font-size: 11px;">100%</span></label>
                        <input type="range" id="setting-master-volume" value="100" min="0" max="100" step="5"
                            style="width: 100%; accent-color: #e94560;"
                            oninput="updateVolumeDisplay('master', this.value); updateGameSetting('masterVolume', this.value / 100)">
                        <small style="color: #666; font-size: 9px;">Controls overall game volume</small>
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label>Music Volume <span id="music-volume-display" style="color: #888; font-size: 11px;">50%</span></label>
                        <input type="range" id="setting-music-volume" value="50" min="0" max="100" step="5"
                            style="width: 100%; accent-color: #9b59b6;"
                            oninput="updateVolumeDisplay('music', this.value); updateGameSetting('musicVolume', this.value / 100)">
                        <small style="color: #666; font-size: 9px;">Background music</small>
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label>SFX Volume <span id="sfx-volume-display" style="color: #888; font-size: 11px;">70%</span></label>
                        <input type="range" id="setting-sfx-volume" value="70" min="0" max="100" step="5"
                            style="width: 100%; accent-color: #3498db;"
                            oninput="updateVolumeDisplay('sfx', this.value); updateGameSetting('sfxVolume', this.value / 100)">
                        <small style="color: #666; font-size: 9px;">Sound effects</small>
                    </div>
                </div><!-- End Volume Section -->

                <!-- Multiplayer Section (Experimental - Top-Down Only) -->
                <div class="game-settings-section topdown-only" id="game-settings-section-multiplayer" style="display: none;">
                    <h3 style="color: #e94560; font-size: 14px; margin: 0 0 12px 0;">Online Multiplayer <span class="help-icon" onclick="showHelp('multiplayer')">?</span></h3>

                    <!-- Experimental Warning Banner -->
                    <div style="background: linear-gradient(135deg, rgba(243, 156, 18, 0.2), rgba(230, 126, 34, 0.2)); border: 2px solid #f39c12; border-radius: 10px; padding: 12px; margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 20px;">üß™</span>
                            <div>
                                <div style="font-weight: bold; color: #f39c12; font-size: 12px;">Experimental Feature</div>
                                <div style="font-size: 10px; color: #ccc; line-height: 1.4;">
                                    Multiplayer is in early testing. Expect bugs and changes.
                                    Only works with Top-Down RPG games.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Enable Toggle -->
                    <div class="form-group">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="setting-multiplayer-enabled"
                                   onchange="toggleMultiplayer(this.checked)"
                                   style="width: 16px; height: 16px; margin-right: 8px;">
                            <span style="font-weight: bold; font-size: 12px;">üåê Enable Multiplayer</span>
                        </label>
                        <small style="color: #888; margin-top: 4px; display: block;">Allow other players to join your game online</small>
                    </div>

                    <!-- Settings (shown when enabled) -->
                    <div id="multiplayer-settings-panel" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                        <!-- Max Players -->
                        <div class="form-group">
                            <label>Max Players</label>
                            <input type="range" id="setting-multiplayer-max-players"
                                   min="2" max="12" value="4" step="1"
                                   style="width: 100%; accent-color: #667eea;"
                                   oninput="updateGameSetting('multiplayerMaxPlayers', this.value); document.getElementById('max-players-display').textContent = this.value;">
                            <div style="display: flex; justify-content: space-between; font-size: 10px; color: #888; margin-top: 4px;">
                                <span>2</span>
                                <span id="max-players-display" style="color: #667eea; font-weight: bold;">4</span>
                                <span>12</span>
                            </div>
                        </div>

                        <!-- Player Name -->
                        <div class="form-group" style="margin-top: 12px;">
                            <label>Your Display Name</label>
                            <input type="text" id="setting-multiplayer-player-name"
                                   placeholder="Player" maxlength="20"
                                   style="width: 100%; padding: 8px 10px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: #fff; font-size: 12px;"
                                   onchange="updateGameSetting('multiplayerPlayerName', this.value)">
                            <small style="color: #666; font-size: 9px;">Shown to other players (max 20 characters)</small>
                        </div>

                        <!-- Options -->
                        <div class="form-group" style="margin-top: 12px;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" id="setting-multiplayer-show-chat" checked
                                       style="width: 14px; height: 14px; margin-right: 8px;"
                                       onchange="updateGameSetting('multiplayerShowChat', this.checked)">
                                <span style="font-size: 11px;">üí¨ Show Chat</span>
                            </label>
                        </div>

                        <div class="form-group" style="margin-top: 8px;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" id="setting-multiplayer-sync-items" checked
                                       style="width: 14px; height: 14px; margin-right: 8px;"
                                       onchange="updateGameSetting('multiplayerSyncItems', this.checked)">
                                <span style="font-size: 11px;">üéÅ Sync Item Collection</span>
                            </label>
                            <small style="color: #666; font-size: 9px; margin-left: 22px; display: block;">First player to collect an item gets it</small>
                        </div>

                        <div class="form-group" style="margin-bottom: 8px;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" id="setting-multiplayer-sync-enemies" checked
                                       style="width: 14px; height: 14px; margin-right: 8px;"
                                       onchange="updateGameSetting('multiplayerSyncEnemies', this.checked)">
                                <span style="font-size: 11px;">üëæ Sync Enemy Deaths</span>
                            </label>
                            <small style="color: #666; font-size: 9px; margin-left: 22px; display: block;">When one player kills an enemy, it dies for everyone</small>
                        </div>

                        <!-- PvP Battle Mode -->
                        <div style="border-top: 1px solid rgba(255,255,255,0.1); margin-top: 15px; padding-top: 15px;">
                            <div class="form-group">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="setting-multiplayer-pvp-enabled"
                                           style="width: 14px; height: 14px; margin-right: 8px;"
                                           onchange="togglePvPSettings(this.checked)">
                                    <span style="font-size: 11px;">‚öîÔ∏è PvP Battle Mode</span>
                                    <span style="background: #e74c3c; color: #fff; padding: 1px 5px; border-radius: 3px; font-size: 8px; margin-left: 6px;">NEW</span>
                                    <span class="help-icon" onclick="event.stopPropagation(); showHelp('pvp')" style="margin-left: 6px;">?</span>
                                </label>
                                <small style="color: #666; font-size: 9px; margin-left: 22px; display: block;">Players can shoot and damage each other</small>
                            </div>

                            <!-- PvP Settings Panel (hidden by default) -->
                            <div id="pvp-settings-panel" style="display: none; margin-top: 12px; padding: 10px; background: rgba(231,76,60,0.1); border: 1px solid rgba(231,76,60,0.3); border-radius: 6px;">
                                <div style="color: #e74c3c; font-size: 10px; font-weight: bold; margin-bottom: 10px;">‚öîÔ∏è PvP SETTINGS</div>

                                <!-- Damage Per Hit -->
                                <div class="form-group" style="margin-bottom: 10px;">
                                    <label style="font-size: 10px; color: #aaa;">Damage Per Hit (Hearts)</label>
                                    <input type="range" id="setting-multiplayer-pvp-damage"
                                           min="1" max="10" value="1" step="1"
                                           style="width: 100%; accent-color: #e74c3c;"
                                           oninput="updateGameSetting('multiplayerPvPDamage', this.value); document.getElementById('pvp-damage-display').textContent = this.value;">
                                    <div style="display: flex; justify-content: space-between; font-size: 9px; color: #666;">
                                        <span>1</span>
                                        <span id="pvp-damage-display" style="color: #e74c3c; font-weight: bold;">1</span>
                                        <span>10</span>
                                    </div>
                                </div>

                                <!-- Kill Score -->
                                <div class="form-group" style="margin-bottom: 10px;">
                                    <label style="font-size: 10px; color: #aaa;">Points for Elimination</label>
                                    <input type="range" id="setting-multiplayer-pvp-kill-score"
                                           min="0" max="500" value="100" step="25"
                                           style="width: 100%; accent-color: #e74c3c;"
                                           oninput="updateGameSetting('multiplayerPvPKillScore', this.value); document.getElementById('pvp-kill-score-display').textContent = this.value;">
                                    <div style="display: flex; justify-content: space-between; font-size: 9px; color: #666;">
                                        <span>0</span>
                                        <span id="pvp-kill-score-display" style="color: #e74c3c; font-weight: bold;">100</span>
                                        <span>500</span>
                                    </div>
                                </div>

                                <!-- Starting Lives -->
                                <div class="form-group">
                                    <label style="font-size: 10px; color: #aaa;">Starting Lives</label>
                                    <input type="range" id="setting-multiplayer-pvp-lives"
                                           min="1" max="10" value="3" step="1"
                                           style="width: 100%; accent-color: #e74c3c;"
                                           oninput="updateGameSetting('multiplayerPvPLives', this.value); document.getElementById('pvp-lives-display').textContent = this.value;">
                                    <div style="display: flex; justify-content: space-between; font-size: 9px; color: #666;">
                                        <span>1</span>
                                        <span id="pvp-lives-display" style="color: #e74c3c; font-weight: bold;">3</span>
                                        <span>10</span>
                                    </div>
                                </div>

                                <div style="font-size: 9px; color: #888; margin-top: 10px; line-height: 1.4;">
                                    üíÄ When a player loses all lives, they respawn with score reset.<br>
                                    üèÜ Leaderboard shows lives remaining next to scores.
                                </div>
                            </div>
                        </div>

                        <!-- Custom Player Sprites -->
                        <div style="margin-top: 15px; padding: 12px; background: rgba(155, 89, 182, 0.1); border: 1px solid rgba(155, 89, 182, 0.3); border-radius: 8px;">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin-bottom: 8px;">
                                <input type="checkbox" id="setting-multiplayer-custom-sprites" onchange="updateGameSetting('multiplayerAllowCustomSprites', this.checked)" style="width: 18px; height: 18px;">
                                <div>
                                    <div style="font-weight: bold; color: #fff;">üé® Allow Custom Player Sprites</div>
                                    <div style="font-size: 10px; color: #888;">Players can enter their own sprite URL when joining</div>
                                </div>
                            </label>
                            <div style="font-size: 9px; color: #9b59b6; line-height: 1.4; margin-top: 8px;">
                                When enabled, the join dialog will show fields for players to paste a sprite image URL and specify animation frames. Custom sprites are scaled to fit your game's player size.
                            </div>
                        </div>

                        <!-- Info Panel -->
                        <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 10px; margin-top: 15px;">
                            <div style="font-size: 10px; color: #aaa; line-height: 1.5;">
                                <strong style="color: #667eea;">How it works:</strong>
                                <ul style="margin: 6px 0 0 0; padding-left: 16px;">
                                    <li>When you play test, a room code will be generated</li>
                                    <li>Share the code with friends to let them join</li>
                                    <li>Each player sees others moving in real-time</li>
                                    <li>Server validates movements to prevent cheating</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div><!-- End Multiplayer Section -->

                <!-- Cheats Section -->
                <div class="game-settings-section" id="game-settings-section-cheats">
                    <h3 style="color: #e94560; font-size: 14px; margin: 0 0 8px 0;">üéÆ Cheat Codes <span class="help-icon" onclick="event.stopPropagation(); showHelp('cheats')">?</span></h3>
                    <p style="font-size: 10px; color: #888; margin-bottom: 15px;">Enable secret codes that players can type during gameplay for special effects. Great for adding replayability!</p>

                    <!-- Master Toggle -->
                    <div style="padding: 12px; background: rgba(233, 69, 96, 0.1); border: 1px solid rgba(233, 69, 96, 0.3); border-radius: 8px; margin-bottom: 15px;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="setting-cheats-enabled" onchange="updateGameSetting('cheatsEnabled', this.checked)" style="width: 18px; height: 18px;">
                            <div>
                                <div style="font-weight: bold; color: #fff;">Enable Cheat Codes</div>
                                <div style="font-size: 10px; color: #888;">Players can type codes during gameplay to activate effects</div>
                            </div>
                        </label>
                    </div>

                    <!-- Feedback Toggle -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 11px;">
                            <input type="checkbox" id="setting-cheat-feedback" onchange="updateGameSetting('cheatFeedbackEnabled', this.checked)" checked style="width: 14px; height: 14px;">
                            <span>Show "CHEAT ACTIVATED!" message</span>
                        </label>
                    </div>

                    <!-- Cheat Codes List -->
                    <div style="margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <h4 style="color: #888; font-size: 11px; margin: 0; text-transform: uppercase; letter-spacing: 1px;">Available Cheats</h4>
                            <button class="btn btn-small" onclick="showAddCheatCode()" style="padding: 4px 10px; font-size: 10px;">+ Add Custom</button>
                        </div>
                        <div id="cheat-codes-list" style="max-height: 250px; overflow-y: auto; padding-right: 5px;">
                            <!-- Populated by renderCheatCodesList() -->
                        </div>
                    </div>

                    <!-- Help Text -->
                    <div style="padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px; font-size: 10px; color: #888;">
                        <div style="margin-bottom: 6px;"><strong>How it works:</strong></div>
                        <ul style="margin: 0; padding-left: 16px; line-height: 1.6;">
                            <li>Players type the code during gameplay (no input box needed)</li>
                            <li>Codes can be letters (IDDQD) or arrows (‚Üë‚Üë‚Üì‚Üì‚Üê‚Üí‚Üê‚ÜíBA)</li>
                            <li>Effects can be timed (30s) or permanent</li>
                            <li>Codes are secret - share them to reward players!</li>
                        </ul>
                    </div>
                </div><!-- End Cheats Section -->

                <!-- Game Feel Section -->
                <div class="game-settings-section" id="game-settings-section-gamefeel">
                    <h3 style="color: #e94560; font-size: 14px; margin: 0 0 8px 0;">Quick Presets <span class="help-icon" onclick="event.stopPropagation(); showHelp('gameFeel')">?</span></h3>
                    <p style="font-size: 10px; color: #888; margin-bottom: 10px;">Click a preset to apply its settings. Watch the values change below!</p>

                    <!-- Platformer Presets -->
                    <div class="preset-grid platformer-only" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 15px;">
                        <div class="preset-card" onclick="applyGameFeelPreset('balanced'); showPresetDetails('balanced');" style="background: linear-gradient(135deg, #3498db, #2980b9); padding: 10px 8px; border-radius: 6px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; text-align: center;">
                            <div style="font-size: 18px;">‚öñÔ∏è</div>
                            <div style="font-weight: bold; font-size: 11px;">Balanced</div>
                        </div>
                        <div class="preset-card" onclick="applyGameFeelPreset('floaty'); showPresetDetails('floaty');" style="background: linear-gradient(135deg, #e91e63, #c2185b); padding: 10px 8px; border-radius: 6px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; text-align: center;">
                            <div style="font-size: 18px;">‚òÅÔ∏è</div>
                            <div style="font-weight: bold; font-size: 11px;">Floaty</div>
                        </div>
                        <div class="preset-card" onclick="applyGameFeelPreset('tight'); showPresetDetails('tight');" style="background: linear-gradient(135deg, #9b59b6, #8e44ad); padding: 10px 8px; border-radius: 6px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; text-align: center;">
                            <div style="font-size: 18px;">‚ö°</div>
                            <div style="font-weight: bold; font-size: 11px;">Tight</div>
                        </div>
                        <div class="preset-card" onclick="applyGameFeelPreset('heavy'); showPresetDetails('heavy');" style="background: linear-gradient(135deg, #607d8b, #455a64); padding: 10px 8px; border-radius: 6px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; text-align: center;">
                            <div style="font-size: 18px;">üè∞</div>
                            <div style="font-weight: bold; font-size: 11px;">Heavy</div>
                        </div>
                        <div class="preset-card" onclick="applyGameFeelPreset('bouncy'); showPresetDetails('bouncy');" style="background: linear-gradient(135deg, #ff9800, #f57c00); padding: 10px 8px; border-radius: 6px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; text-align: center;">
                            <div style="font-size: 18px;">üîµ</div>
                            <div style="font-weight: bold; font-size: 11px;">Bouncy</div>
                        </div>
                        <div class="preset-card" onclick="applyGameFeelPreset('flappy'); showPresetDetails('flappy');" style="background: linear-gradient(135deg, #4caf50, #388e3c); padding: 10px 8px; border-radius: 6px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; text-align: center;">
                            <div style="font-size: 18px;">üê¶</div>
                            <div style="font-weight: bold; font-size: 11px;">Flappy</div>
                        </div>
                    </div>

                    <!-- Top-Down RPG Presets -->
                    <div class="preset-grid topdown-only" style="display: none; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 15px;">
                        <div class="preset-card" onclick="applyGameFeelPreset('topdown_rpg'); showPresetDetails('topdown_rpg');" style="background: linear-gradient(135deg, #27ae60, #1e8449); padding: 10px 8px; border-radius: 6px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; text-align: center;">
                            <div style="font-size: 18px;">üó∫Ô∏è</div>
                            <div style="font-weight: bold; font-size: 11px;">RPG</div>
                        </div>
                        <div class="preset-card" onclick="applyGameFeelPreset('topdown_action'); showPresetDetails('topdown_action');" style="background: linear-gradient(135deg, #e74c3c, #c0392b); padding: 10px 8px; border-radius: 6px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; text-align: center;">
                            <div style="font-size: 18px;">üéØ</div>
                            <div style="font-weight: bold; font-size: 11px;">Action</div>
                        </div>
                        <div class="preset-card" onclick="applyGameFeelPreset('topdown_zelda'); showPresetDetails('topdown_zelda');" style="background: linear-gradient(135deg, #f39c12, #d68910); padding: 10px 8px; border-radius: 6px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; text-align: center;">
                            <div style="font-size: 18px;">‚öîÔ∏è</div>
                            <div style="font-weight: bold; font-size: 11px;">Zelda</div>
                        </div>
                    </div>

                    <!-- Preset Details Panel -->
                    <div id="preset-details-panel" style="display: none; margin-bottom: 15px; padding: 12px; background: rgba(0,0,0,0.3); border-radius: 8px; border-left: 3px solid #e94560;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span id="preset-details-title" style="font-weight: bold; font-size: 13px; color: #e94560;"></span>
                            <span style="font-size: 9px; color: #2ecc71;">‚úì Applied</span>
                        </div>
                        <p id="preset-details-description" style="font-size: 10px; color: #aaa; margin-bottom: 10px; line-height: 1.4;"></p>
                        <div id="preset-details-values" style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; font-size: 9px;"></div>
                    </div>

                    <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
                        <h4 style="color: #888; font-size: 11px; margin: 0 0 12px 0; text-transform: uppercase; letter-spacing: 1px;">Fine-Tune Settings</h4>
                    </div>

                    <div class="form-group">
                        <label>Invincibility Time (ms)</label>
                        <input type="number" id="setting-invincibility-time" value="1500" min="0" max="5000" step="100"
                            onchange="updateGameSetting('invincibilityTime', this.value)">
                        <small style="color: #666; font-size: 9px;">How long player is immune after damage (0 = disabled)</small>
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="setting-screen-shake" checked onchange="updateGameSetting('screenShakeEnabled', this.checked)">
                            <span style="margin-left: 8px;">Screen Shake</span>
                        </label>
                        <small style="color: #666; font-size: 9px;">Shake screen on damage/stomp</small>
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="setting-vibration" checked onchange="updateGameSetting('vibrationEnabled', this.checked)">
                            <span style="margin-left: 8px;">Vibration Feedback</span>
                        </label>
                        <small style="color: #666; font-size: 9px;">Haptic feedback on events (Android only - where available)</small>
                    </div>
                    <div class="form-group platformer-only" style="margin-top: 15px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="setting-run-timer" onchange="updateGameSetting('runTimerEnabled', this.checked); document.getElementById('run-timer-options').style.display = this.checked ? 'block' : 'none';">
                            <span style="margin-left: 8px;">‚è±Ô∏è Show Run Timer</span>
                        </label>
                        <small style="color: #666; font-size: 9px;">Display elapsed time for speedrunning</small>
                        <div id="run-timer-options" style="display: none; margin-top: 8px; margin-left: 20px;">
                            <label style="font-size: 11px; color: #888;">Timer Mode:</label>
                            <select id="setting-run-timer-mode" style="margin-left: 5px; padding: 2px 5px; font-size: 11px; background: #2a2a3e; color: #fff; border: 1px solid #444; border-radius: 4px;"
                                    onchange="updateGameSetting('runTimerMode', this.value)">
                                <option value="level">Per Level (resets each level)</option>
                                <option value="cumulative">Cumulative (total game time)</option>
                            </select>
                        </div>
                    </div>

                    <!-- RPG Progress Saving (Top-Down only) -->
                    <div class="form-group topdown-only" style="margin-top: 15px; padding: 12px; background: rgba(155, 89, 182, 0.1); border-radius: 8px; border: 1px solid rgba(155, 89, 182, 0.3);">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="setting-save-rpg-progress" checked onchange="updateGameSetting('saveRPGProgress', this.checked)">
                            <span style="margin-left: 8px;">üíæ Save Progress (localStorage)</span>
                        </label>
                        <small style="color: #9b59b6; font-size: 9px;">Inventory & checkpoints persist between sessions</small>
                    </div>

                    <div style="border-top: 1px solid rgba(255,255,255,0.1); margin-top: 18px; padding-top: 15px;">
                        <div class="form-group">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" id="setting-hit-pause" checked onchange="updateGameSetting('hitPauseEnabled', this.checked); toggleHitPauseOptions();">
                                <span style="margin-left: 8px;">Hit Pause (Freeze Frame)</span>
                            </label>
                            <small style="color: #666; font-size: 9px;">Brief freeze on damage/stomp for impact</small>
                        </div>
                        <div id="hit-pause-options" style="margin-top: 10px; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 6px;">
                            <div class="form-group">
                                <label>Pause Duration (ms)</label>
                                <input type="number" id="setting-hit-pause-duration" value="80" min="20" max="200" step="10"
                                    onchange="updateGameSetting('hitPauseDuration', this.value)">
                                <small style="color: #666; font-size: 9px;">50-100ms feels snappy, 100-150ms feels heavy</small>
                            </div>
                        </div>
                    </div>

                    <div class="platformer-only" style="border-top: 1px solid rgba(255,255,255,0.1); margin-top: 18px; padding-top: 15px;">
                        <div class="form-group">
                            <label>Coyote Time <span id="coyote-time-display" style="color: #888; font-size: 11px;">6 frames</span></label>
                            <input type="range" id="setting-coyote-time" value="6" min="0" max="15" step="1"
                                style="width: 100%; accent-color: #9b59b6;"
                                oninput="updateCoyoteTimeDisplay(this.value); updateGameSetting('coyoteTimeFrames', this.value)">
                            <small style="color: #666; font-size: 9px;">Frames to jump after walking off ledge (0 = strict, 6 = normal, 10+ = forgiving)</small>
                        </div>
                    </div>
                </div><!-- End Game Feel Section -->

                <!-- Particles Section -->
                <div class="game-settings-section" id="game-settings-section-particles">
                    <h3 style="color: #e94560; font-size: 14px; margin: 0 0 8px 0;">Particle Effects</h3>
                    <p style="font-size: 10px; color: #888; margin-bottom: 15px;">Add visual effects created in ParticleFX to game events.</p>

                    <div class="form-group">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="setting-particle-effects-enabled" onchange="updateGameSetting('particleEffectsEnabled', this.checked); toggleParticleEffectsOptions();">
                            <span style="margin-left: 8px;">Enable Particle Effects</span>
                        </label>
                        <small style="color: #666; font-size: 9px;">Turn on particle effects in your game</small>
                    </div>

                    <div id="particle-effects-options" style="display: none; margin-top: 15px;">
                        <div style="background: rgba(233, 69, 96, 0.1); border: 1px solid rgba(233, 69, 96, 0.3); border-radius: 6px; padding: 10px; margin-bottom: 15px;">
                            <p style="font-size: 10px; color: #e94560; margin: 0;">
                                <strong>How to use:</strong> Create effects in ParticleFX, click "Export to Assets", then paste the URL below.
                            </p>
                        </div>

                        <div style="background: rgba(52, 152, 219, 0.1); border: 1px solid rgba(52, 152, 219, 0.3); border-radius: 6px; padding: 10px; margin-bottom: 15px;">
                            <p style="font-size: 10px; color: #3498db; margin: 0;">
                                <strong>üí° Per-Object Effects:</strong> Enemy death, collectible, powerup, spring, and hazard effects are now set on each template individually. Edit your templates in the Objects panel to add custom particle effects for each object type!
                            </p>
                        </div>

                        <h4 style="font-size: 12px; color: #888; margin: 0 0 12px 0; border-bottom: 1px solid #333; padding-bottom: 6px;">Player Effects</h4>

                        <div class="form-group" style="margin-bottom: 12px;">
                            <label style="font-size: 11px; color: #888;">üíî Player Damage Effect:</label>
                            <div class="input-with-browse" style="display: flex; gap: 4px; flex-wrap: wrap;">
                                <input type="text" id="setting-particle-player-damage" placeholder="pfx:id"
                                    style="flex: 1; min-width: 80px; padding: 6px 8px; background: #2a2a3e; border: 1px solid #444; border-radius: 4px; color: #fff; font-size: 11px;"
                                    onchange="updateGameSetting('particleEffect_playerDamage', this.value)">
                                <button type="button" class="browse-library-btn pfx-create-btn" onclick="openParticleFXStudio('setting-particle-player-damage', 'Player Damage Effect', 'damage')" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); padding: 4px 8px; font-size: 10px;">‚ú® Create</button>
                                <button type="button" class="browse-library-btn pfx-edit-btn" onclick="editParticleFXStudio('setting-particle-player-damage')" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); padding: 4px 8px; font-size: 10px; display: none;">‚úèÔ∏è Edit</button>
                                <button type="button" class="browse-library-btn pfx-unlink-btn" onclick="unlinkParticleFXStudio('setting-particle-player-damage')" style="background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%); padding: 4px 8px; font-size: 10px; display: none;">‚úï</button>
                            </div>
                            <small style="color: #666; font-size: 9px;">Plays when player takes damage</small>
                        </div>

                        <div class="form-group" style="margin-bottom: 12px;">
                            <label style="font-size: 11px; color: #888;">üí® Player Jump Effect:</label>
                            <div class="input-with-browse" style="display: flex; gap: 4px; flex-wrap: wrap;">
                                <input type="text" id="setting-particle-player-jump" placeholder="pfx:id"
                                    style="flex: 1; min-width: 80px; padding: 6px 8px; background: #2a2a3e; border: 1px solid #444; border-radius: 4px; color: #fff; font-size: 11px;"
                                    onchange="updateGameSetting('particleEffect_playerJump', this.value)">
                                <button type="button" class="browse-library-btn pfx-create-btn" onclick="openParticleFXStudio('setting-particle-player-jump', 'Player Jump Effect', 'smoke')" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); padding: 4px 8px; font-size: 10px;">‚ú® Create</button>
                                <button type="button" class="browse-library-btn pfx-edit-btn" onclick="editParticleFXStudio('setting-particle-player-jump')" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); padding: 4px 8px; font-size: 10px; display: none;">‚úèÔ∏è Edit</button>
                                <button type="button" class="browse-library-btn pfx-unlink-btn" onclick="unlinkParticleFXStudio('setting-particle-player-jump')" style="background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%); padding: 4px 8px; font-size: 10px; display: none;">‚úï</button>
                            </div>
                            <small style="color: #666; font-size: 9px;">Dust cloud when player jumps</small>
                        </div>

                        <div class="form-group" style="margin-bottom: 12px;">
                            <label style="font-size: 11px; color: #888;">üö© Checkpoint Effect:</label>
                            <div class="input-with-browse" style="display: flex; gap: 4px; flex-wrap: wrap;">
                                <input type="text" id="setting-particle-checkpoint" placeholder="pfx:id"
                                    style="flex: 1; min-width: 80px; padding: 6px 8px; background: #2a2a3e; border: 1px solid #444; border-radius: 4px; color: #fff; font-size: 11px;"
                                    onchange="updateGameSetting('particleEffect_checkpoint', this.value)">
                                <button type="button" class="browse-library-btn pfx-create-btn" onclick="openParticleFXStudio('setting-particle-checkpoint', 'Checkpoint Effect', 'sparkle')" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); padding: 4px 8px; font-size: 10px;">‚ú® Create</button>
                                <button type="button" class="browse-library-btn pfx-edit-btn" onclick="editParticleFXStudio('setting-particle-checkpoint')" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); padding: 4px 8px; font-size: 10px; display: none;">‚úèÔ∏è Edit</button>
                                <button type="button" class="browse-library-btn pfx-unlink-btn" onclick="unlinkParticleFXStudio('setting-particle-checkpoint')" style="background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%); padding: 4px 8px; font-size: 10px; display: none;">‚úï</button>
                            </div>
                            <small style="color: #666; font-size: 9px;">Plays when checkpoint is activated</small>
                        </div>

                        <div class="form-group" style="margin-bottom: 12px;">
                            <label style="font-size: 11px; color: #888;">üéâ Level Complete Effect:</label>
                            <div class="input-with-browse" style="display: flex; gap: 4px; flex-wrap: wrap;">
                                <input type="text" id="setting-particle-level-complete" placeholder="pfx:id"
                                    style="flex: 1; min-width: 80px; padding: 6px 8px; background: #2a2a3e; border: 1px solid #444; border-radius: 4px; color: #fff; font-size: 11px;"
                                    onchange="updateGameSetting('particleEffect_levelComplete', this.value)">
                                <button type="button" class="browse-library-btn pfx-create-btn" onclick="openParticleFXStudio('setting-particle-level-complete', 'Level Complete Effect', 'sparkle')" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); padding: 4px 8px; font-size: 10px;">‚ú® Create</button>
                                <button type="button" class="browse-library-btn pfx-edit-btn" onclick="editParticleFXStudio('setting-particle-level-complete')" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); padding: 4px 8px; font-size: 10px; display: none;">‚úèÔ∏è Edit</button>
                                <button type="button" class="browse-library-btn pfx-unlink-btn" onclick="unlinkParticleFXStudio('setting-particle-level-complete')" style="background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%); padding: 4px 8px; font-size: 10px; display: none;">‚úï</button>
                            </div>
                            <small style="color: #666; font-size: 9px;">Celebration effect when level is completed</small>
                        </div>
                    </div>
                </div><!-- End Particles Section -->

            </div><!-- End game-settings-content -->
        </div><!-- End game-settings-container -->

        <div class="modal-buttons" style="flex-shrink: 0; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px; margin-top: 0;">
            <button class="btn btn-primary" onclick="closeGamePropertiesModal()">Done</button>
        </div>
    </div>
</div>

<!-- Player Properties Modal -->
<div class="modal-overlay template-modal" id="player-properties-modal" onclick="if(event.target === this) closePlayerPropertiesModal()">
    <div class="modal template-editor-modal" style="max-width: 700px; max-height: 85vh; display: flex; flex-direction: column;">
        <div class="modal-header" style="flex-shrink: 0;">
            <h2>üéÆ Player Properties</h2>
            <button class="modal-close-btn" onclick="closePlayerPropertiesModal()">&times;</button>
        </div>
        <div class="player-props-container">
            <!-- Left Navigation -->
            <div class="player-props-nav">
                <button class="player-props-nav-item active" data-section="movement" onclick="showPlayerSection('movement')">
                    <span class="nav-icon">üèÉ</span>
                    <span class="nav-label">Movement</span>
                </button>
                <button class="player-props-nav-item" data-section="appearance" onclick="showPlayerSection('appearance')">
                    <span class="nav-icon">üé®</span>
                    <span class="nav-label">Appearance</span>
                </button>
                <button class="player-props-nav-item" data-section="combat" onclick="showPlayerSection('combat')">
                    <span class="nav-icon">üéØ</span>
                    <span class="nav-label">Combat</span>
                </button>
                <button class="player-props-nav-item" data-section="audio" onclick="showPlayerSection('audio')">
                    <span class="nav-icon">üîä</span>
                    <span class="nav-label">Audio</span>
                </button>
                <button class="player-props-nav-item" data-section="effects" onclick="showPlayerSection('effects')">
                    <span class="nav-icon">‚ú®</span>
                    <span class="nav-label">Effects</span>
                </button>
            </div>

            <!-- Right Content Panel -->
            <div class="player-props-content">
                <!-- Movement Section -->
                <div class="player-section active" id="player-section-movement">
                    <h3 style="color: #e94560; font-size: 14px; margin: 0 0 12px 0;">Movement & Physics <span class="help-icon" onclick="showHelp('physics')">?</span></h3>
                    <div class="form-row">
                        <div class="form-group platformer-only">
                            <label>Gravity</label>
                            <input type="number" id="setting-gravity" value="0.5" min="0.1" max="2" step="0.1" onchange="updateGameSetting('gravity', this.value)">
                            <small style="color: #666; font-size: 9px;">0.3 = floaty, 0.5 = normal, 0.8 = heavy</small>
                        </div>
                        <div class="form-group platformer-only">
                            <label>Jump Power</label>
                            <input type="number" id="setting-jump" value="10" min="5" max="20" step="0.5" onchange="updateGameSetting('jumpPower', this.value)">
                            <small style="color: #666; font-size: 9px;">8 = small, 12 = normal, 15 = high</small>
                        </div>
                        <div class="form-group">
                            <label>Move Speed</label>
                            <input type="number" id="setting-speed" value="4" min="1" max="10" step="0.5" onchange="updateGameSetting('moveSpeed', this.value)">
                            <small style="color: #666; font-size: 9px;">2 = slow, 4 = normal, 6 = fast</small>
                        </div>
                    </div>
                    <div class="form-row platformer-only">
                        <div class="form-group">
                            <label>Bounciness</label>
                            <input type="number" id="setting-bounciness" value="0" min="0" max="1" step="0.1" onchange="updateGameSetting('bounciness', this.value)">
                            <small style="color: #666; font-size: 9px;">0 = no bounce, 0.3 = slight, 0.7 = very bouncy</small>
                        </div>
                        <div class="form-group">
                            <label>Friction</label>
                            <input type="number" id="setting-friction" value="0.85" min="0" max="1" step="0.05" onchange="updateGameSetting('friction', this.value)">
                            <small style="color: #666; font-size: 9px;">1 = ice (no friction), 0.85 = normal, 0.5 = sticky</small>
                        </div>
                    </div>
                    <div class="form-group platformer-only" style="margin-top: 10px;">
                        <label>Jump Mode</label>
                        <select id="setting-jump-mode" onchange="updateGameSetting('jumpMode', this.value); toggleFlyOptions();">
                            <option value="normal">Normal Jump</option>
                            <option value="double">Double Jump</option>
                            <option value="fly">Fly (Flappy Bird style)</option>
                        </select>
                        <small id="jump-mode-desc" style="color: #666; font-size: 9px;">Standard platformer jumping</small>
                    </div>
                    <div id="fly-options" class="platformer-only" style="display: none; margin-top: 8px; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 6px;">
                        <div class="form-group">
                            <label>Flap Power</label>
                            <input type="number" id="setting-flap-power" value="6" min="2" max="15" step="0.5" onchange="updateGameSetting('flyFlapPower', parseFloat(this.value))">
                            <small style="color: #666; font-size: 9px;">Upward boost per flap (2-15)</small>
                        </div>
                    </div>
                </div><!-- End Movement Section -->

                <!-- Appearance Section -->
                <div class="player-section" id="player-section-appearance">
                    <h3 style="color: #e94560; font-size: 14px; margin: 0 0 12px 0;">Appearance <span class="help-icon" onclick="showHelp('playerSprite')">?</span></h3>
                    <div class="form-row">
                        <div class="form-group" style="flex: 0.3;">
                            <label>Color</label>
                            <input type="color" id="setting-color" value="#ff6b6b" style="width: 100%; height: 36px;" onchange="updateGameSetting('playerColor', this.value); updateCollisionPreview();">
                        </div>
                        <div class="form-group" style="flex: 0.35;">
                            <label>Width (px)</label>
                            <input type="number" id="setting-player-width" value="32" min="8" max="128" oninput="updateGameSetting('playerWidth', this.value); updatePlayerSizeSummary(); updateCollisionPreview();">
                        </div>
                        <div class="form-group" style="flex: 0.35;">
                            <label>Height (px)</label>
                            <input type="number" id="setting-player-height" value="32" min="8" max="128" oninput="updateGameSetting('playerHeight', this.value); updatePlayerSizeSummary(); updateCollisionPreview();">
                        </div>
                    </div>
                    <!-- Collision Size -->
                    <div class="form-row" style="margin-top: 8px;">
                        <div class="form-group" style="flex: 0.3;">
                            <label style="color: #888; font-size: 10px;">Hitbox Size</label>
                        </div>
                        <div class="form-group" style="flex: 0.35;">
                            <label>Width (px)</label>
                            <input type="number" id="setting-collision-width" value="32" min="4" max="128" oninput="updateGameSetting('playerCollisionWidth', this.value); updateCollisionPreview();">
                        </div>
                        <div class="form-group" style="flex: 0.35;">
                            <label>Height (px)</label>
                            <input type="number" id="setting-collision-height" value="32" min="4" max="128" oninput="updateGameSetting('playerCollisionHeight', this.value); updateCollisionPreview();">
                        </div>
                    </div>
                    <!-- Collision Offset -->
                    <div class="form-row" style="margin-top: 4px;">
                        <div class="form-group" style="flex: 0.3;">
                            <label style="color: #888; font-size: 10px;">Hitbox Offset</label>
                        </div>
                        <div class="form-group" style="flex: 0.35;">
                            <label>X Offset</label>
                            <input type="number" id="setting-collision-offset-x" value="0" min="-64" max="64" oninput="updateGameSetting('playerCollisionOffsetX', this.value); updateCollisionPreview();">
                        </div>
                        <div class="form-group" style="flex: 0.35;">
                            <label>Y Offset</label>
                            <input type="number" id="setting-collision-offset-y" value="0" min="-64" max="64" oninput="updateGameSetting('playerCollisionOffsetY', this.value); updateCollisionPreview();">
                        </div>
                    </div>
                    <small style="color: #666; font-size: 9px; display: block; margin-bottom: 8px;">Hitbox is centered horizontally, bottom-aligned. Offset adjusts position from default.</small>
                    <!-- Hitbox Preview -->
                    <div style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 12px;">
                        <div style="flex-shrink: 0;">
                            <label style="font-size: 10px; color: #888; display: block; margin-bottom: 4px;">Hitbox Preview</label>
                            <canvas id="hitbox-preview-canvas" width="100" height="100" style="
                                background: #1a1a2e;
                                border: 1px solid rgba(255,255,255,0.1);
                                border-radius: 4px;
                            "></canvas>
                        </div>
                        <div style="flex: 1; padding-top: 16px;">
                            <div style="background: rgba(0,255,136,0.1); border: 1px solid rgba(0,255,136,0.3); border-radius: 4px; padding: 6px 8px;">
                                <small style="color: #00ff88; font-size: 9px;">üí° Press <kbd style="background: #333; padding: 1px 4px; border-radius: 2px;">H</kbd> during Play Test to visualize the hitbox in-game</small>
                            </div>
                            <div style="margin-top: 6px;">
                                <small style="color: #666; font-size: 9px;">
                                    <span style="color: #ff6b6b;">‚ñ†</span> Sprite &nbsp;
                                    <span style="color: #00ff88;">‚ñ†</span> Hitbox
                                </small>
                            </div>
                        </div>
                    </div>
                    <!-- Custom Tile Selector for Player -->
                    <div class="form-group">
                        <label>Use Custom Tile (optional)</label>
                        <select id="setting-player-custom-tile" onchange="selectPlayerCustomTile(this.value)" style="width: 100%;">
                            <option value="">-- None (use sprite URL or color) --</option>
                        </select>
                        <div id="player-custom-tile-preview" style="margin-top:4px;height:24px;display:flex;align-items:center;gap:5px;">
                            <span style="color:#666;font-size:10px;">Select a custom tile to use as player sprite</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Sprite URL (optional) <span class="help-icon" onclick="showHelp('playerSprite')">?</span></label>
                        <div style="display: flex; gap: 4px;">
                            <input type="text" id="setting-sprite-url" placeholder="https://example.com/player.png"
                                onchange="updateGameSetting('playerSpriteURL', this.value); updatePlayerSpritePreview(); clearPlayerCustomTileSelection();"
                                onkeydown="if(event.key==='Enter'){ this.blur(); updatePlayerSpritePreview(); }" style="flex: 1;">
                            <button type="button" class="browse-library-btn" onclick="openAssetPicker('setting-sprite-url', 'sprites')" style="padding: 4px 8px;">Browse</button>
                        </div>
                        <small style="color: #666; font-size: 9px;">Overrides color with animated sprite sheet</small>
                    </div>
                    <div class="form-row" style="align-items: flex-start;">
                        <div class="form-group" style="flex: 0.4; min-width: 60px;">
                            <label>Cols</label>
                            <input type="number" id="setting-sprite-cols" value="1" min="1" max="32" style="width: 60px;"
                                oninput="updateGameSetting('playerSpritesheetCols', this.value); updatePlayerSpritePreview();"
                                title="Frames per row">
                        </div>
                        <div class="form-group" style="flex: 0.4; min-width: 60px;">
                            <label>Rows</label>
                            <input type="number" id="setting-sprite-rows" value="1" min="1" max="16" style="width: 60px;"
                                oninput="updateGameSetting('playerSpritesheetRows', this.value); updatePlayerSpritePreview();"
                                title="Number of rows (4 for directional: down/left/right/up)">
                        </div>
                        <div class="form-group" style="flex: 0.5;">
                            <label>Preview</label>
                            <div id="player-sprite-preview" style="
                                width: 80px;
                                height: 80px;
                                background: rgba(0,0,0,0.3);
                                border: 1px solid rgba(255,255,255,0.1);
                                border-radius: 6px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                overflow: hidden;
                                position: relative;
                            ">
                                <span style="color: #555; font-size: 10px;">No sprite</span>
                            </div>
                        </div>
                    </div>
                    <!-- Squash & Stretch Animation -->
                    <div class="form-group platformer-only" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="setting-squash-stretch" checked onchange="updateGameSetting('squashStretchEnabled', this.checked); toggleSquashStretchOptions();">
                            <span style="margin-left: 8px;">Squash & Stretch</span>
                            <span class="help-icon" onclick="event.stopPropagation(); showHelp('playerAppearance')" style="margin-left: 6px;">?</span>
                        </label>
                        <small style="color: #666; font-size: 9px;">Player squishes on land, stretches on jump</small>

                        <!-- Intensity slider (shown when enabled) -->
                        <div id="squash-stretch-options" style="margin-top: 10px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px;">
                            <label style="font-size: 11px; color: #aaa;">Intensity <span id="squash-stretch-intensity-display" style="color: #e94560; font-weight: bold;">Normal</span></label>
                            <input type="range" id="setting-squash-stretch-intensity" value="1.0" min="0.3" max="2.0" step="0.1"
                                style="width: 100%; accent-color: #e94560; margin-top: 4px;"
                                oninput="updateSquashStretchIntensityDisplay(this.value); updateGameSetting('squashStretchIntensity', parseFloat(this.value))">
                            <div style="display: flex; justify-content: space-between; font-size: 9px; color: #666; margin-top: 2px;">
                                <span>Subtle</span>
                                <span>Normal</span>
                                <span>Exaggerated</span>
                            </div>
                        </div>
                    </div>

                    <!-- Player Idle Effect -->
                    <div class="form-group" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">
                        <label>Idle Motion Effect <span class="help-icon" onclick="showHelp('playerAppearance')">?</span></label>
                        <small style="color: #666; font-size: 9px; display: block; margin-bottom: 6px;">Continuous animation when player is standing still</small>
                        <select id="setting-player-idle-effect" onchange="updateGameSetting('playerIdleEffect', this.value); toggleIdleEffectOptions(); startIdleEffectPreview();" style="width: 100%;">
                            <option value="none">None</option>
                            <option value="float">Float (gentle up/down)</option>
                            <option value="bounce">Bounce (bouncy up/down)</option>
                            <option value="pulse">Pulse (breathing scale)</option>
                            <option value="sway">Sway (gentle rotation)</option>
                            <option value="shimmer">Shimmer (alpha pulse)</option>
                            <option value="wave">Wave (horizontal distortion)</option>
                            <option value="shake">Shake (vibration)</option>
                        </select>

                        <!-- Intensity & Speed sliders (shown when effect is not "none") -->
                        <div id="idle-effect-options" style="margin-top: 10px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px; display: none;">
                            <div style="display: flex; gap: 12px; align-items: flex-start;">
                                <!-- Sliders -->
                                <div style="flex: 1;">
                                    <div style="margin-bottom: 10px;">
                                        <label style="font-size: 11px; color: #aaa;">Intensity <span id="idle-effect-intensity-display" style="color: #667eea; font-weight: bold;">5</span></label>
                                        <input type="range" id="setting-player-idle-intensity" value="5" min="1" max="10" step="1"
                                            style="width: 100%; accent-color: #667eea; margin-top: 4px;"
                                            oninput="document.getElementById('idle-effect-intensity-display').textContent = this.value; updateGameSetting('playerIdleEffectIntensity', parseInt(this.value)); updateIdleEffectPreview();">
                                    </div>
                                    <div>
                                        <label style="font-size: 11px; color: #aaa;">Speed <span id="idle-effect-speed-display" style="color: #667eea; font-weight: bold;">5</span></label>
                                        <input type="range" id="setting-player-idle-speed" value="5" min="1" max="10" step="1"
                                            style="width: 100%; accent-color: #667eea; margin-top: 4px;"
                                            oninput="document.getElementById('idle-effect-speed-display').textContent = this.value; updateGameSetting('playerIdleEffectSpeed', parseInt(this.value)); updateIdleEffectPreview();">
                                    </div>
                                </div>
                                <!-- Preview -->
                                <div style="text-align: center;">
                                    <label style="font-size: 9px; color: #666; text-transform: uppercase; display: block; margin-bottom: 4px;">Preview</label>
                                    <div style="width: 64px; height: 64px; background: repeating-conic-gradient(#222 0% 25%, #333 0% 50%) 50% / 8px 8px; border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; display: flex; align-items: center; justify-content: center;">
                                        <canvas id="idle-effect-preview-canvas" width="48" height="48" style="image-rendering: pixelated;"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div><!-- End Appearance Section -->

                <!-- Audio Section -->
                <div class="player-section" id="player-section-audio">
                    <h3 style="color: #e94560; font-size: 14px; margin: 0 0 12px 0;">Player Sounds <span class="help-icon" onclick="showHelp('sounds')">?</span></h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ü¶ò Jump Sound</label>
                            <div style="display: flex; gap: 4px; flex-wrap: wrap;">
                                <input type="text" id="setting-sound-jump" placeholder="URL or sfx:id" onchange="updateGameSetting('sounds.jump', this.value); updateSoundButtonStates('setting-sound-jump');" style="flex: 1; min-width: 120px;">
                                <button type="button" class="browse-library-btn" onclick="openAssetPicker('setting-sound-jump', 'sounds')" style="padding: 4px 8px;" title="Browse asset library">Browse</button>
                                <button type="button" class="browse-library-btn sfx-create-btn" onclick="openSoundEffectStudio('setting-sound-jump', 'Jump Sound')" style="padding: 4px 8px; background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);" title="Create custom sound">üéµ Create</button>
                                <button type="button" class="browse-library-btn sfx-edit-btn" onclick="editSoundEffectStudio('setting-sound-jump')" style="padding: 4px 8px; background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); display: none;" title="Edit linked sound">‚úèÔ∏è Edit</button>
                                <button type="button" class="browse-library-btn sfx-unlink-btn" onclick="unlinkSoundEffectStudio('setting-sound-jump')" style="padding: 4px 8px; background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%); display: none;" title="Unlink sound">‚úï</button>
                                <button class="btn btn-small" onclick="testSound('jump')" title="Test sound">‚ñ∂</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>üíî Hurt Sound</label>
                            <div style="display: flex; gap: 4px; flex-wrap: wrap;">
                                <input type="text" id="setting-sound-hurt" placeholder="URL or sfx:id" onchange="updateGameSetting('sounds.hurt', this.value); updateSoundButtonStates('setting-sound-hurt');" style="flex: 1; min-width: 120px;">
                                <button type="button" class="browse-library-btn" onclick="openAssetPicker('setting-sound-hurt', 'sounds')" style="padding: 4px 8px;" title="Browse asset library">Browse</button>
                                <button type="button" class="browse-library-btn sfx-create-btn" onclick="openSoundEffectStudio('setting-sound-hurt', 'Hurt Sound')" style="padding: 4px 8px; background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);" title="Create custom sound">üéµ Create</button>
                                <button type="button" class="browse-library-btn sfx-edit-btn" onclick="editSoundEffectStudio('setting-sound-hurt')" style="padding: 4px 8px; background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); display: none;" title="Edit linked sound">‚úèÔ∏è Edit</button>
                                <button type="button" class="browse-library-btn sfx-unlink-btn" onclick="unlinkSoundEffectStudio('setting-sound-hurt')" style="padding: 4px 8px; background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%); display: none;" title="Unlink sound">‚úï</button>
                                <button class="btn btn-small" onclick="testSound('hurt')" title="Test sound">‚ñ∂</button>
                            </div>
                        </div>
                    </div>
                </div><!-- End Audio Section -->

                <!-- Combat Section -->
                <div class="player-section" id="player-section-combat">
                    <h3 style="color: #e94560; font-size: 14px; margin: 0 0 12px 0;">Projectile System <span class="help-icon" onclick="showHelp('projectiles')">?</span></h3>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="setting-projectile-enabled" onchange="updateGameSetting('projectileEnabled', this.checked); toggleProjectileOptions(); updateProjectileSummary();">
                            <span style="margin-left: 8px;">Enable Player Projectiles</span>
                        </label>
                        <small style="color: #666; font-size: 9px;">Allow player to shoot projectiles at enemies</small>
                    </div>

                    <div id="projectile-options" style="display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Fire Key</label>
                                <select id="setting-projectile-fire-key" onchange="updateGameSetting('projectileFireKey', this.value)">
                                    <option value="KeyX">X</option>
                                    <option value="KeyZ">Z</option>
                                    <option value="KeyC">C</option>
                                    <option value="ShiftLeft">Shift</option>
                                    <option value="ControlLeft">Ctrl</option>
                                    <option value="Enter">Enter</option>
                                    <option value="Space">Space</option>
                                </select>
                                <small style="color: #666; font-size: 9px;">Keyboard key to fire</small>
                            </div>
                            <div class="form-group">
                                <label>Ammo Mode</label>
                                <select id="setting-projectile-mode" onchange="updateGameSetting('projectileMode', this.value); toggleAmmoOptions();">
                                    <option value="cooldown">Cooldown Only (Unlimited)</option>
                                    <option value="ammo">Limited Ammo</option>
                                </select>
                                <small style="color: #666; font-size: 9px;">How ammunition works</small>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Cooldown (ms)</label>
                                <input type="number" id="setting-projectile-cooldown" value="500" min="100" max="5000" step="50" onchange="updateGameSetting('projectileCooldown', this.value)">
                                <small style="color: #666; font-size: 9px;">100-5000 ms between shots</small>
                            </div>
                            <div class="form-group">
                                <label>Speed (px/frame)</label>
                                <input type="number" id="setting-projectile-speed" value="8" min="2" max="20" step="1" onchange="updateGameSetting('projectileSpeed', this.value)">
                                <small style="color: #666; font-size: 9px;">2 = slow, 8 = normal, 15 = fast</small>
                            </div>
                        </div>

                        <div id="ammo-options" style="display: none;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Starting Ammo</label>
                                    <input type="number" id="setting-projectile-start-ammo" value="10" min="1" max="999" onchange="updateGameSetting('projectileStartAmmo', this.value)">
                                    <small style="color: #666; font-size: 9px;">Ammo at game start</small>
                                </div>
                                <div class="form-group">
                                    <label>Max Ammo</label>
                                    <input type="number" id="setting-projectile-max-ammo" value="30" min="1" max="999" onchange="updateGameSetting('projectileMaxAmmo', this.value)">
                                    <small style="color: #666; font-size: 9px;">Maximum ammo capacity</small>
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Damage</label>
                                <input type="number" id="setting-projectile-damage" value="1" min="1" max="10" onchange="updateGameSetting('projectileDamage', this.value)">
                                <small style="color: #666; font-size: 9px;">Damage dealt to enemies</small>
                            </div>
                            <div class="form-group">
                                <label>Lifetime (ms)</label>
                                <input type="number" id="setting-projectile-lifetime" value="2000" min="500" max="10000" step="100" onchange="updateGameSetting('projectileLifetime', this.value)">
                                <small style="color: #666; font-size: 9px;">How long before it expires</small>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group" style="flex: 0.3;">
                                <label>Color</label>
                                <input type="color" id="setting-projectile-color" value="#ffff00" style="width: 100%; height: 36px;" onchange="updateGameSetting('projectileColor', this.value)">
                            </div>
                            <div class="form-group" style="flex: 0.35;">
                                <label>Width (px)</label>
                                <input type="number" id="setting-projectile-width" value="8" min="4" max="32" onchange="updateGameSetting('projectileWidth', this.value)">
                            </div>
                            <div class="form-group" style="flex: 0.35;">
                                <label>Height (px)</label>
                                <input type="number" id="setting-projectile-height" value="8" min="4" max="32" onchange="updateGameSetting('projectileHeight', this.value)">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Sprite URL (optional)</label>
                            <div style="display: flex; gap: 4px;">
                                <input type="text" id="setting-projectile-sprite" placeholder="https://example.com/projectile.png" onchange="updateGameSetting('projectileSpriteURL', this.value)" style="flex: 1;">
                                <button type="button" class="browse-library-btn" onclick="openAssetPicker('setting-projectile-sprite', 'sprites')" style="padding: 4px 8px;">Browse</button>
                            </div>
                            <small style="color: #666; font-size: 9px;">Overrides color with sprite image</small>
                        </div>
                        <div class="form-row">
                            <div class="form-group" style="width: 80px;">
                                <label>Cols</label>
                                <input type="number" id="setting-projectile-cols" value="1" min="1" max="16"
                                    onchange="updateGameSetting('projectileSpritesheetCols', this.value)" title="Frames per row">
                            </div>
                            <div class="form-group" style="width: 80px;">
                                <label>Rows</label>
                                <input type="number" id="setting-projectile-rows" value="1" min="1" max="16"
                                    onchange="updateGameSetting('projectileSpritesheetRows', this.value)" title="Number of rows">
                            </div>
                        </div>

                        <div class="form-group" style="margin-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 12px;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" id="setting-projectile-collects" onchange="updateGameSetting('projectileCollectsItems', this.checked)">
                                <span style="margin-left: 8px;">Projectiles Collect Items</span>
                            </label>
                            <small style="color: #666; font-size: 9px;">Projectiles can pick up collectibles (coins, etc.) on contact</small>
                        </div>

                        <h4 style="color: #888; font-size: 12px; margin: 15px 0 10px 0;">Projectile Sounds</h4>
                        <div class="form-group">
                            <label>Shoot Sound</label>
                            <div class="input-with-browse" style="display: flex; gap: 4px; flex-wrap: wrap;">
                                <input type="text" id="setting-sound-shoot" placeholder="URL or sfx:id" onchange="updateGameSetting('sounds.shoot', this.value); updateSoundButtonStates('setting-sound-shoot');" style="flex: 1; min-width: 120px;">
                                <button type="button" class="browse-library-btn" onclick="openAssetPicker('setting-sound-shoot', 'sounds')">Browse</button>
                                <button type="button" class="browse-library-btn sfx-create-btn" onclick="openSoundEffectStudio('setting-sound-shoot', 'Shoot Sound')" style="background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);" title="Create custom sound">üéµ Create</button>
                                <button type="button" class="browse-library-btn sfx-edit-btn" onclick="editSoundEffectStudio('setting-sound-shoot')" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); display: none;" title="Edit linked sound">‚úèÔ∏è Edit</button>
                                <button type="button" class="browse-library-btn sfx-unlink-btn" onclick="unlinkSoundEffectStudio('setting-sound-shoot')" style="background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%); display: none;" title="Unlink sound">‚úï</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Hit Sound</label>
                            <div class="input-with-browse" style="display: flex; gap: 4px; flex-wrap: wrap;">
                                <input type="text" id="setting-sound-projectile-hit" placeholder="URL or sfx:id" onchange="updateGameSetting('sounds.projectileHit', this.value); updateSoundButtonStates('setting-sound-projectile-hit');" style="flex: 1; min-width: 120px;">
                                <button type="button" class="browse-library-btn" onclick="openAssetPicker('setting-sound-projectile-hit', 'sounds')">Browse</button>
                                <button type="button" class="browse-library-btn sfx-create-btn" onclick="openSoundEffectStudio('setting-sound-projectile-hit', 'Hit Sound')" style="background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);" title="Create custom sound">üéµ Create</button>
                                <button type="button" class="browse-library-btn sfx-edit-btn" onclick="editSoundEffectStudio('setting-sound-projectile-hit')" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); display: none;" title="Edit linked sound">‚úèÔ∏è Edit</button>
                                <button type="button" class="browse-library-btn sfx-unlink-btn" onclick="unlinkSoundEffectStudio('setting-sound-projectile-hit')" style="background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%); display: none;" title="Unlink sound">‚úï</button>
                            </div>
                        </div>
                    </div><!-- End projectile-options -->
                </div><!-- End Combat Section -->

                <!-- Effects Section (Particle Effects) -->
                <div class="player-section" id="player-section-effects">
                    <h3 style="color: #e94560; font-size: 14px; margin: 0 0 12px 0;">Particle Effects</h3>
                    <p style="font-size: 10px; color: #888; margin-bottom: 15px;">Add visual effects created in ParticleFX to player actions.</p>

                    <div class="form-group" style="margin-bottom: 15px;">
                        <label>üí® Jump Particle Effect</label>
                        <div class="input-with-browse" style="display: flex; gap: 4px; flex-wrap: wrap;">
                            <input type="text" id="player-particle-jump" placeholder="pfx:id" style="flex: 1; min-width: 80px;"
                                title="Particle effect when player jumps"
                                onchange="updateGameSetting('particleEffect_playerJump', this.value); document.getElementById('setting-particle-player-jump').value = this.value; updateParticleButtonStates('player-particle-jump'); updateParticleButtonStates('setting-particle-player-jump');">
                            <button type="button" class="browse-library-btn pfx-create-btn" onclick="openParticleFXStudio('player-particle-jump', 'Player Jump Effect', 'smoke')" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);">‚ú® Create</button>
                            <button type="button" class="browse-library-btn pfx-edit-btn" onclick="editParticleFXStudio('player-particle-jump')" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); display: none;">‚úèÔ∏è Edit</button>
                            <button type="button" class="browse-library-btn pfx-unlink-btn" onclick="unlinkParticleFXStudio('player-particle-jump')" style="background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%); display: none;">‚úï</button>
                        </div>
                        <small style="color: #666; font-size: 9px;">Dust cloud when player jumps</small>
                    </div>

                    <div class="form-group">
                        <label>üíî Damage Particle Effect</label>
                        <div class="input-with-browse" style="display: flex; gap: 4px; flex-wrap: wrap;">
                            <input type="text" id="player-particle-damage" placeholder="pfx:id" style="flex: 1; min-width: 80px;"
                                title="Particle effect when player takes damage"
                                onchange="updateGameSetting('particleEffect_playerDamage', this.value); document.getElementById('setting-particle-player-damage').value = this.value; updateParticleButtonStates('player-particle-damage'); updateParticleButtonStates('setting-particle-player-damage');">
                            <button type="button" class="browse-library-btn pfx-create-btn" onclick="openParticleFXStudio('player-particle-damage', 'Player Damage Effect', 'damage')" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);">‚ú® Create</button>
                            <button type="button" class="browse-library-btn pfx-edit-btn" onclick="editParticleFXStudio('player-particle-damage')" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); display: none;">‚úèÔ∏è Edit</button>
                            <button type="button" class="browse-library-btn pfx-unlink-btn" onclick="unlinkParticleFXStudio('player-particle-damage')" style="background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%); display: none;">‚úï</button>
                        </div>
                        <small style="color: #666; font-size: 9px;">Effect when player gets hurt</small>
                    </div>

                    <div style="background: rgba(233, 69, 96, 0.1); border: 1px solid rgba(233, 69, 96, 0.3); border-radius: 6px; padding: 10px; margin-top: 15px;">
                        <p style="font-size: 10px; color: #e94560; margin: 0;">
                            <strong>üí° Tip:</strong> Create effects in ParticleFX app, then "Export to Assets" to use here.
                        </p>
                    </div>
                </div><!-- End Effects Section -->

            </div><!-- End player-props-content -->
        </div><!-- End player-props-container -->

        <div class="modal-buttons" style="flex-shrink: 0; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px; margin-top: 0;">
            <button class="btn btn-primary" onclick="closePlayerPropertiesModal()">Done</button>
        </div>
    </div>
</div>

<!-- Level Manager Modal -->
<div class="modal-overlay template-modal" id="level-manager-modal" onclick="if(event.target === this) closeLevelManagerModal()">
    <div class="modal level-manager-modal-content">
        <div class="modal-header">
            <h2>Manage Levels</h2>
            <button class="modal-close-btn" onclick="closeLevelManagerModal()">&times;</button>
        </div>
        <p class="modal-description">Create and organize levels for your game. Drag to reorder, or use arrow buttons.</p>
        <div id="levels-list" class="levels-list">
            <!-- Level items will be rendered here -->
        </div>
        <div class="modal-buttons">
            <button class="btn btn-primary" onclick="addNewLevel(); updateLevelsList();">+ Add New Level</button>
            <button class="btn" onclick="closeLevelManagerModal()">Close</button>
        </div>
    </div>
</div>

<!-- Level Settings Modal -->
<div class="modal-overlay template-modal" id="level-settings-modal" onclick="if(event.target === this) closeLevelSettingsModal()">
    <div class="modal template-editor-modal" style="max-width: 600px; max-height: 85vh; display: flex; flex-direction: column;">
        <div class="modal-header" style="flex-shrink: 0;">
            <h2>üó∫Ô∏è Level Settings <span class="help-icon" onclick="showHelp('levels')">?</span></h2>
            <button class="modal-close-btn" onclick="closeLevelSettingsModal()">&times;</button>
        </div>
        <div class="level-settings-container">
            <!-- Left Navigation -->
            <div class="level-settings-nav">
                <button class="level-settings-nav-item active" data-section="basics" onclick="showLevelSettingsSection('basics')">
                    <span class="nav-icon">üìê</span>
                    <span class="nav-label">Basics</span>
                </button>
                <button class="level-settings-nav-item gameplay-level-only" data-section="goals" onclick="showLevelSettingsSection('goals')">
                    <span class="nav-icon">üéØ</span>
                    <span class="nav-label">Goals</span>
                </button>
                <button class="level-settings-nav-item platformer-only gameplay-level-only" data-section="autoscroll" onclick="showLevelSettingsSection('autoscroll')">
                    <span class="nav-icon">üìú</span>
                    <span class="nav-label">Autoscroll</span>
                </button>
                <button class="level-settings-nav-item" data-section="audio" onclick="showLevelSettingsSection('audio')">
                    <span class="nav-icon">üîä</span>
                    <span class="nav-label">Audio</span>
                </button>
                <button class="level-settings-nav-item" data-section="backgrounds" onclick="showLevelSettingsSection('backgrounds')">
                    <span class="nav-icon">üñºÔ∏è</span>
                    <span class="nav-label">Backgrounds</span>
                </button>
                <button class="level-settings-nav-item" data-section="particles" onclick="showLevelSettingsSection('particles')">
                    <span class="nav-icon">‚ú®</span>
                    <span class="nav-label">Particles</span>
                </button>
                <button class="level-settings-nav-item menu-level-only" data-section="menu-elements" onclick="showLevelSettingsSection('menu-elements')" style="display: none;">
                    <span class="nav-icon">üîò</span>
                    <span class="nav-label">Menu Elements</span>
                </button>
            </div>

            <!-- Right Content Panel -->
            <div class="level-settings-content">
                <!-- Basics Section -->
                <div class="level-settings-section active" id="level-settings-section-basics">
                    <h3 style="color: #2ecc71; font-size: 14px; margin: 0 0 12px 0;">Level Basics <span class="help-icon" onclick="showHelp('levelSize')">?</span></h3>

                    <!-- Level Type Toggle -->
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label>Level Type</label>
                        <div class="level-type-toggle" style="display: flex; gap: 8px; margin-top: 5px;">
                            <button type="button" class="level-type-btn active" data-type="gameplay" onclick="setLevelType('gameplay')">
                                <span style="font-size: 16px;">üéÆ</span> Gameplay
                            </button>
                            <button type="button" class="level-type-btn" data-type="menu" onclick="setLevelType('menu')">
                                <span style="font-size: 16px;">üìã</span> Menu Screen
                            </button>
                        </div>
                        <small style="color: #666; font-size: 9px;">Menu screens display buttons instead of gameplay tiles</small>
                    </div>

                    <div class="form-group">
                        <label>Level Name</label>
                        <input type="text" id="level-settings-name" placeholder="My Level" maxlength="50">
                        <small style="color: #666; font-size: 9px;">Give your level a memorable name</small>
                    </div>
                    <div class="form-row gameplay-level-only" style="margin-top: 15px;">
                        <div class="form-group">
                            <label>Width (tiles)</label>
                            <input type="number" id="level-settings-width" value="150" min="10" max="500">
                        </div>
                        <div class="form-group">
                            <label>Height (tiles)</label>
                            <input type="number" id="level-settings-height" value="30" min="5" max="100">
                        </div>
                    </div>
                    <small class="gameplay-level-only" style="color: #666; font-size: 9px;">Tip: Wider levels work better for autoscroll games</small>

                    <!-- Spawn Point (per-level) -->
                    <div class="gameplay-level-only" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                        <h4 style="color: #e94560; font-size: 12px; margin: 0 0 10px 0;">üéØ Spawn Point</h4>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-size: 11px; color: #888;">Current Status:</span>
                            <span id="level-spawn-status" style="font-size: 11px; color: #ffaa00;">Auto</span>
                        </div>
                        <p style="font-size: 10px; color: #666; margin-bottom: 10px;">Use the <strong>üîÑ Move</strong> tool to drag the player on the canvas to set where they start in this level.</p>
                        <button id="level-clear-spawn-btn" onclick="clearSpawnPoint(); updateLevelSpawnUI();" class="btn btn-full" style="background: rgba(255,100,100,0.2); border-color: #f66; color: #f66; display: none;">Reset to Auto-Detect</button>
                    </div>

                    <div class="gameplay-level-only" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                        <div class="form-group">
                            <label>After Completing This Level</label>
                            <select id="level-settings-next">
                                <option value="">Game Complete (End)</option>
                                <!-- Other levels will be added dynamically -->
                            </select>
                            <small style="color: #666; font-size: 9px;">Chain levels together to create a full game</small>
                        </div>
                    </div>
                </div><!-- End Basics Section -->

                <!-- Goals Section -->
                <div class="level-settings-section gameplay-level-only" id="level-settings-section-goals">
                    <h3 style="color: #2ecc71; font-size: 14px; margin: 0 0 12px 0;">Win Condition <span class="help-icon" onclick="showHelp('goalCondition')">?</span></h3>
                    <p style="font-size: 11px; color: #888; margin-bottom: 12px;">How does the player beat this level?</p>

                    <div class="form-group">
                        <label>Goal Type</label>
                        <select id="level-settings-goal" onchange="updateLevelSettingsFields()">
                            <option value="goal">üö© Reach the Goal Flag</option>
                            <option value="collect_all">‚≠ê Collect All Items</option>
                            <option value="score">üèÜ Reach Target Score</option>
                            <option value="survive">‚è±Ô∏è Survive Time Limit</option>
                        </select>
                    </div>

                    <div class="form-group" id="score-settings-group" style="display: none; margin-top: 15px;">
                        <label>Required Score</label>
                        <input type="number" id="level-settings-score" value="100" min="1" max="999999">
                        <small style="color: #666; font-size: 9px;">Player must reach this score to win</small>
                    </div>

                    <div class="form-group" id="time-settings-group" style="display: none; margin-top: 15px;">
                        <label>Time Limit (seconds)</label>
                        <input type="number" id="level-settings-time" value="60" min="10" max="600">
                        <small style="color: #666; font-size: 9px;">Player wins by surviving this long</small>
                    </div>

                    <div style="margin-top: 20px; padding: 12px; background: rgba(46, 204, 113, 0.1); border-radius: 6px; border-left: 3px solid #2ecc71;">
                        <p style="font-size: 11px; color: #aaa; margin: 0;"><strong style="color: #2ecc71;">Design Tip:</strong> "Reach the Goal" is easiest for players to understand. Use other conditions to add variety in later levels!</p>
                    </div>
                </div><!-- End Goals Section -->

                <!-- Autoscroll Section (Platformer only - not available in Top-Down RPG or Menu screens) -->
                <div class="level-settings-section platformer-only gameplay-level-only" id="level-settings-section-autoscroll">
                    <h3 style="color: #2ecc71; font-size: 14px; margin: 0 0 12px 0;">Autoscroll Mode <span class="help-icon" onclick="showHelp('autoscroll')">?</span></h3>
                    <p style="font-size: 11px; color: #888; margin-bottom: 12px;">Make the camera scroll automatically - great for Flappy Bird or runner-style games!</p>

                    <div class="form-group">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="level-settings-autoscroll" onchange="toggleAutoscrollOptions()">
                            <span style="margin-left: 8px;">Enable Autoscroll</span>
                        </label>
                    </div>

                    <div id="autoscroll-options" style="display: none; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 6px; margin-top: 15px;">
                        <div class="form-group">
                            <label>Scroll Speed</label>
                            <input type="number" id="level-settings-autoscroll-speed" value="3" min="1" max="10" step="0.5">
                            <small style="color: #666; font-size: 9px;">Pixels per frame (1=slow, 5=medium, 10=fast)</small>
                        </div>
                        <div class="form-group" style="margin-top: 12px;">
                            <label>When Level Ends</label>
                            <select id="level-settings-autoscroll-mode">
                                <option value="end">Stop at Finish Line</option>
                                <option value="loop">Loop Endlessly</option>
                            </select>
                            <small style="color: #666; font-size: 9px;">Loop mode is great for endless runners</small>
                        </div>
                    </div>

                    <div style="margin-top: 15px; padding: 10px; background: rgba(231, 76, 60, 0.15); border-radius: 6px; border-left: 3px solid #e74c3c;">
                        <p style="font-size: 10px; color: #e74c3c; margin: 0;">‚ö†Ô∏è Player dies if they fall behind the left edge of the screen!</p>
                    </div>
                </div><!-- End Autoscroll Section -->

                <!-- Audio Section -->
                <div class="level-settings-section" id="level-settings-section-audio">
                    <h3 style="color: #2ecc71; font-size: 14px; margin: 0 0 12px 0;">Level Audio <span class="help-icon" onclick="showHelp('sounds')">?</span></h3>
                    <p style="font-size: 11px; color: #888; margin-bottom: 12px;">Add music and sound effects for this level</p>

                    <div class="form-group">
                        <label>üéµ Background Music</label>
                        <div class="input-with-browse">
                            <input type="text" id="level-settings-bgm" placeholder="https://example.com/music.mp3">
                            <button type="button" class="browse-library-btn" onclick="openAssetPicker('level-settings-bgm', 'music')">Browse</button>
                        </div>
                        <small style="color: #666; font-size: 9px;">Loops while this level is active</small>
                    </div>
                    <div class="form-group" style="margin-top: 8px;">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            üîä Music Volume
                            <span id="level-settings-bgm-volume-display" style="color: #667eea; font-size: 11px;">50%</span>
                            <button type="button" id="level-settings-bgm-preview-btn" onclick="toggleBgmPreview()"
                                style="margin-left: auto; padding: 4px 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 4px; color: white; font-size: 11px; cursor: pointer;"
                                title="Preview music at current volume">
                                ‚ñ∂ Preview
                            </button>
                        </label>
                        <input type="range" id="level-settings-bgm-volume" min="0" max="100" value="50"
                            style="width: 100%; accent-color: #667eea;"
                            oninput="updateBgmPreviewVolume(this.value)">
                    </div>

                    <div style="margin-top: 18px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                        <label style="font-size: 12px; color: #888; margin-bottom: 10px; display: block;">Event Sounds</label>
                        <div class="form-group">
                            <label>üéâ Level Complete</label>
                            <div class="input-with-browse" style="display: flex; gap: 4px; flex-wrap: wrap;">
                                <input type="text" id="level-settings-complete-sound" placeholder="URL or sfx:id" onchange="updateSoundButtonStates('level-settings-complete-sound');" style="flex: 1; min-width: 120px;">
                                <button type="button" class="browse-library-btn" onclick="openAssetPicker('level-settings-complete-sound', 'sounds')">Browse</button>
                                <button type="button" class="browse-library-btn sfx-create-btn" onclick="openSoundEffectStudio('level-settings-complete-sound', 'Level Complete Sound')" style="background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);" title="Create custom sound">üéµ Create</button>
                                <button type="button" class="browse-library-btn sfx-edit-btn" onclick="editSoundEffectStudio('level-settings-complete-sound')" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); display: none;" title="Edit linked sound">‚úèÔ∏è Edit</button>
                                <button type="button" class="browse-library-btn sfx-unlink-btn" onclick="unlinkSoundEffectStudio('level-settings-complete-sound')" style="background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%); display: none;" title="Unlink sound">‚úï</button>
                            </div>
                        </div>
                        <div class="form-group" style="margin-top: 12px;">
                            <label>üíÄ Game Over</label>
                            <div class="input-with-browse" style="display: flex; gap: 4px; flex-wrap: wrap;">
                                <input type="text" id="level-settings-gameover-sound" placeholder="URL or sfx:id" onchange="updateSoundButtonStates('level-settings-gameover-sound');" style="flex: 1; min-width: 120px;">
                                <button type="button" class="browse-library-btn" onclick="openAssetPicker('level-settings-gameover-sound', 'sounds')">Browse</button>
                                <button type="button" class="browse-library-btn sfx-create-btn" onclick="openSoundEffectStudio('level-settings-gameover-sound', 'Game Over Sound')" style="background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);" title="Create custom sound">üéµ Create</button>
                                <button type="button" class="browse-library-btn sfx-edit-btn" onclick="editSoundEffectStudio('level-settings-gameover-sound')" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); display: none;" title="Edit linked sound">‚úèÔ∏è Edit</button>
                                <button type="button" class="browse-library-btn sfx-unlink-btn" onclick="unlinkSoundEffectStudio('level-settings-gameover-sound')" style="background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%); display: none;" title="Unlink sound">‚úï</button>
                            </div>
                        </div>
                    </div>
                </div><!-- End Audio Section -->

                <!-- Backgrounds Section -->
                <div class="level-settings-section" id="level-settings-section-backgrounds">
                    <h3 style="color: #2ecc71; font-size: 14px; margin: 0 0 12px 0;">Parallax Backgrounds <span class="help-icon" onclick="showHelp('backgrounds')">?</span></h3>
                    <p style="font-size: 11px; color: #888; margin-bottom: 5px;">Add depth with scrolling background layers</p>
                    <p style="font-size: 10px; color: #666; margin-bottom: 12px;">Speed: 0 = static, 0.3 = slow parallax, 1 = moves with camera</p>

                    <div id="bg-layers-list"></div>
                    <button class="btn btn-full" onclick="addBackgroundLayer()" style="margin-top: 10px;">+ Add Background Layer</button>

                    <div style="margin-top: 15px; padding: 10px; background: rgba(102, 126, 234, 0.15); border-radius: 6px; border-left: 3px solid #667eea;">
                        <p style="font-size: 10px; color: #aaa; margin: 0;"><strong style="color: #667eea;">Tip:</strong> Add 2-3 layers with different speeds (0.1, 0.3, 0.6) for a professional parallax effect!</p>
                    </div>
                </div><!-- End Backgrounds Section -->

                <!-- Particles Section -->
                <div class="level-settings-section" id="level-settings-section-particles">
                    <h3 style="color: #2ecc71; font-size: 14px; margin: 0 0 12px 0;">Background Particles</h3>
                    <p style="font-size: 11px; color: #888; margin-bottom: 12px;">Add ambient particle effects like snow, rain, fog, or floating embers</p>

                    <div class="form-group" style="margin-bottom: 15px;">
                        <label>‚ú® Background Effect</label>
                        <div class="input-with-browse" style="display: flex; gap: 4px; flex-wrap: wrap;">
                            <input type="text" id="level-settings-bg-particle" placeholder="pfx:id" style="flex: 1; min-width: 80px;"
                                title="Continuous particle effect for this level's background"
                                onchange="updateLevelBackgroundParticle(this.value)">
                            <button type="button" class="browse-library-btn pfx-create-btn" onclick="openParticleFXStudio('level-settings-bg-particle', 'Background Effect', 'snow')" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);">‚ú® Create</button>
                            <button type="button" class="browse-library-btn pfx-edit-btn" onclick="editParticleFXStudio('level-settings-bg-particle')" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); display: none;">‚úèÔ∏è Edit</button>
                            <button type="button" class="browse-library-btn pfx-unlink-btn" onclick="unlinkParticleFXStudio('level-settings-bg-particle')" style="background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%); display: none;">‚úï</button>
                        </div>
                        <small style="color: #666; font-size: 9px;">Particles will continuously spawn across the level background</small>
                    </div>

                    <div class="form-group" style="margin-bottom: 15px;">
                        <label>üìç Spawn Position</label>
                        <select id="level-settings-bg-particle-spawn" onchange="updateLevelBackgroundParticleSpawn(this.value)" style="width: 100%;">
                            <option value="auto">Auto (detect from effect)</option>
                            <option value="top">Top - particles fall down (rain, snow)</option>
                            <option value="bottom">Bottom - particles rise up (smoke, embers)</option>
                            <option value="full">Full Screen - particles everywhere (fog, dust)</option>
                        </select>
                        <small style="color: #666; font-size: 9px;">Where particles spawn on the screen</small>
                    </div>

                    <div style="margin-top: 15px; padding: 10px; background: rgba(155, 89, 182, 0.15); border-radius: 6px; border-left: 3px solid #9b59b6;">
                        <p style="font-size: 10px; color: #aaa; margin: 0 0 6px 0;"><strong style="color: #9b59b6;">Effect Ideas:</strong></p>
                        <ul style="font-size: 10px; color: #888; margin: 0; padding-left: 16px;">
                            <li><strong>Snow</strong> - white circles falling slowly with gravity</li>
                            <li><strong>Rain</strong> - small vertical streaks falling fast</li>
                            <li><strong>Fog/Mist</strong> - large semi-transparent circles drifting slowly</li>
                            <li><strong>Embers</strong> - orange/red particles floating upward</li>
                            <li><strong>Leaves</strong> - colored particles drifting sideways</li>
                        </ul>
                    </div>
                </div><!-- End Particles Section -->

                <!-- Menu Elements Section (Menu levels only) -->
                <div class="level-settings-section menu-level-only" id="level-settings-section-menu-elements" style="display: none;">
                    <h3 style="color: #e94560; font-size: 14px; margin: 0 0 12px 0;">Menu Elements</h3>
                    <p style="font-size: 11px; color: #888; margin-bottom: 12px;">Add buttons and customize your menu screen</p>

                    <!-- Press Any Key Option -->
                    <div class="form-group" style="margin-bottom: 15px; padding: 12px; background: rgba(233, 69, 96, 0.1); border-radius: 6px; border-left: 3px solid #e94560;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="menu-press-any-key" onchange="togglePressAnyKeyText()">
                            <span style="margin-left: 8px;">Enable "Press Any Key" to Start</span>
                        </label>
                        <div id="press-any-key-text-container" style="display: none; margin-top: 10px;">
                            <input type="text" id="menu-press-any-key-text" placeholder="Press any key to start" maxlength="50" style="width: 100%;">
                            <small style="color: #666; font-size: 9px;">Custom text shown on screen (leave blank for default)</small>
                        </div>
                        <div id="press-any-key-warning" style="display: none; margin-top: 8px; padding: 8px; background: rgba(255, 193, 7, 0.15); border-radius: 4px; border-left: 3px solid #ffc107;">
                            <small style="color: #ffc107; font-size: 10px;">‚ö†Ô∏è <strong>Note:</strong> Buttons will be hidden until any key/touch is pressed. Players see this text first, then buttons appear.</small>
                        </div>
                    </div>

                    <!-- Menu Buttons List -->
                    <div style="margin-top: 15px;">
                        <label style="font-size: 12px; color: #888; margin-bottom: 8px; display: block;">Menu Buttons</label>
                        <div id="menu-buttons-list" style="max-height: 150px; overflow-y: auto; margin-bottom: 10px;"></div>
                        <button class="btn btn-full" onclick="addMenuButton()" style="background: #e94560;">+ Add Button</button>
                    </div>

                    <!-- Button Editor (shown when a button is selected) -->
                    <div id="menu-button-editor" style="display: none; margin-top: 15px; padding: 12px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                        <h4 style="color: #e94560; font-size: 12px; margin: 0 0 12px 0;">Edit Button</h4>

                        <div class="form-group">
                            <label>Button Text</label>
                            <input type="text" id="menu-button-text" placeholder="START GAME" maxlength="30" onchange="updateSelectedMenuButton()">
                        </div>

                        <div class="form-group" style="margin-top: 10px;">
                            <label>Action</label>
                            <select id="menu-button-action" onchange="updateMenuButtonActionTarget()">
                                <option value="start_game">Start Game (First Gameplay Level)</option>
                                <option value="go_to_level">Go to Specific Level</option>
                                <option value="toggle_sound">Toggle Sound On/Off</option>
                                <option value="open_url">Open URL (External Link)</option>
                            </select>
                        </div>

                        <div class="form-group" id="menu-button-level-container" style="display: none; margin-top: 10px;">
                            <label>Target Level</label>
                            <select id="menu-button-level" onchange="updateSelectedMenuButton()">
                                <!-- Populated dynamically with gameplay levels -->
                            </select>
                            <small style="color: #666; font-size: 9px;">Select which level this button leads to</small>
                        </div>

                        <div class="form-group" id="menu-button-url-container" style="display: none; margin-top: 10px;">
                            <label>URL to Open</label>
                            <input type="text" id="menu-button-url" placeholder="https://example.com" onchange="updateSelectedMenuButton()">
                        </div>

                        <!-- Position Controls -->
                        <div class="form-row" style="margin-top: 10px;">
                            <div class="form-group">
                                <label>X Position (%)</label>
                                <input type="number" id="menu-button-x" value="50" min="0" max="100" onchange="updateSelectedMenuButton()">
                            </div>
                            <div class="form-group">
                                <label>Y Position (%)</label>
                                <input type="number" id="menu-button-y" value="50" min="0" max="100" onchange="updateSelectedMenuButton()">
                            </div>
                        </div>
                        <small style="color: #666; font-size: 9px;">Position as percentage of screen (50% = centered)</small>

                        <div class="form-row" style="margin-top: 10px;">
                            <div class="form-group">
                                <label>Width (%)</label>
                                <input type="number" id="menu-button-width" value="30" min="10" max="80" onchange="updateSelectedMenuButton()">
                            </div>
                            <div class="form-group">
                                <label>Height (px)</label>
                                <input type="number" id="menu-button-height" value="50" min="30" max="100" onchange="updateSelectedMenuButton()">
                            </div>
                        </div>

                        <!-- Style Controls -->
                        <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1);">
                            <label style="font-size: 11px; color: #888; margin-bottom: 8px; display: block;">Button Style</label>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Background</label>
                                    <input type="color" id="menu-button-bg-color" value="#e94560" onchange="updateSelectedMenuButton()">
                                </div>
                                <div class="form-group">
                                    <label>Text Color</label>
                                    <input type="color" id="menu-button-text-color" value="#ffffff" onchange="updateSelectedMenuButton()">
                                </div>
                                <div class="form-group">
                                    <label>Border</label>
                                    <input type="color" id="menu-button-border-color" value="#ffffff" onchange="updateSelectedMenuButton()">
                                </div>
                            </div>
                            <div class="form-row" style="margin-top: 8px;">
                                <div class="form-group">
                                    <label>Corner Radius</label>
                                    <input type="number" id="menu-button-radius" value="10" min="0" max="25" onchange="updateSelectedMenuButton()">
                                </div>
                                <div class="form-group">
                                    <label>Font Size</label>
                                    <input type="number" id="menu-button-font-size" value="20" min="12" max="36" onchange="updateSelectedMenuButton()">
                                </div>
                            </div>
                        </div>

                        <button class="btn" onclick="deleteSelectedMenuButton()" style="margin-top: 12px; background: #c0392b; width: 100%;">Delete Button</button>
                    </div>

                    <div style="margin-top: 15px; padding: 10px; background: rgba(233, 69, 96, 0.15); border-radius: 6px; border-left: 3px solid #e94560;">
                        <p style="font-size: 10px; color: #aaa; margin: 0;"><strong style="color: #e94560;">Tip:</strong> Add a background image in the Backgrounds tab to create an attractive title screen!</p>
                    </div>
                </div><!-- End Menu Elements Section -->

            </div><!-- End level-settings-content -->
        </div><!-- End level-settings-container -->

        <div class="modal-buttons" style="flex-shrink: 0; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px; margin-top: 0;">
            <button class="btn btn-primary" onclick="saveLevelSettings()">Save</button>
            <button class="btn" onclick="closeLevelSettingsModal()">Cancel</button>
        </div>
    </div>
</div>

<!-- SoundEffectStudio Modal (z-index 2200 to appear above template editors which are 2100) -->
<div class="modal-overlay" id="sfx-studio-modal" style="display: none; z-index: 2200;">
    <div class="modal" style="width: 95vw; max-width: 1200px; height: 85vh; display: flex; flex-direction: column; padding: 0;">
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);">
            <h2 style="margin: 0; font-size: 18px; color: #fff;">üéµ Sound Effect Studio</h2>
            <div style="display: flex; gap: 10px;">
                <button class="btn" onclick="saveSfxAndClose()" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); padding: 8px 20px;">
                    üíæ Save & Use Sound
                </button>
                <button class="btn" onclick="closeSfxStudioModal()" style="background: rgba(255,255,255,0.1); padding: 8px 16px;">
                    ‚úï Cancel
                </button>
            </div>
        </div>
        <div style="flex: 1; overflow: hidden;">
            <iframe id="sfx-studio-iframe" style="width: 100%; height: 100%; border: none;"></iframe>
        </div>
    </div>
</div>

<!-- ParticleFX Modal (z-index 2200 to appear above template editors which are 2100) -->
<div class="modal-overlay" id="pfx-studio-modal" style="display: none; z-index: 2200;">
    <div class="modal" style="width: 95vw; max-width: 1200px; height: 85vh; display: flex; flex-direction: column; padding: 0;">
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);">
            <h2 style="margin: 0; font-size: 18px; color: #fff;">‚ú® Particle FX Designer</h2>
            <div style="display: flex; gap: 10px;">
                <button class="btn" onclick="savePfxAndClose()" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); padding: 8px 20px;">
                    üíæ Save & Use Effect
                </button>
                <button class="btn" onclick="closePfxStudioModal()" style="background: rgba(255,255,255,0.1); padding: 8px 16px;">
                    ‚úï Cancel
                </button>
            </div>
        </div>
        <div style="flex: 1; overflow: hidden;">
            <iframe id="pfx-studio-iframe" style="width: 100%; height: 100%; border: none;"></iframe>
        </div>
    </div>
</div>

<!-- App-level stubs (init.js/saveLoad.js expect these to exist) -->
<script>
let projectId = null;
let projectName = null;
const loginId = null;
const INITIAL_DATA = null;

const URL_TILESET = null;
const URL_TILESIZE = null;
const URL_WIDTH = null;
const URL_HEIGHT = null;
const URL_BACKGROUNDS = [];
</script>

<!-- JavaScript Modules -->
<script src="js/state.js"></script>
<script src="js/ui.js"></script>
<script src="js/levelManager.js"></script>
<script src="js/objectTemplates.js"></script>
<script src="js/help.js"></script>
<script src="js/zoom.js"></script>
<script src="js/backgrounds.js"></script>
<script src="js/gameSettings.js"></script>
<script src="js/cursorInspector.js"></script>
<script src="js/tileset.js"></script>
<script src="js/pixelEditor.js"></script>
<script src="js/levelEditor.js"></script>
<script src="js/renderer.js"></script>
<script src="js/events.js"></script>
<script src="js/scrollbars.js"></script>
<script src="js/saveLoad.js"></script>
<script src="js/screenshot.js"></script>
<script src="js/liveDataPreview.js"></script>
<script src="js/export.js"></script>
<script src="js/learnMode.js"></script>
<script src="js/playTest.js"></script>
<script src="js/gameGenerator.js"></script>
<script src="js/panelResize.js"></script>
<script src="js/codeSnippets.js"></script>
<script src="js/codePreview.js"></script>
<script src="js/init.js"></script>
<script src="js/dropdown.js"></script>
<script src="js/viewSync.js"></script>
<script src="js/tilesPanelResize.js"></script>
<script src="js/assetPicker.js"></script>
</body>
</html>
